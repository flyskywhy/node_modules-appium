'use strict';

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumIosDriver = require('appium-ios-driver');

var _asyncbox = require('asyncbox');

var _appiumSupport = require('appium-support');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var EXTRA_WEB_COORD_SCROLL_OFFSET = -10;
var IPHONE_WEB_COORD_OFFSET = -10;
var IPHONE_WEB_COORD_SMART_APP_BANNER_OFFSET = 84;
var IPAD_WEB_COORD_OFFSET = 10;
var IPAD_WEB_COORD_SMART_APP_BANNER_OFFSET = 95;

var extensions = {};

_Object$assign(extensions, _appiumIosDriver.iosCommands.web);

var getSafariIsIphone = _lodash2['default'].memoize(function callee$0$0(sessionId, driver) {
  var isIphone, useragent;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        isIphone = true;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(driver.execute('return navigator.userAgent'));

      case 4:
        useragent = context$1$0.sent;

        isIphone = useragent.toLowerCase().includes('iphone');
        context$1$0.next = 12;
        break;

      case 8:
        context$1$0.prev = 8;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].warn('Unable to find device type from useragent. Assuming iPhone');
        _logger2['default'].debug('Error: ' + context$1$0.t0.message);

      case 12:
        return context$1$0.abrupt('return', isIphone);

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 8]]);
});

extensions.getElementHeightMemoized = _lodash2['default'].memoize(function callee$0$0(key, el) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        el = _appiumSupport.util.unwrapElement(el);
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.getNativeRect(el));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent.height);

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
});

extensions.getExtraTranslateWebCoordsOffset = function callee$0$0() {
  var offset, implicitWaitMs, el;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        offset = 0;
        implicitWaitMs = this.implicitWaitMs;
        context$1$0.prev = 2;

        this.setImplicitWait(0);

        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.findNativeElementOrElements('accessibility id', 'ReloadButton', false));

      case 6:
        context$1$0.next = 22;
        break;

      case 8:
        context$1$0.prev = 8;
        context$1$0.t0 = context$1$0['catch'](2);
        context$1$0.prev = 10;
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(this.findNativeElementOrElements('accessibility id', 'URL', false));

      case 13:
        el = context$1$0.sent;
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.getElementHeightMemoized('URLBar', el));

      case 16:
        offset -= context$1$0.sent;
        context$1$0.next = 21;
        break;

      case 19:
        context$1$0.prev = 19;
        context$1$0.t1 = context$1$0['catch'](10);

      case 21:
        // no URL elements found, so continue

        // when scrolling has happened, there is a tick more offset needed
        offset += EXTRA_WEB_COORD_SCROLL_OFFSET;

      case 22:
        context$1$0.prev = 22;

        // return implicit wait to what it was
        this.setImplicitWait(implicitWaitMs);
        return context$1$0.finish(22);

      case 25:
        context$1$0.next = 27;
        return _regeneratorRuntime.awrap(getSafariIsIphone(this.opts.sessionId, this));

      case 27:
        if (!context$1$0.sent) {
          context$1$0.next = 31;
          break;
        }

        context$1$0.t2 = IPHONE_WEB_COORD_OFFSET;
        context$1$0.next = 32;
        break;

      case 31:
        context$1$0.t2 = IPAD_WEB_COORD_OFFSET;

      case 32:
        offset += context$1$0.t2;

        _logger2['default'].debug('Extra translated web coordinates offset: ' + offset);
        return context$1$0.abrupt('return', offset);

      case 35:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[2, 8, 22, 25], [10, 19]]);
};

extensions.getExtraNativeWebTapOffset = function callee$0$0() {
  var offset, implicitWaitMs, el;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        offset = 0;
        implicitWaitMs = this.implicitWaitMs;
        context$1$0.prev = 2;

        this.setImplicitWait(0);

        // first try to get tab offset
        context$1$0.prev = 4;
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.findNativeElementOrElements('-ios predicate string', 'name LIKE \'*, Tab\' AND visible = 1', false));

      case 7:
        el = context$1$0.sent;
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this.getElementHeightMemoized('TabBar', el));

      case 10:
        offset += context$1$0.sent;
        context$1$0.next = 15;
        break;

      case 13:
        context$1$0.prev = 13;
        context$1$0.t0 = context$1$0['catch'](4);

      case 15:
        context$1$0.prev = 15;
        context$1$0.next = 18;
        return _regeneratorRuntime.awrap(this.findNativeElementOrElements('accessibility id', 'Close app download offer', false));

      case 18:
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(getSafariIsIphone(this));

      case 20:
        if (!context$1$0.sent) {
          context$1$0.next = 24;
          break;
        }

        context$1$0.t1 = IPHONE_WEB_COORD_SMART_APP_BANNER_OFFSET;
        context$1$0.next = 25;
        break;

      case 24:
        context$1$0.t1 = IPAD_WEB_COORD_SMART_APP_BANNER_OFFSET;

      case 25:
        offset += context$1$0.t1;
        context$1$0.next = 30;
        break;

      case 28:
        context$1$0.prev = 28;
        context$1$0.t2 = context$1$0['catch'](15);

      case 30:
        context$1$0.prev = 30;

        // return implicit wait to what it was
        this.setImplicitWait(implicitWaitMs);
        return context$1$0.finish(30);

      case 33:

        _logger2['default'].debug('Additional native web tap offset computed: ' + offset);
        return context$1$0.abrupt('return', offset);

      case 35:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[2,, 30, 33], [4, 13], [15, 28]]);
};

extensions.nativeWebTap = function callee$0$0(el) {
  var atomsElement, _ref, x, y, _ref2, width, height;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        atomsElement = this.useAtomsElement(el);
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.executeAtom('get_top_left_coordinates', [atomsElement]));

      case 3:
        _ref = context$1$0.sent;
        x = _ref.x;
        y = _ref.y;
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.executeAtom('get_size', [atomsElement]));

      case 8:
        _ref2 = context$1$0.sent;
        width = _ref2.width;
        height = _ref2.height;

        x = x + width / 2;
        y = y + height / 2;

        this.curWebCoords = { x: x, y: y };
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.clickWebCoords());

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.clickCoords = function callee$0$0(coords) {
  var x, y;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        x = coords.x;
        y = coords.y;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.proxyCommand('/wda/tap/nil', 'POST', { x: x, y: y }));

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.translateWebCoords = function callee$0$0(coords) {
  var yOffset, webview, rect, wvPos, realDims, cmd, wvDims, urlBarHeight, realDimensionHeight, xRatio, yRatio, newCoords;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Translating coordinates (' + JSON.stringify(coords) + ') to web coordinates');

        // add static offset for safari in landscape mode
        yOffset = this.opts.curOrientation === 'LANDSCAPE' ? this.landscapeWebCoordsOffset : 0;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.getExtraNativeWebTapOffset());

      case 4:
        yOffset += context$1$0.sent;
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.getExtraTranslateWebCoordsOffset());

      case 7:
        coords.y += context$1$0.sent;
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(5, 100, function callee$1$0() {
          var implicitWaitMs;
          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                implicitWaitMs = this.implicitWaitMs;
                context$2$0.prev = 1;

                this.setImplicitWait(0);
                context$2$0.next = 5;
                return _regeneratorRuntime.awrap(this.findNativeElementOrElements('-ios predicate string', 'type = \'XCUIElementTypeWebView\' AND visible = 1', false));

              case 5:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 6:
                context$2$0.prev = 6;

                this.setImplicitWait(implicitWaitMs);
                return context$2$0.finish(6);

              case 9:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this, [[1,, 6, 9]]);
        }));

      case 10:
        webview = context$1$0.sent;

        webview = _appiumSupport.util.unwrapElement(webview);
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(this.proxyCommand('/element/' + webview + '/rect', 'GET'));

      case 14:
        rect = context$1$0.sent;
        wvPos = { x: rect.x, y: rect.y };
        realDims = { w: rect.width, h: rect.height };
        cmd = '(function () { return {w: document.documentElement.clientWidth, h: document.documentElement.clientHeight}; })()';
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(this.remote.execute(cmd));

      case 20:
        wvDims = context$1$0.sent;
        urlBarHeight = 64;

        wvPos.y += urlBarHeight;

        realDimensionHeight = 108;

        realDims.h -= realDimensionHeight;

        if (!(wvDims && realDims && wvPos)) {
          context$1$0.next = 32;
          break;
        }

        xRatio = realDims.w / wvDims.w;
        yRatio = realDims.h / wvDims.h;
        newCoords = {
          x: wvPos.x + Math.round(xRatio * coords.x),
          y: wvPos.y + yOffset + Math.round(yRatio * coords.y)
        };

        // additional logging in the case where `y` is `null` for unknown reasons
        // see https://github.com/appium/appium/issues/9159
        if (newCoords.y === null) {
          _logger2['default'].debug('Converted coordinates broken: ' + newCoords);
          _logger2['default'].debug('    rect: ' + rect);
          _logger2['default'].debug('    wvPos: ' + wvPos);
          _logger2['default'].debug('    realDims: ' + realDims);
          _logger2['default'].debug('    wvDims: ' + wvDims);
          _logger2['default'].debug('    xRatio: ' + xRatio);
          _logger2['default'].debug('    yRatio: ' + yRatio);
          _logger2['default'].debug('    yOffset: ' + yOffset);
        }

        _logger2['default'].debug('Converted web coords ' + JSON.stringify(coords) + ' ' + ('into real coords ' + JSON.stringify(newCoords)));
        return context$1$0.abrupt('return', newCoords);

      case 32:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.checkForAlert = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        return context$1$0.abrupt('return', false);

      case 1:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.waitForAtom = function callee$0$0(promise) {
  var res, msg;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        res = null;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(promise);

      case 4:
        res = context$1$0.sent;
        context$1$0.next = 11;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);
        msg = _lodash2['default'].isString(context$1$0.t0.message) ? context$1$0.t0.message : JSON.stringify(context$1$0.t0.message);
        throw new Error('Error while executing atom: ' + msg);

      case 11:
        return context$1$0.abrupt('return', this.parseExecuteResponse(res));

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7]]);
};

exports['default'] = extensions;
module.exports = exports['default'];

// sessionId parameter is for memoizing per session

// keep track of implicit wait, and set locally to 0

// try to see if there has been scrolling

// reload button found, which means scrolling has not happened

// no reload button, which indicates scrolling has happened

// extra offset necessary (where do these come from? they just work)

// keep track of implicit wait, and set locally to 0

// no element found, so no tabs and no need to deal with offset

// next try to see if there is an Smart App Banner

// no smart app banner found, so continue

// tap on absolute coordinates

// add extra offset for possible extra things in the top of the page

// absolutize web coords

// TODO: investigate where these come from. They appear to be constants in my tests

// TODO: Add check for alert and accept/dismiss it as per autoAcceptAlert capability
//# sourceMappingURL=data:application/json;charset=utf8;base64,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Q0FBRyxDQUFDO0FBQ3hELDhCQUFJLEtBQUssZ0JBQWMsSUFBSSxDQUFHLENBQUM7QUFDL0IsOEJBQUksS0FBSyxpQkFBZSxLQUFLLENBQUcsQ0FBQztBQUNqQyw4QkFBSSxLQUFLLG9CQUFrQixRQUFRLENBQUcsQ0FBQztBQUN2Qyw4QkFBSSxLQUFLLGtCQUFnQixNQUFNLENBQUcsQ0FBQztBQUNuQyw4QkFBSSxLQUFLLGtCQUFnQixNQUFNLENBQUcsQ0FBQztBQUNuQyw4QkFBSSxLQUFLLGtCQUFnQixNQUFNLENBQUcsQ0FBQztBQUNuQyw4QkFBSSxLQUFLLG1CQUFpQixPQUFPLENBQUcsQ0FBQztTQUN0Qzs7QUFFRCw0QkFBSSxLQUFLLENBQUMsMEJBQXdCLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLGdDQUMxQixJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFFLENBQUMsQ0FBQzs0Q0FDcEQsU0FBUzs7Ozs7OztDQUVuQixDQUFDOztBQUVGLFVBQVUsQ0FBQyxhQUFhLEdBQUc7Ozs7NENBQ2xCLEtBQUs7Ozs7Ozs7Q0FDYixDQUFDOztBQUVGLFVBQVUsQ0FBQyxXQUFXLEdBQUcsb0JBQWdCLE9BQU87TUFFMUMsR0FBRyxFQUlELEdBQUc7Ozs7QUFKTCxXQUFHLEdBQUcsSUFBSTs7O3lDQUVBLE9BQU87OztBQUFuQixXQUFHOzs7Ozs7O0FBRUMsV0FBRyxHQUFHLG9CQUFFLFFBQVEsQ0FBQyxlQUFJLE9BQU8sQ0FBQyxHQUFHLGVBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsZUFBSSxPQUFPLENBQUM7Y0FDdkUsSUFBSSxLQUFLLGtDQUFnQyxHQUFHLENBQUc7Ozs0Q0FFaEQsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQzs7Ozs7OztDQUN0QyxDQUFDOztxQkFFYSxVQUFVIiwiZmlsZSI6ImxpYi9jb21tYW5kcy93ZWIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpb3NDb21tYW5kcyB9IGZyb20gJ2FwcGl1bS1pb3MtZHJpdmVyJztcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuXG5jb25zdCBFWFRSQV9XRUJfQ09PUkRfU0NST0xMX09GRlNFVCA9IC0xMDtcbmNvbnN0IElQSE9ORV9XRUJfQ09PUkRfT0ZGU0VUID0gLTEwO1xuY29uc3QgSVBIT05FX1dFQl9DT09SRF9TTUFSVF9BUFBfQkFOTkVSX09GRlNFVCA9IDg0O1xuY29uc3QgSVBBRF9XRUJfQ09PUkRfT0ZGU0VUID0gMTA7XG5jb25zdCBJUEFEX1dFQl9DT09SRF9TTUFSVF9BUFBfQkFOTkVSX09GRlNFVCA9IDk1O1xuXG5sZXQgZXh0ZW5zaW9ucyA9IHt9O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGlvc0NvbW1hbmRzLndlYik7XG5cbmNvbnN0IGdldFNhZmFyaUlzSXBob25lID0gXy5tZW1vaXplKGFzeW5jIGZ1bmN0aW9uIChzZXNzaW9uSWQsIGRyaXZlcikge1xuICAvLyBzZXNzaW9uSWQgcGFyYW1ldGVyIGlzIGZvciBtZW1vaXppbmcgcGVyIHNlc3Npb25cbiAgbGV0IGlzSXBob25lID0gdHJ1ZTtcbiAgdHJ5IHtcbiAgICBjb25zdCB1c2VyYWdlbnQgPSBhd2FpdCBkcml2ZXIuZXhlY3V0ZSgncmV0dXJuIG5hdmlnYXRvci51c2VyQWdlbnQnKTtcbiAgICBpc0lwaG9uZSA9IHVzZXJhZ2VudC50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdpcGhvbmUnKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYFVuYWJsZSB0byBmaW5kIGRldmljZSB0eXBlIGZyb20gdXNlcmFnZW50LiBBc3N1bWluZyBpUGhvbmVgKTtcbiAgICBsb2cuZGVidWcoYEVycm9yOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG4gIHJldHVybiBpc0lwaG9uZTtcbn0pO1xuXG5leHRlbnNpb25zLmdldEVsZW1lbnRIZWlnaHRNZW1vaXplZCA9IF8ubWVtb2l6ZShhc3luYyBmdW5jdGlvbiAoa2V5LCBlbCkge1xuICBlbCA9IHV0aWwudW53cmFwRWxlbWVudChlbCk7XG4gIHJldHVybiAoYXdhaXQgdGhpcy5nZXROYXRpdmVSZWN0KGVsKSkuaGVpZ2h0O1xufSk7XG5cbmV4dGVuc2lvbnMuZ2V0RXh0cmFUcmFuc2xhdGVXZWJDb29yZHNPZmZzZXQgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxldCBvZmZzZXQgPSAwO1xuXG4gIC8vIGtlZXAgdHJhY2sgb2YgaW1wbGljaXQgd2FpdCwgYW5kIHNldCBsb2NhbGx5IHRvIDBcbiAgY29uc3QgaW1wbGljaXRXYWl0TXMgPSB0aGlzLmltcGxpY2l0V2FpdE1zO1xuXG4gIC8vIHRyeSB0byBzZWUgaWYgdGhlcmUgaGFzIGJlZW4gc2Nyb2xsaW5nXG4gIHRyeSB7XG4gICAgdGhpcy5zZXRJbXBsaWNpdFdhaXQoMCk7XG5cbiAgICBhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnYWNjZXNzaWJpbGl0eSBpZCcsICdSZWxvYWRCdXR0b24nLCBmYWxzZSk7XG4gICAgLy8gcmVsb2FkIGJ1dHRvbiBmb3VuZCwgd2hpY2ggbWVhbnMgc2Nyb2xsaW5nIGhhcyBub3QgaGFwcGVuZWRcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gbm8gcmVsb2FkIGJ1dHRvbiwgd2hpY2ggaW5kaWNhdGVzIHNjcm9sbGluZyBoYXMgaGFwcGVuZWRcbiAgICB0cnkge1xuICAgICAgY29uc3QgZWwgPSBhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnYWNjZXNzaWJpbGl0eSBpZCcsICdVUkwnLCBmYWxzZSk7XG4gICAgICBvZmZzZXQgLT0gYXdhaXQgdGhpcy5nZXRFbGVtZW50SGVpZ2h0TWVtb2l6ZWQoJ1VSTEJhcicsIGVsKTtcbiAgICB9IGNhdGNoIChpZ24pIHtcbiAgICAgIC8vIG5vIFVSTCBlbGVtZW50cyBmb3VuZCwgc28gY29udGludWVcbiAgICB9XG5cbiAgICAvLyB3aGVuIHNjcm9sbGluZyBoYXMgaGFwcGVuZWQsIHRoZXJlIGlzIGEgdGljayBtb3JlIG9mZnNldCBuZWVkZWRcbiAgICBvZmZzZXQgKz0gRVhUUkFfV0VCX0NPT1JEX1NDUk9MTF9PRkZTRVQ7XG4gIH0gZmluYWxseSB7XG4gICAgLy8gcmV0dXJuIGltcGxpY2l0IHdhaXQgdG8gd2hhdCBpdCB3YXNcbiAgICB0aGlzLnNldEltcGxpY2l0V2FpdChpbXBsaWNpdFdhaXRNcyk7XG4gIH1cblxuICAvLyBleHRyYSBvZmZzZXQgbmVjZXNzYXJ5ICh3aGVyZSBkbyB0aGVzZSBjb21lIGZyb20/IHRoZXkganVzdCB3b3JrKVxuICBvZmZzZXQgKz0gYXdhaXQgZ2V0U2FmYXJpSXNJcGhvbmUodGhpcy5vcHRzLnNlc3Npb25JZCwgdGhpcykgP1xuICAgIElQSE9ORV9XRUJfQ09PUkRfT0ZGU0VUIDpcbiAgICBJUEFEX1dFQl9DT09SRF9PRkZTRVQ7XG5cbiAgbG9nLmRlYnVnKGBFeHRyYSB0cmFuc2xhdGVkIHdlYiBjb29yZGluYXRlcyBvZmZzZXQ6ICR7b2Zmc2V0fWApO1xuICByZXR1cm4gb2Zmc2V0O1xufTtcblxuZXh0ZW5zaW9ucy5nZXRFeHRyYU5hdGl2ZVdlYlRhcE9mZnNldCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbGV0IG9mZnNldCA9IDA7XG5cbiAgLy8ga2VlcCB0cmFjayBvZiBpbXBsaWNpdCB3YWl0LCBhbmQgc2V0IGxvY2FsbHkgdG8gMFxuICBjb25zdCBpbXBsaWNpdFdhaXRNcyA9IHRoaXMuaW1wbGljaXRXYWl0TXM7XG4gIHRyeSB7XG4gICAgdGhpcy5zZXRJbXBsaWNpdFdhaXQoMCk7XG5cbiAgICAvLyBmaXJzdCB0cnkgdG8gZ2V0IHRhYiBvZmZzZXRcbiAgICB0cnkge1xuICAgICAgY29uc3QgZWwgPSBhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnLWlvcyBwcmVkaWNhdGUgc3RyaW5nJywgYG5hbWUgTElLRSAnKiwgVGFiJyBBTkQgdmlzaWJsZSA9IDFgLCBmYWxzZSk7XG4gICAgICBvZmZzZXQgKz0gYXdhaXQgdGhpcy5nZXRFbGVtZW50SGVpZ2h0TWVtb2l6ZWQoJ1RhYkJhcicsIGVsKTtcbiAgICB9IGNhdGNoIChpZ24pIHtcbiAgICAgIC8vIG5vIGVsZW1lbnQgZm91bmQsIHNvIG5vIHRhYnMgYW5kIG5vIG5lZWQgdG8gZGVhbCB3aXRoIG9mZnNldFxuICAgIH1cblxuICAgIC8vIG5leHQgdHJ5IHRvIHNlZSBpZiB0aGVyZSBpcyBhbiBTbWFydCBBcHAgQmFubmVyXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCdhY2Nlc3NpYmlsaXR5IGlkJywgJ0Nsb3NlIGFwcCBkb3dubG9hZCBvZmZlcicsIGZhbHNlKTtcbiAgICAgIG9mZnNldCArPSBhd2FpdCBnZXRTYWZhcmlJc0lwaG9uZSh0aGlzKSA/XG4gICAgICAgIElQSE9ORV9XRUJfQ09PUkRfU01BUlRfQVBQX0JBTk5FUl9PRkZTRVQgOlxuICAgICAgICBJUEFEX1dFQl9DT09SRF9TTUFSVF9BUFBfQkFOTkVSX09GRlNFVDtcbiAgICB9IGNhdGNoIChpZ24pIHtcbiAgICAgIC8vIG5vIHNtYXJ0IGFwcCBiYW5uZXIgZm91bmQsIHNvIGNvbnRpbnVlXG4gICAgfVxuICB9IGZpbmFsbHkge1xuICAgIC8vIHJldHVybiBpbXBsaWNpdCB3YWl0IHRvIHdoYXQgaXQgd2FzXG4gICAgdGhpcy5zZXRJbXBsaWNpdFdhaXQoaW1wbGljaXRXYWl0TXMpO1xuICB9XG5cbiAgbG9nLmRlYnVnKGBBZGRpdGlvbmFsIG5hdGl2ZSB3ZWIgdGFwIG9mZnNldCBjb21wdXRlZDogJHtvZmZzZXR9YCk7XG4gIHJldHVybiBvZmZzZXQ7XG59O1xuXG5leHRlbnNpb25zLm5hdGl2ZVdlYlRhcCA9IGFzeW5jIGZ1bmN0aW9uIChlbCkge1xuICBsZXQgYXRvbXNFbGVtZW50ID0gdGhpcy51c2VBdG9tc0VsZW1lbnQoZWwpO1xuICBsZXQge3gsIHl9ID0gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3RvcF9sZWZ0X2Nvb3JkaW5hdGVzJywgW2F0b21zRWxlbWVudF0pO1xuICBsZXQge3dpZHRoLCBoZWlnaHR9ID0gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3NpemUnLCBbYXRvbXNFbGVtZW50XSk7XG4gIHggPSB4ICsgKHdpZHRoIC8gMik7XG4gIHkgPSB5ICsgKGhlaWdodCAvIDIpO1xuXG4gIHRoaXMuY3VyV2ViQ29vcmRzID0ge3gsIHl9O1xuICBhd2FpdCB0aGlzLmNsaWNrV2ViQ29vcmRzKCk7XG59O1xuXG5leHRlbnNpb25zLmNsaWNrQ29vcmRzID0gYXN5bmMgZnVuY3Rpb24gKGNvb3Jkcykge1xuICBsZXQge3gsIHl9ID0gY29vcmRzO1xuXG4gIC8vIHRhcCBvbiBhYnNvbHV0ZSBjb29yZGluYXRlc1xuICBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL3dkYS90YXAvbmlsJywgJ1BPU1QnLCB7eCwgeX0pO1xufTtcblxuZXh0ZW5zaW9ucy50cmFuc2xhdGVXZWJDb29yZHMgPSBhc3luYyBmdW5jdGlvbiAoY29vcmRzKSB7XG4gIGxvZy5kZWJ1ZyhgVHJhbnNsYXRpbmcgY29vcmRpbmF0ZXMgKCR7SlNPTi5zdHJpbmdpZnkoY29vcmRzKX0pIHRvIHdlYiBjb29yZGluYXRlc2ApO1xuXG4gIC8vIGFkZCBzdGF0aWMgb2Zmc2V0IGZvciBzYWZhcmkgaW4gbGFuZHNjYXBlIG1vZGVcbiAgbGV0IHlPZmZzZXQgPSB0aGlzLm9wdHMuY3VyT3JpZW50YXRpb24gPT09ICdMQU5EU0NBUEUnID8gdGhpcy5sYW5kc2NhcGVXZWJDb29yZHNPZmZzZXQgOiAwO1xuXG4gIC8vIGFkZCBleHRyYSBvZmZzZXQgZm9yIHBvc3NpYmxlIGV4dHJhIHRoaW5ncyBpbiB0aGUgdG9wIG9mIHRoZSBwYWdlXG4gIHlPZmZzZXQgKz0gYXdhaXQgdGhpcy5nZXRFeHRyYU5hdGl2ZVdlYlRhcE9mZnNldCgpO1xuICBjb29yZHMueSArPSBhd2FpdCB0aGlzLmdldEV4dHJhVHJhbnNsYXRlV2ViQ29vcmRzT2Zmc2V0KCk7XG5cbiAgLy8gYWJzb2x1dGl6ZSB3ZWIgY29vcmRzXG4gIGxldCB3ZWJ2aWV3ID0gYXdhaXQgcmV0cnlJbnRlcnZhbCg1LCAxMDAsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBpbXBsaWNpdFdhaXRNcyA9IHRoaXMuaW1wbGljaXRXYWl0TXM7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMuc2V0SW1wbGljaXRXYWl0KDApO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCctaW9zIHByZWRpY2F0ZSBzdHJpbmcnLCBgdHlwZSA9ICdYQ1VJRWxlbWVudFR5cGVXZWJWaWV3JyBBTkQgdmlzaWJsZSA9IDFgLCBmYWxzZSk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHRoaXMuc2V0SW1wbGljaXRXYWl0KGltcGxpY2l0V2FpdE1zKTtcbiAgICB9XG4gIH0pO1xuXG4gIHdlYnZpZXcgPSB1dGlsLnVud3JhcEVsZW1lbnQod2Vidmlldyk7XG4gIGxldCByZWN0ID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7d2Vidmlld30vcmVjdGAsICdHRVQnKTtcbiAgbGV0IHd2UG9zID0ge3g6IHJlY3QueCwgeTogcmVjdC55fTtcbiAgbGV0IHJlYWxEaW1zID0ge3c6IHJlY3Qud2lkdGgsIGg6IHJlY3QuaGVpZ2h0fTtcblxuICBsZXQgY21kID0gJyhmdW5jdGlvbiAoKSB7IHJldHVybiB7dzogZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoLCBoOiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0fTsgfSkoKSc7XG4gIGxldCB3dkRpbXMgPSBhd2FpdCB0aGlzLnJlbW90ZS5leGVjdXRlKGNtZCk7XG5cbiAgLy8gVE9ETzogaW52ZXN0aWdhdGUgd2hlcmUgdGhlc2UgY29tZSBmcm9tLiBUaGV5IGFwcGVhciB0byBiZSBjb25zdGFudHMgaW4gbXkgdGVzdHNcbiAgbGV0IHVybEJhckhlaWdodCA9IDY0O1xuICB3dlBvcy55ICs9IHVybEJhckhlaWdodDtcblxuICBsZXQgcmVhbERpbWVuc2lvbkhlaWdodCA9IDEwODtcbiAgcmVhbERpbXMuaCAtPSByZWFsRGltZW5zaW9uSGVpZ2h0O1xuXG4gIGlmICh3dkRpbXMgJiYgcmVhbERpbXMgJiYgd3ZQb3MpIHtcbiAgICBsZXQgeFJhdGlvID0gcmVhbERpbXMudyAvIHd2RGltcy53O1xuICAgIGxldCB5UmF0aW8gPSByZWFsRGltcy5oIC8gd3ZEaW1zLmg7XG4gICAgbGV0IG5ld0Nvb3JkcyA9IHtcbiAgICAgIHg6IHd2UG9zLnggKyBNYXRoLnJvdW5kKHhSYXRpbyAqIGNvb3Jkcy54KSxcbiAgICAgIHk6IHd2UG9zLnkgKyB5T2Zmc2V0ICsgTWF0aC5yb3VuZCh5UmF0aW8gKiBjb29yZHMueSksXG4gICAgfTtcblxuICAgIC8vIGFkZGl0aW9uYWwgbG9nZ2luZyBpbiB0aGUgY2FzZSB3aGVyZSBgeWAgaXMgYG51bGxgIGZvciB1bmtub3duIHJlYXNvbnNcbiAgICAvLyBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0vaXNzdWVzLzkxNTlcbiAgICBpZiAobmV3Q29vcmRzLnkgPT09IG51bGwpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgQ29udmVydGVkIGNvb3JkaW5hdGVzIGJyb2tlbjogJHtuZXdDb29yZHN9YCk7XG4gICAgICBsb2cuZGVidWcoYCAgICByZWN0OiAke3JlY3R9YCk7XG4gICAgICBsb2cuZGVidWcoYCAgICB3dlBvczogJHt3dlBvc31gKTtcbiAgICAgIGxvZy5kZWJ1ZyhgICAgIHJlYWxEaW1zOiAke3JlYWxEaW1zfWApO1xuICAgICAgbG9nLmRlYnVnKGAgICAgd3ZEaW1zOiAke3d2RGltc31gKTtcbiAgICAgIGxvZy5kZWJ1ZyhgICAgIHhSYXRpbzogJHt4UmF0aW99YCk7XG4gICAgICBsb2cuZGVidWcoYCAgICB5UmF0aW86ICR7eVJhdGlvfWApO1xuICAgICAgbG9nLmRlYnVnKGAgICAgeU9mZnNldDogJHt5T2Zmc2V0fWApO1xuICAgIH1cblxuICAgIGxvZy5kZWJ1ZyhgQ29udmVydGVkIHdlYiBjb29yZHMgJHtKU09OLnN0cmluZ2lmeShjb29yZHMpfSBgICtcbiAgICAgICAgICAgICAgYGludG8gcmVhbCBjb29yZHMgJHtKU09OLnN0cmluZ2lmeShuZXdDb29yZHMpfWApO1xuICAgIHJldHVybiBuZXdDb29yZHM7XG4gIH1cbn07XG5cbmV4dGVuc2lvbnMuY2hlY2tGb3JBbGVydCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgcmV0dXJuIGZhbHNlO1xufTtcblxuZXh0ZW5zaW9ucy53YWl0Rm9yQXRvbSA9IGFzeW5jIGZ1bmN0aW9uIChwcm9taXNlKSB7XG4gIC8vIFRPRE86IEFkZCBjaGVjayBmb3IgYWxlcnQgYW5kIGFjY2VwdC9kaXNtaXNzIGl0IGFzIHBlciBhdXRvQWNjZXB0QWxlcnQgY2FwYWJpbGl0eVxuICBsZXQgcmVzID0gbnVsbDtcbiAgdHJ5IHtcbiAgICByZXMgPSBhd2FpdCBwcm9taXNlO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsZXQgbXNnID0gXy5pc1N0cmluZyhlcnIubWVzc2FnZSkgPyBlcnIubWVzc2FnZSA6IEpTT04uc3RyaW5naWZ5KGVyci5tZXNzYWdlKTtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEVycm9yIHdoaWxlIGV4ZWN1dGluZyBhdG9tOiAke21zZ31gKTtcbiAgfVxuICByZXR1cm4gdGhpcy5wYXJzZUV4ZWN1dGVSZXNwb25zZShyZXMpO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
