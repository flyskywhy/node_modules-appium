'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumSupport = require('appium-support');

var _teen_process = require('teen_process');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _asyncLock = require('async-lock');

var _asyncLock2 = _interopRequireDefault(_asyncLock);

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var WDA_RUNNER_BUNDLE_ID = 'com.facebook.WebDriverAgentRunner';
var PROJECT_FILE = 'project.pbxproj';
var XCUICOORDINATE_FILE = 'PrivateHeaders/XCTest/XCUICoordinate.h';
var FBMACROS_FILE = 'WebDriverAgentLib/Utilities/FBMacros.h';
var XCUIAPPLICATION_FILE = 'PrivateHeaders/XCTest/XCUIApplication.h';

function replaceInFile(file, find, replace) {
  var contents, newContents;
  return _regeneratorRuntime.async(function replaceInFile$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(file, 'utf-8'));

      case 2:
        contents = context$1$0.sent;
        newContents = contents.replace(find, replace);

        if (!(newContents !== contents)) {
          context$1$0.next = 7;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(file, newContents, 'utf-8'));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function updateProjectFile(agentPath, newBundleId) {
  var projectFilePath;
  return _regeneratorRuntime.async(function updateProjectFile$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        projectFilePath = agentPath + '/' + PROJECT_FILE;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(projectFilePath, projectFilePath + '.old'));

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(replaceInFile(projectFilePath, new RegExp(WDA_RUNNER_BUNDLE_ID.replace('.', '\.'), 'g'), newBundleId));

      case 6:
        _logger2['default'].debug('Successfully updated \'' + projectFilePath + '\' with bundle id \'' + newBundleId + '\'');
        context$1$0.next = 13;
        break;

      case 9:
        context$1$0.prev = 9;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].debug('Error updating project file: ' + context$1$0.t0.message);
        _logger2['default'].warn('Unable to update project file \'' + projectFilePath + '\' with ' + ('bundle id \'' + newBundleId + '\'. WebDriverAgent may not start'));

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 9]]);
}

function resetProjectFile(agentPath, newBundleId) {
  var projectFilePath;
  return _regeneratorRuntime.async(function resetProjectFile$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        projectFilePath = agentPath + '/' + PROJECT_FILE;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(replaceInFile(projectFilePath, new RegExp(newBundleId.replace('.', '\.'), 'g'), WDA_RUNNER_BUNDLE_ID));

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.unlink(projectFilePath + '.old'));

      case 6:
        _logger2['default'].debug('Successfully reset \'' + projectFilePath + '\' with bundle id \'' + WDA_RUNNER_BUNDLE_ID + '\'');
        context$1$0.next = 13;
        break;

      case 9:
        context$1$0.prev = 9;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].debug('Error resetting project file: ' + context$1$0.t0.message);
        _logger2['default'].warn('Unable to reset project file \'' + projectFilePath + '\' with ' + ('bundle id \'' + WDA_RUNNER_BUNDLE_ID + '\'. WebDriverAgent has been ') + 'modified and not returned to the original state.');

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 9]]);
}

var dependenciesUpdateLock = new _asyncLock2['default']();

function checkForDependencies(bootstrapPath) {
  var useSsl = arguments.length <= 1 || arguments[1] === undefined ? false : arguments[1];
  var carthagePath, carthageRoot;
  return _regeneratorRuntime.async(function checkForDependencies$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.which('carthage'));

      case 3:
        carthagePath = context$1$0.sent;

        _logger2['default'].debug('Carthage found: \'' + carthagePath + '\'');
        context$1$0.next = 10;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](0);

        _logger2['default'].errorAndThrow('Carthage not found. Install using `brew install carthage`');

      case 10:
        carthageRoot = bootstrapPath + '/Carthage';
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(dependenciesUpdateLock.acquire(carthageRoot, function callee$1$0() {
          var args, _arr, _i, std, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, line;

          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(carthageRoot));

              case 2:
                if (context$2$0.sent) {
                  context$2$0.next = 49;
                  break;
                }

                _logger2['default'].debug('Running WebDriverAgent bootstrap script to install dependencies');
                context$2$0.prev = 4;
                args = useSsl ? ['-d', '-D'] : ['-d'];
                context$2$0.next = 8;
                return _regeneratorRuntime.awrap((0, _teen_process.exec)('Scripts/bootstrap.sh', args, { cwd: bootstrapPath }));

              case 8:
                context$2$0.next = 49;
                break;

              case 10:
                context$2$0.prev = 10;
                context$2$0.t0 = context$2$0['catch'](4);
                _arr = ['stdout', 'stderr'];
                _i = 0;

              case 14:
                if (!(_i < _arr.length)) {
                  context$2$0.next = 46;
                  break;
                }

                std = _arr[_i];
                _iteratorNormalCompletion = true;
                _didIteratorError = false;
                _iteratorError = undefined;
                context$2$0.prev = 19;
                _iterator = _getIterator((context$2$0.t0[std] || '').split('\n'));

              case 21:
                if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
                  context$2$0.next = 29;
                  break;
                }

                line = _step.value;

                if (line.length) {
                  context$2$0.next = 25;
                  break;
                }

                return context$2$0.abrupt('continue', 26);

              case 25:
                _logger2['default'].error(line);

              case 26:
                _iteratorNormalCompletion = true;
                context$2$0.next = 21;
                break;

              case 29:
                context$2$0.next = 35;
                break;

              case 31:
                context$2$0.prev = 31;
                context$2$0.t1 = context$2$0['catch'](19);
                _didIteratorError = true;
                _iteratorError = context$2$0.t1;

              case 35:
                context$2$0.prev = 35;
                context$2$0.prev = 36;

                if (!_iteratorNormalCompletion && _iterator['return']) {
                  _iterator['return']();
                }

              case 38:
                context$2$0.prev = 38;

                if (!_didIteratorError) {
                  context$2$0.next = 41;
                  break;
                }

                throw _iteratorError;

              case 41:
                return context$2$0.finish(38);

              case 42:
                return context$2$0.finish(35);

              case 43:
                _i++;
                context$2$0.next = 14;
                break;

              case 46:
                context$2$0.next = 48;
                return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(carthageRoot));

              case 48:
                throw context$2$0.t0;

              case 49:
                context$2$0.next = 51;
                return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(bootstrapPath + '/Resources'));

              case 51:
                if (context$2$0.sent) {
                  context$2$0.next = 55;
                  break;
                }

                _logger2['default'].debug('Creating WebDriverAgent resources directory');
                context$2$0.next = 55;
                return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(bootstrapPath + '/Resources'));

              case 55:
                context$2$0.next = 57;
                return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(bootstrapPath + '/Resources/WebDriverAgent.bundle'));

              case 57:
                if (context$2$0.sent) {
                  context$2$0.next = 61;
                  break;
                }

                _logger2['default'].debug('Creating WebDriverAgent resource bundle directory');
                context$2$0.next = 61;
                return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(bootstrapPath + '/Resources/WebDriverAgent.bundle'));

              case 61:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this, [[4, 10], [19, 31, 35, 43], [36,, 38, 42]]);
        }));

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 7]]);
}

function setRealDeviceSecurity(keychainPath, keychainPassword) {
  return _regeneratorRuntime.async(function setRealDeviceSecurity$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Setting security for iOS device');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('security', ['-v', 'list-keychains', '-s', keychainPath]));

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('security', ['-v', 'unlock-keychain', '-p', keychainPassword, keychainPath]));

      case 5:
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('security', ['set-keychain-settings', '-t', '3600', '-l', keychainPath]));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function fixXCUICoordinateFile(bootstrapPath) {
  var initial = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

  var file, oldDef, newDef, _ref;

  return _regeneratorRuntime.async(function fixXCUICoordinateFile$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        file = _path2['default'].resolve(bootstrapPath, XCUICOORDINATE_FILE);
        oldDef = '- (void)pressForDuration:(double)arg1 thenDragToCoordinate:(id)arg2;';
        newDef = '- (void)pressForDuration:(NSTimeInterval)duration thenDragToCoordinate:(XCUICoordinate *)otherCoordinate;';

        if (!initial) {
          _ref = [newDef, oldDef];
          oldDef = _ref[0];
          newDef = _ref[1];
        }
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(replaceInFile(file, oldDef, newDef));

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function fixForXcode7(bootstrapPath) {
  var initial = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];
  return _regeneratorRuntime.async(function fixForXcode7$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(fixXCUICoordinateFile(bootstrapPath, initial));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function fixFBMacrosFile(bootstrapPath) {
  var initial = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

  var file, oldDef, newDef, _ref2;

  return _regeneratorRuntime.async(function fixFBMacrosFile$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        file = _path2['default'].resolve(bootstrapPath, FBMACROS_FILE);
        oldDef = '#define FBStringify(class, property) ({if(NO){[class.new property];} @#property;})';
        newDef = '#define FBStringify(class, property) ({@#property;})';

        if (!initial) {
          _ref2 = [newDef, oldDef];
          oldDef = _ref2[0];
          newDef = _ref2[1];
        }
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(replaceInFile(file, oldDef, newDef));

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function fixXCUIApplicationFile(bootstrapPath) {
  var initial = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

  var file, oldDef, newDef, _ref3;

  return _regeneratorRuntime.async(function fixXCUIApplicationFile$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        file = _path2['default'].resolve(bootstrapPath, XCUIAPPLICATION_FILE);
        oldDef = '@property(nonatomic, readonly) NSUInteger state; // @synthesize state=_state;';
        newDef = '@property XCUIApplicationState state;';

        if (!initial) {
          _ref3 = [newDef, oldDef];
          oldDef = _ref3[0];
          newDef = _ref3[1];
        }
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(replaceInFile(file, oldDef, newDef));

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function fixForXcode9(bootstrapPath) {
  var initial = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];
  return _regeneratorRuntime.async(function fixForXcode9$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(fixFBMacrosFile(bootstrapPath, initial));

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(fixXCUIApplicationFile(bootstrapPath, initial));

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function generateXcodeConfigFile(orgId, signingId) {
  var contents, xcconfigPath;
  return _regeneratorRuntime.async(function generateXcodeConfigFile$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Generating xcode config file for orgId \'' + orgId + '\' and signingId ' + ('\'' + signingId + '\''));
        contents = 'DEVELOPMENT_TEAM = ' + orgId + '\nCODE_SIGN_IDENTITY = ' + signingId + '\n';
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumSupport.tempDir.path('appium-temp.xcconfig'));

      case 4:
        xcconfigPath = context$1$0.sent;

        _logger2['default'].debug('Writing xcode config file to ' + xcconfigPath);
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(xcconfigPath, contents, "utf8"));

      case 8:
        return context$1$0.abrupt('return', xcconfigPath);

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

/**
 * Creates xctestrun file per device & platform version.
 * We expects to have WebDriverAgentRunner_iphoneos${platformVersion}-arm64.xctestrun for real device
 * and WebDriverAgentRunner_iphonesimulator${platformVersion}-x86_64.xctestrun for simulator located @bootstrapPath
 *
 * @param {boolean} isRealDevice - Equals to true if the current device is a real device
 * @param {string} udid - The device UDID.
 * @param {string} platformVersion - The platform version of OS.
 * @param {string} bootstrapPath - The folder path containing xctestrun file.
 * @param {string} wdaRemotePort - The remote port WDA is listening on.
 * @return {string} returns xctestrunFilePath for given device
 * @throws if WebDriverAgentRunner_iphoneos${platformVersion}-arm64.xctestrun for real device
 * or WebDriverAgentRunner_iphonesimulator${platformVersion}-x86_64.xctestrun for simulator is not found @bootstrapPath,
 * then it will throw file not found exception
 */
function setXctestrunFile(isRealDevice, udid, platformVersion, bootstrapPath, wdaRemotePort) {
  var xctestrunDeviceFileName, xctestrunFilePath, xctestBaseFileName, originalXctestrunFile, xctestRunContent, updateWDAPort, newXctestRunContent;
  return _regeneratorRuntime.async(function setXctestrunFile$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        xctestrunDeviceFileName = udid + '_' + platformVersion + '.xctestrun';
        xctestrunFilePath = _path2['default'].resolve(bootstrapPath, xctestrunDeviceFileName);
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(xctestrunFilePath));

      case 4:
        if (context$1$0.sent) {
          context$1$0.next = 13;
          break;
        }

        xctestBaseFileName = isRealDevice ? 'WebDriverAgentRunner_iphoneos' + platformVersion + '-arm64.xctestrun' : 'WebDriverAgentRunner_iphonesimulator' + platformVersion + '-x86_64.xctestrun';
        originalXctestrunFile = _path2['default'].resolve(bootstrapPath, xctestBaseFileName);
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(originalXctestrunFile));

      case 9:
        if (context$1$0.sent) {
          context$1$0.next = 11;
          break;
        }

        _logger2['default'].errorAndThrow('if you are using useXctestrunFile capability then you need to have ' + originalXctestrunFile + ' file');

      case 11:
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(originalXctestrunFile, xctestrunFilePath));

      case 13:
        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(_appiumSupport.plist.parsePlistFile(xctestrunFilePath));

      case 15:
        xctestRunContent = context$1$0.sent;
        updateWDAPort = {
          WebDriverAgentRunner: {
            EnvironmentVariables: {
              USE_PORT: wdaRemotePort
            }
          }
        };
        newXctestRunContent = _lodash2['default'].merge(xctestRunContent, updateWDAPort);
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(_appiumSupport.plist.updatePlistFile(xctestrunFilePath, newXctestRunContent, true));

      case 20:
        return context$1$0.abrupt('return', xctestrunFilePath);

      case 21:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function killProcess(name, proc) {
  return _regeneratorRuntime.async(function killProcess$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(proc && proc.proc)) {
          context$1$0.next = 22;
          break;
        }

        _logger2['default'].info('Shutting down ' + name + ' process (pid ' + proc.proc.pid + ')');
        context$1$0.prev = 2;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(proc.stop('SIGTERM', 1000));

      case 5:
        context$1$0.next = 22;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](2);

        if (!(context$1$0.t0.message.indexOf('Process didn\'t end after') === -1)) {
          context$1$0.next = 11;
          break;
        }

        throw context$1$0.t0;

      case 11:
        _logger2['default'].debug(name + ' process did not end in a timely fashion: \'' + context$1$0.t0.message + '\'. ' + 'Sending \'SIGKILL\'...');
        context$1$0.prev = 12;
        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(proc.stop('SIGKILL'));

      case 15:
        context$1$0.next = 22;
        break;

      case 17:
        context$1$0.prev = 17;
        context$1$0.t1 = context$1$0['catch'](12);

        if (!(context$1$0.t1.message.indexOf('not currently running') !== -1)) {
          context$1$0.next = 21;
          break;
        }

        return context$1$0.abrupt('return');

      case 21:
        throw context$1$0.t1;

      case 22:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[2, 7], [12, 17]]);
}

/**
 * Generate a random integer.
 *
 * @return {number} A random integer number in range [low, hight). `low`` is inclusive and `high` is exclusive.
 */
function randomInt(low, high) {
  return Math.floor(Math.random() * (high - low) + low);
}

exports.updateProjectFile = updateProjectFile;
exports.resetProjectFile = resetProjectFile;
exports.checkForDependencies = checkForDependencies;
exports.setRealDeviceSecurity = setRealDeviceSecurity;
exports.fixForXcode7 = fixForXcode7;
exports.fixForXcode9 = fixForXcode9;
exports.generateXcodeConfigFile = generateXcodeConfigFile;
exports.setXctestrunFile = setXctestrunFile;
exports.killProcess = killProcess;
exports.randomInt = randomInt;

// backup the file, and then update the bundle id for the runner

// print out the stdout and stderr reports

// remove the carthage directory, or else subsequent runs will see it and
// assume the dependencies are already downloaded

// the way the updated XCTest headers are in the WDA project, building in
// Xcode 8.0 causes a duplicate declaration of method
// so fix the offending line in the local headers

// If this is first time run for given device, then first generate xctestrun file for device.
// We need to have a xctestrun file per device because we cant not have same wda port for all devices.

// the process ended but for some reason we were not informed
//# sourceMappingURL=data:application/json;charset=utf8;base64,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SSxDQUFBOzs7OztBQUNuQiw0QkFBSSxJQUFJLG9CQUFrQixJQUFJLHNCQUFpQixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsT0FBSSxDQUFDOzs7eUNBRXpELElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQzs7Ozs7Ozs7OztjQUU1QixlQUFJLE9BQU8sQ0FBQyxPQUFPLDZCQUE0QixLQUFLLENBQUMsQ0FBQyxDQUFBOzs7Ozs7OztBQUcxRCw0QkFBSSxLQUFLLENBQUMsQUFBRyxJQUFJLG9EQUE4QyxlQUFJLE9BQU8sb0NBQzFDLENBQUMsQ0FBQzs7O3lDQUUxQixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQzs7Ozs7Ozs7OztjQUV0QixlQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsdUJBQXVCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTs7Ozs7Ozs7Ozs7Ozs7O0NBUTlEOzs7Ozs7O0FBT0QsU0FBUyxTQUFTLENBQUUsR0FBRyxFQUFFLElBQUksRUFBRTtBQUM3QixTQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLElBQUksR0FBRyxHQUFHLENBQUEsQUFBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDO0NBQ3ZEOztRQUVRLGlCQUFpQixHQUFqQixpQkFBaUI7UUFBRSxnQkFBZ0IsR0FBaEIsZ0JBQWdCO1FBQUUsb0JBQW9CLEdBQXBCLG9CQUFvQjtRQUN6RCxxQkFBcUIsR0FBckIscUJBQXFCO1FBQUUsWUFBWSxHQUFaLFlBQVk7UUFBRSxZQUFZLEdBQVosWUFBWTtRQUNqRCx1QkFBdUIsR0FBdkIsdUJBQXVCO1FBQUUsZ0JBQWdCLEdBQWhCLGdCQUFnQjtRQUFFLFdBQVcsR0FBWCxXQUFXO1FBQUUsU0FBUyxHQUFULFNBQVMiLCJmaWxlIjoibGliL3dkYS91dGlscy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZzLCB0ZW1wRGlyLCBwbGlzdCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgQXN5bmNMb2NrIGZyb20gJ2FzeW5jLWxvY2snO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuXG5jb25zdCBXREFfUlVOTkVSX0JVTkRMRV9JRCA9ICdjb20uZmFjZWJvb2suV2ViRHJpdmVyQWdlbnRSdW5uZXInO1xuY29uc3QgUFJPSkVDVF9GSUxFID0gJ3Byb2plY3QucGJ4cHJvaic7XG5jb25zdCBYQ1VJQ09PUkRJTkFURV9GSUxFID0gJ1ByaXZhdGVIZWFkZXJzL1hDVGVzdC9YQ1VJQ29vcmRpbmF0ZS5oJztcbmNvbnN0IEZCTUFDUk9TX0ZJTEUgPSAnV2ViRHJpdmVyQWdlbnRMaWIvVXRpbGl0aWVzL0ZCTWFjcm9zLmgnO1xuY29uc3QgWENVSUFQUExJQ0FUSU9OX0ZJTEUgPSAnUHJpdmF0ZUhlYWRlcnMvWENUZXN0L1hDVUlBcHBsaWNhdGlvbi5oJztcblxuYXN5bmMgZnVuY3Rpb24gcmVwbGFjZUluRmlsZSAoZmlsZSwgZmluZCwgcmVwbGFjZSkge1xuICBsZXQgY29udGVudHMgPSBhd2FpdCBmcy5yZWFkRmlsZShmaWxlLCAndXRmLTgnKTtcblxuICBsZXQgbmV3Q29udGVudHMgPSBjb250ZW50cy5yZXBsYWNlKGZpbmQsIHJlcGxhY2UpO1xuICBpZiAobmV3Q29udGVudHMgIT09IGNvbnRlbnRzKSB7XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKGZpbGUsIG5ld0NvbnRlbnRzLCAndXRmLTgnKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVQcm9qZWN0RmlsZSAoYWdlbnRQYXRoLCBuZXdCdW5kbGVJZCkge1xuICBsZXQgcHJvamVjdEZpbGVQYXRoID0gYCR7YWdlbnRQYXRofS8ke1BST0pFQ1RfRklMRX1gO1xuICB0cnkge1xuICAgIC8vIGJhY2t1cCB0aGUgZmlsZSwgYW5kIHRoZW4gdXBkYXRlIHRoZSBidW5kbGUgaWQgZm9yIHRoZSBydW5uZXJcbiAgICBhd2FpdCBmcy5jb3B5RmlsZShwcm9qZWN0RmlsZVBhdGgsIGAke3Byb2plY3RGaWxlUGF0aH0ub2xkYCk7XG4gICAgYXdhaXQgcmVwbGFjZUluRmlsZShwcm9qZWN0RmlsZVBhdGgsIG5ldyBSZWdFeHAoV0RBX1JVTk5FUl9CVU5ETEVfSUQucmVwbGFjZSgnLicsICdcXC4nKSwgJ2cnKSwgbmV3QnVuZGxlSWQpO1xuICAgIGxvZy5kZWJ1ZyhgU3VjY2Vzc2Z1bGx5IHVwZGF0ZWQgJyR7cHJvamVjdEZpbGVQYXRofScgd2l0aCBidW5kbGUgaWQgJyR7bmV3QnVuZGxlSWR9J2ApO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZGVidWcoYEVycm9yIHVwZGF0aW5nIHByb2plY3QgZmlsZTogJHtlcnIubWVzc2FnZX1gKTtcbiAgICBsb2cud2FybihgVW5hYmxlIHRvIHVwZGF0ZSBwcm9qZWN0IGZpbGUgJyR7cHJvamVjdEZpbGVQYXRofScgd2l0aCBgICtcbiAgICAgICAgICAgICBgYnVuZGxlIGlkICcke25ld0J1bmRsZUlkfScuIFdlYkRyaXZlckFnZW50IG1heSBub3Qgc3RhcnRgKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiByZXNldFByb2plY3RGaWxlIChhZ2VudFBhdGgsIG5ld0J1bmRsZUlkKSB7XG4gIGxldCBwcm9qZWN0RmlsZVBhdGggPSBgJHthZ2VudFBhdGh9LyR7UFJPSkVDVF9GSUxFfWA7XG4gIHRyeSB7XG4gICAgYXdhaXQgcmVwbGFjZUluRmlsZShwcm9qZWN0RmlsZVBhdGgsIG5ldyBSZWdFeHAobmV3QnVuZGxlSWQucmVwbGFjZSgnLicsICdcXC4nKSwgJ2cnKSwgV0RBX1JVTk5FUl9CVU5ETEVfSUQpO1xuICAgIGF3YWl0IGZzLnVubGluayhgJHtwcm9qZWN0RmlsZVBhdGh9Lm9sZGApO1xuICAgIGxvZy5kZWJ1ZyhgU3VjY2Vzc2Z1bGx5IHJlc2V0ICcke3Byb2plY3RGaWxlUGF0aH0nIHdpdGggYnVuZGxlIGlkICcke1dEQV9SVU5ORVJfQlVORExFX0lEfSdgKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmRlYnVnKGBFcnJvciByZXNldHRpbmcgcHJvamVjdCBmaWxlOiAke2Vyci5tZXNzYWdlfWApO1xuICAgIGxvZy53YXJuKGBVbmFibGUgdG8gcmVzZXQgcHJvamVjdCBmaWxlICcke3Byb2plY3RGaWxlUGF0aH0nIHdpdGggYCArXG4gICAgICAgICAgICAgYGJ1bmRsZSBpZCAnJHtXREFfUlVOTkVSX0JVTkRMRV9JRH0nLiBXZWJEcml2ZXJBZ2VudCBoYXMgYmVlbiBgICtcbiAgICAgICAgICAgICBgbW9kaWZpZWQgYW5kIG5vdCByZXR1cm5lZCB0byB0aGUgb3JpZ2luYWwgc3RhdGUuYCk7XG4gIH1cbn1cblxuY29uc3QgZGVwZW5kZW5jaWVzVXBkYXRlTG9jayA9IG5ldyBBc3luY0xvY2soKTtcblxuYXN5bmMgZnVuY3Rpb24gY2hlY2tGb3JEZXBlbmRlbmNpZXMgKGJvb3RzdHJhcFBhdGgsIHVzZVNzbCA9IGZhbHNlKSB7XG4gIHRyeSB7XG4gICAgbGV0IGNhcnRoYWdlUGF0aCA9IGF3YWl0IGZzLndoaWNoKCdjYXJ0aGFnZScpO1xuICAgIGxvZy5kZWJ1ZyhgQ2FydGhhZ2UgZm91bmQ6ICcke2NhcnRoYWdlUGF0aH0nYCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5lcnJvckFuZFRocm93KCdDYXJ0aGFnZSBub3QgZm91bmQuIEluc3RhbGwgdXNpbmcgYGJyZXcgaW5zdGFsbCBjYXJ0aGFnZWAnKTtcbiAgfVxuICBjb25zdCBjYXJ0aGFnZVJvb3QgPSBgJHtib290c3RyYXBQYXRofS9DYXJ0aGFnZWA7XG4gIGF3YWl0IGRlcGVuZGVuY2llc1VwZGF0ZUxvY2suYWNxdWlyZShjYXJ0aGFnZVJvb3QsIGFzeW5jICgpID0+IHtcbiAgICBpZiAoIWF3YWl0IGZzLmhhc0FjY2VzcyhjYXJ0aGFnZVJvb3QpKSB7XG4gICAgICBsb2cuZGVidWcoJ1J1bm5pbmcgV2ViRHJpdmVyQWdlbnQgYm9vdHN0cmFwIHNjcmlwdCB0byBpbnN0YWxsIGRlcGVuZGVuY2llcycpO1xuICAgICAgdHJ5IHtcbiAgICAgICAgbGV0IGFyZ3MgPSB1c2VTc2wgPyBbJy1kJywgJy1EJ10gOiBbJy1kJ107XG4gICAgICAgIGF3YWl0IGV4ZWMoJ1NjcmlwdHMvYm9vdHN0cmFwLnNoJywgYXJncywge2N3ZDogYm9vdHN0cmFwUGF0aH0pO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIC8vIHByaW50IG91dCB0aGUgc3Rkb3V0IGFuZCBzdGRlcnIgcmVwb3J0c1xuICAgICAgICBmb3IgKGxldCBzdGQgb2YgWydzdGRvdXQnLCAnc3RkZXJyJ10pIHtcbiAgICAgICAgICBmb3IgKGxldCBsaW5lIG9mIChlcnJbc3RkXSB8fCAnJykuc3BsaXQoJ1xcbicpKSB7XG4gICAgICAgICAgICBpZiAoIWxpbmUubGVuZ3RoKSB7XG4gICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbG9nLmVycm9yKGxpbmUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyByZW1vdmUgdGhlIGNhcnRoYWdlIGRpcmVjdG9yeSwgb3IgZWxzZSBzdWJzZXF1ZW50IHJ1bnMgd2lsbCBzZWUgaXQgYW5kXG4gICAgICAgIC8vIGFzc3VtZSB0aGUgZGVwZW5kZW5jaWVzIGFyZSBhbHJlYWR5IGRvd25sb2FkZWRcbiAgICAgICAgYXdhaXQgZnMucmltcmFmKGNhcnRoYWdlUm9vdCk7XG5cbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoIWF3YWl0IGZzLmhhc0FjY2VzcyhgJHtib290c3RyYXBQYXRofS9SZXNvdXJjZXNgKSkge1xuICAgICAgbG9nLmRlYnVnKCdDcmVhdGluZyBXZWJEcml2ZXJBZ2VudCByZXNvdXJjZXMgZGlyZWN0b3J5Jyk7XG4gICAgICBhd2FpdCBmcy5ta2RpcihgJHtib290c3RyYXBQYXRofS9SZXNvdXJjZXNgKTtcbiAgICB9XG4gICAgaWYgKCFhd2FpdCBmcy5oYXNBY2Nlc3MoYCR7Ym9vdHN0cmFwUGF0aH0vUmVzb3VyY2VzL1dlYkRyaXZlckFnZW50LmJ1bmRsZWApKSB7XG4gICAgICBsb2cuZGVidWcoJ0NyZWF0aW5nIFdlYkRyaXZlckFnZW50IHJlc291cmNlIGJ1bmRsZSBkaXJlY3RvcnknKTtcbiAgICAgIGF3YWl0IGZzLm1rZGlyKGAke2Jvb3RzdHJhcFBhdGh9L1Jlc291cmNlcy9XZWJEcml2ZXJBZ2VudC5idW5kbGVgKTtcbiAgICB9XG4gIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRSZWFsRGV2aWNlU2VjdXJpdHkgKGtleWNoYWluUGF0aCwga2V5Y2hhaW5QYXNzd29yZCkge1xuICBsb2cuZGVidWcoJ1NldHRpbmcgc2VjdXJpdHkgZm9yIGlPUyBkZXZpY2UnKTtcbiAgYXdhaXQgZXhlYygnc2VjdXJpdHknLCBbJy12JywgJ2xpc3Qta2V5Y2hhaW5zJywgJy1zJywga2V5Y2hhaW5QYXRoXSk7XG4gIGF3YWl0IGV4ZWMoJ3NlY3VyaXR5JywgWyctdicsICd1bmxvY2sta2V5Y2hhaW4nLCAnLXAnLCBrZXljaGFpblBhc3N3b3JkLCBrZXljaGFpblBhdGhdKTtcbiAgYXdhaXQgZXhlYygnc2VjdXJpdHknLCBbJ3NldC1rZXljaGFpbi1zZXR0aW5ncycsICctdCcsICczNjAwJywgJy1sJywga2V5Y2hhaW5QYXRoXSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpeFhDVUlDb29yZGluYXRlRmlsZSAoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCA9IHRydWUpIHtcbiAgLy8gdGhlIHdheSB0aGUgdXBkYXRlZCBYQ1Rlc3QgaGVhZGVycyBhcmUgaW4gdGhlIFdEQSBwcm9qZWN0LCBidWlsZGluZyBpblxuICAvLyBYY29kZSA4LjAgY2F1c2VzIGEgZHVwbGljYXRlIGRlY2xhcmF0aW9uIG9mIG1ldGhvZFxuICAvLyBzbyBmaXggdGhlIG9mZmVuZGluZyBsaW5lIGluIHRoZSBsb2NhbCBoZWFkZXJzXG4gIGNvbnN0IGZpbGUgPSBwYXRoLnJlc29sdmUoYm9vdHN0cmFwUGF0aCwgWENVSUNPT1JESU5BVEVfRklMRSk7XG5cbiAgbGV0IG9sZERlZiA9ICctICh2b2lkKXByZXNzRm9yRHVyYXRpb246KGRvdWJsZSlhcmcxIHRoZW5EcmFnVG9Db29yZGluYXRlOihpZClhcmcyOyc7XG4gIGxldCBuZXdEZWYgPSAnLSAodm9pZClwcmVzc0ZvckR1cmF0aW9uOihOU1RpbWVJbnRlcnZhbClkdXJhdGlvbiB0aGVuRHJhZ1RvQ29vcmRpbmF0ZTooWENVSUNvb3JkaW5hdGUgKilvdGhlckNvb3JkaW5hdGU7JztcbiAgaWYgKCFpbml0aWFsKSB7XG4gICAgW29sZERlZiwgbmV3RGVmXSA9IFtuZXdEZWYsIG9sZERlZl07XG4gIH1cbiAgYXdhaXQgcmVwbGFjZUluRmlsZShmaWxlLCBvbGREZWYsIG5ld0RlZik7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpeEZvclhjb2RlNyAoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCA9IHRydWUpIHtcbiAgYXdhaXQgZml4WENVSUNvb3JkaW5hdGVGaWxlKGJvb3RzdHJhcFBhdGgsIGluaXRpYWwpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmaXhGQk1hY3Jvc0ZpbGUgKGJvb3RzdHJhcFBhdGgsIGluaXRpYWwgPSB0cnVlKSB7XG4gIGNvbnN0IGZpbGUgPSBwYXRoLnJlc29sdmUoYm9vdHN0cmFwUGF0aCwgRkJNQUNST1NfRklMRSk7XG5cbiAgbGV0IG9sZERlZiA9ICcjZGVmaW5lIEZCU3RyaW5naWZ5KGNsYXNzLCBwcm9wZXJ0eSkgKHtpZihOTyl7W2NsYXNzLm5ldyBwcm9wZXJ0eV07fSBAI3Byb3BlcnR5O30pJztcbiAgbGV0IG5ld0RlZiA9ICcjZGVmaW5lIEZCU3RyaW5naWZ5KGNsYXNzLCBwcm9wZXJ0eSkgKHtAI3Byb3BlcnR5O30pJztcbiAgaWYgKCFpbml0aWFsKSB7XG4gICAgW29sZERlZiwgbmV3RGVmXSA9IFtuZXdEZWYsIG9sZERlZl07XG4gIH1cbiAgYXdhaXQgcmVwbGFjZUluRmlsZShmaWxlLCBvbGREZWYsIG5ld0RlZik7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpeFhDVUlBcHBsaWNhdGlvbkZpbGUgKGJvb3RzdHJhcFBhdGgsIGluaXRpYWwgPSB0cnVlKSB7XG4gIGNvbnN0IGZpbGUgPSBwYXRoLnJlc29sdmUoYm9vdHN0cmFwUGF0aCwgWENVSUFQUExJQ0FUSU9OX0ZJTEUpO1xuXG4gIGxldCBvbGREZWYgPSAnQHByb3BlcnR5KG5vbmF0b21pYywgcmVhZG9ubHkpIE5TVUludGVnZXIgc3RhdGU7IC8vIEBzeW50aGVzaXplIHN0YXRlPV9zdGF0ZTsnO1xuICBsZXQgbmV3RGVmID0gJ0Bwcm9wZXJ0eSBYQ1VJQXBwbGljYXRpb25TdGF0ZSBzdGF0ZTsnO1xuICBpZiAoIWluaXRpYWwpIHtcbiAgICBbb2xkRGVmLCBuZXdEZWZdID0gW25ld0RlZiwgb2xkRGVmXTtcbiAgfVxuICBhd2FpdCByZXBsYWNlSW5GaWxlKGZpbGUsIG9sZERlZiwgbmV3RGVmKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZml4Rm9yWGNvZGU5IChib290c3RyYXBQYXRoLCBpbml0aWFsID0gdHJ1ZSkge1xuICBhd2FpdCBmaXhGQk1hY3Jvc0ZpbGUoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCk7XG4gIGF3YWl0IGZpeFhDVUlBcHBsaWNhdGlvbkZpbGUoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlWGNvZGVDb25maWdGaWxlIChvcmdJZCwgc2lnbmluZ0lkKSB7XG4gIGxvZy5kZWJ1ZyhgR2VuZXJhdGluZyB4Y29kZSBjb25maWcgZmlsZSBmb3Igb3JnSWQgJyR7b3JnSWR9JyBhbmQgc2lnbmluZ0lkIGAgK1xuICAgICAgICAgICAgYCcke3NpZ25pbmdJZH0nYCk7XG4gIGxldCBjb250ZW50cyA9IGBERVZFTE9QTUVOVF9URUFNID0gJHtvcmdJZH1cbkNPREVfU0lHTl9JREVOVElUWSA9ICR7c2lnbmluZ0lkfVxuYDtcbiAgbGV0IHhjY29uZmlnUGF0aCA9IGF3YWl0IHRlbXBEaXIucGF0aCgnYXBwaXVtLXRlbXAueGNjb25maWcnKTtcbiAgbG9nLmRlYnVnKGBXcml0aW5nIHhjb2RlIGNvbmZpZyBmaWxlIHRvICR7eGNjb25maWdQYXRofWApO1xuICBhd2FpdCBmcy53cml0ZUZpbGUoeGNjb25maWdQYXRoLCBjb250ZW50cywgXCJ1dGY4XCIpO1xuICByZXR1cm4geGNjb25maWdQYXRoO1xufVxuXG4vKipcbiAqIENyZWF0ZXMgeGN0ZXN0cnVuIGZpbGUgcGVyIGRldmljZSAmIHBsYXRmb3JtIHZlcnNpb24uXG4gKiBXZSBleHBlY3RzIHRvIGhhdmUgV2ViRHJpdmVyQWdlbnRSdW5uZXJfaXBob25lb3Mke3BsYXRmb3JtVmVyc2lvbn0tYXJtNjQueGN0ZXN0cnVuIGZvciByZWFsIGRldmljZVxuICogYW5kIFdlYkRyaXZlckFnZW50UnVubmVyX2lwaG9uZXNpbXVsYXRvciR7cGxhdGZvcm1WZXJzaW9ufS14ODZfNjQueGN0ZXN0cnVuIGZvciBzaW11bGF0b3IgbG9jYXRlZCBAYm9vdHN0cmFwUGF0aFxuICpcbiAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNSZWFsRGV2aWNlIC0gRXF1YWxzIHRvIHRydWUgaWYgdGhlIGN1cnJlbnQgZGV2aWNlIGlzIGEgcmVhbCBkZXZpY2VcbiAqIEBwYXJhbSB7c3RyaW5nfSB1ZGlkIC0gVGhlIGRldmljZSBVRElELlxuICogQHBhcmFtIHtzdHJpbmd9IHBsYXRmb3JtVmVyc2lvbiAtIFRoZSBwbGF0Zm9ybSB2ZXJzaW9uIG9mIE9TLlxuICogQHBhcmFtIHtzdHJpbmd9IGJvb3RzdHJhcFBhdGggLSBUaGUgZm9sZGVyIHBhdGggY29udGFpbmluZyB4Y3Rlc3RydW4gZmlsZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSB3ZGFSZW1vdGVQb3J0IC0gVGhlIHJlbW90ZSBwb3J0IFdEQSBpcyBsaXN0ZW5pbmcgb24uXG4gKiBAcmV0dXJuIHtzdHJpbmd9IHJldHVybnMgeGN0ZXN0cnVuRmlsZVBhdGggZm9yIGdpdmVuIGRldmljZVxuICogQHRocm93cyBpZiBXZWJEcml2ZXJBZ2VudFJ1bm5lcl9pcGhvbmVvcyR7cGxhdGZvcm1WZXJzaW9ufS1hcm02NC54Y3Rlc3RydW4gZm9yIHJlYWwgZGV2aWNlXG4gKiBvciBXZWJEcml2ZXJBZ2VudFJ1bm5lcl9pcGhvbmVzaW11bGF0b3Ike3BsYXRmb3JtVmVyc2lvbn0teDg2XzY0LnhjdGVzdHJ1biBmb3Igc2ltdWxhdG9yIGlzIG5vdCBmb3VuZCBAYm9vdHN0cmFwUGF0aCxcbiAqIHRoZW4gaXQgd2lsbCB0aHJvdyBmaWxlIG5vdCBmb3VuZCBleGNlcHRpb25cbiAqL1xuYXN5bmMgZnVuY3Rpb24gc2V0WGN0ZXN0cnVuRmlsZSAoaXNSZWFsRGV2aWNlLCB1ZGlkLCBwbGF0Zm9ybVZlcnNpb24sIGJvb3RzdHJhcFBhdGgsIHdkYVJlbW90ZVBvcnQpIHtcbiAgbGV0IHhjdGVzdHJ1bkRldmljZUZpbGVOYW1lID0gYCR7dWRpZH1fJHtwbGF0Zm9ybVZlcnNpb259LnhjdGVzdHJ1bmA7XG4gIGxldCB4Y3Rlc3RydW5GaWxlUGF0aCA9IHBhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCB4Y3Rlc3RydW5EZXZpY2VGaWxlTmFtZSk7XG5cbiAgaWYgKCFhd2FpdCBmcy5leGlzdHMoeGN0ZXN0cnVuRmlsZVBhdGgpKSB7XG4gICAgbGV0IHhjdGVzdEJhc2VGaWxlTmFtZSA9IGlzUmVhbERldmljZSA/IGBXZWJEcml2ZXJBZ2VudFJ1bm5lcl9pcGhvbmVvcyR7cGxhdGZvcm1WZXJzaW9ufS1hcm02NC54Y3Rlc3RydW5gIDpcbiAgICAgIGBXZWJEcml2ZXJBZ2VudFJ1bm5lcl9pcGhvbmVzaW11bGF0b3Ike3BsYXRmb3JtVmVyc2lvbn0teDg2XzY0LnhjdGVzdHJ1bmA7XG4gICAgbGV0IG9yaWdpbmFsWGN0ZXN0cnVuRmlsZSA9IHBhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCB4Y3Rlc3RCYXNlRmlsZU5hbWUpO1xuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKG9yaWdpbmFsWGN0ZXN0cnVuRmlsZSkpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBpZiB5b3UgYXJlIHVzaW5nIHVzZVhjdGVzdHJ1bkZpbGUgY2FwYWJpbGl0eSB0aGVuIHlvdSBuZWVkIHRvIGhhdmUgJHtvcmlnaW5hbFhjdGVzdHJ1bkZpbGV9IGZpbGVgKTtcbiAgICB9XG4gICAgLy8gSWYgdGhpcyBpcyBmaXJzdCB0aW1lIHJ1biBmb3IgZ2l2ZW4gZGV2aWNlLCB0aGVuIGZpcnN0IGdlbmVyYXRlIHhjdGVzdHJ1biBmaWxlIGZvciBkZXZpY2UuXG4gICAgLy8gV2UgbmVlZCB0byBoYXZlIGEgeGN0ZXN0cnVuIGZpbGUgcGVyIGRldmljZSBiZWNhdXNlIHdlIGNhbnQgbm90IGhhdmUgc2FtZSB3ZGEgcG9ydCBmb3IgYWxsIGRldmljZXMuXG4gICAgYXdhaXQgZnMuY29weUZpbGUob3JpZ2luYWxYY3Rlc3RydW5GaWxlLCB4Y3Rlc3RydW5GaWxlUGF0aCk7XG4gIH1cblxuICBsZXQgeGN0ZXN0UnVuQ29udGVudCA9IGF3YWl0IHBsaXN0LnBhcnNlUGxpc3RGaWxlKHhjdGVzdHJ1bkZpbGVQYXRoKTtcblxuICBsZXQgdXBkYXRlV0RBUG9ydCA9IHtcbiAgICBXZWJEcml2ZXJBZ2VudFJ1bm5lcjoge1xuICAgICAgRW52aXJvbm1lbnRWYXJpYWJsZXM6IHtcbiAgICAgICAgVVNFX1BPUlQ6IHdkYVJlbW90ZVBvcnRcbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgbGV0IG5ld1hjdGVzdFJ1bkNvbnRlbnQgPSBfLm1lcmdlKHhjdGVzdFJ1bkNvbnRlbnQsIHVwZGF0ZVdEQVBvcnQpO1xuICBhd2FpdCBwbGlzdC51cGRhdGVQbGlzdEZpbGUoeGN0ZXN0cnVuRmlsZVBhdGgsIG5ld1hjdGVzdFJ1bkNvbnRlbnQsIHRydWUpO1xuXG4gIHJldHVybiB4Y3Rlc3RydW5GaWxlUGF0aDtcbn1cblxuYXN5bmMgZnVuY3Rpb24ga2lsbFByb2Nlc3MgKG5hbWUsIHByb2MpIHtcbiAgaWYgKHByb2MgJiYgcHJvYy5wcm9jKSB7XG4gICAgbG9nLmluZm8oYFNodXR0aW5nIGRvd24gJHtuYW1lfSBwcm9jZXNzIChwaWQgJHtwcm9jLnByb2MucGlkfSlgKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgcHJvYy5zdG9wKCdTSUdURVJNJywgMTAwMCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoZXJyLm1lc3NhZ2UuaW5kZXhPZihgUHJvY2VzcyBkaWRuJ3QgZW5kIGFmdGVyYCkgPT09IC0xKSB7XG4gICAgICAgIHRocm93IGVycjtcbiAgICAgIH1cbiAgICAgIGxvZy5kZWJ1ZyhgJHtuYW1lfSBwcm9jZXNzIGRpZCBub3QgZW5kIGluIGEgdGltZWx5IGZhc2hpb246ICcke2Vyci5tZXNzYWdlfScuIGAgK1xuICAgICAgICAgICAgICAgIGBTZW5kaW5nICdTSUdLSUxMJy4uLmApO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgcHJvYy5zdG9wKCdTSUdLSUxMJyk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgaWYgKGVyci5tZXNzYWdlLmluZGV4T2YoJ25vdCBjdXJyZW50bHkgcnVubmluZycpICE9PSAtMSkge1xuICAgICAgICAgIC8vIHRoZSBwcm9jZXNzIGVuZGVkIGJ1dCBmb3Igc29tZSByZWFzb24gd2Ugd2VyZSBub3QgaW5mb3JtZWRcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIEdlbmVyYXRlIGEgcmFuZG9tIGludGVnZXIuXG4gKlxuICogQHJldHVybiB7bnVtYmVyfSBBIHJhbmRvbSBpbnRlZ2VyIG51bWJlciBpbiByYW5nZSBbbG93LCBoaWdodCkuIGBsb3dgYCBpcyBpbmNsdXNpdmUgYW5kIGBoaWdoYCBpcyBleGNsdXNpdmUuXG4gKi9cbmZ1bmN0aW9uIHJhbmRvbUludCAobG93LCBoaWdoKSB7XG4gIHJldHVybiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAoaGlnaCAtIGxvdykgKyBsb3cpO1xufVxuXG5leHBvcnQgeyB1cGRhdGVQcm9qZWN0RmlsZSwgcmVzZXRQcm9qZWN0RmlsZSwgY2hlY2tGb3JEZXBlbmRlbmNpZXMsXG4gICAgICAgICBzZXRSZWFsRGV2aWNlU2VjdXJpdHksIGZpeEZvclhjb2RlNywgZml4Rm9yWGNvZGU5LFxuICAgICAgICAgZ2VuZXJhdGVYY29kZUNvbmZpZ0ZpbGUsIHNldFhjdGVzdHJ1bkZpbGUsIGtpbGxQcm9jZXNzLCByYW5kb21JbnQgfTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
