'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _2 = require('../../..');

var _3 = _interopRequireDefault(_2);

var _libCommandsPerformanceJs = require('../../../lib/commands/performance.js');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumTestSupport = require('appium-test-support');

var _appiumAdb = require('appium-adb');

var _appiumAdb2 = _interopRequireDefault(_appiumAdb);

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

var PACKAGE_NAME = 'io.appium.android.apis';

var adb = new _appiumAdb2['default']();
var driver = new _3['default']();
driver.adb = adb;

describe('performance data', function () {
  this.timeout(60000);

  describe('getperformancedata', (0, _appiumTestSupport.withMocks)({ adb: adb, driver: driver }, function (mocks) {
    var _this = this;

    it('should get the list of available getPerformance data type', function () {
      var types = driver.getPerformanceDataTypes();
      types.should.eql(_lodash2['default'].keys(_libCommandsPerformanceJs.SUPPORTED_PERFORMANCE_DATA_TYPES));
    });

    function runTest(type, expectedKeys, expectedData) {
      var data;
      return _regeneratorRuntime.async(function runTest$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.getPerformanceData(PACKAGE_NAME, type));

          case 2:
            data = context$3$0.sent;

            // make sure we got something
            Array.isArray(data).should.be['true'];
            data.length.should.eql(2);

            data[0].should.eql(expectedKeys);
            data[1].should.eql(expectedData);

          case 7:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    }

    var types = [{
      cmd: 'cpuinfo',
      description: 'the amount of cpu by user and kernel process',
      args: ['dumpsys', 'cpuinfo', '|', 'grep', '\'' + PACKAGE_NAME + '\''],
      dumpsysData: ' +0% 2209/io.appium.android.apis: 14% user + 23% kernel',
      keys: _libCommandsPerformanceJs.CPU_KEYS,
      data: ['14', '23']
    }, {
      cmd: 'memoryinfo',
      description: 'the amount of memory used by the process (API level 19)',
      args: ['dumpsys', 'meminfo', '\'' + PACKAGE_NAME + '\'', '|', 'grep', '-E', "'Native|Dalvik|EGL|GL|TOTAL'"],
      dumpsysData: '  Native Heap     2469     2332        0        0    20480    13920     6559\n     Dalvik Heap      873      808        0        0     1526      578      948\n    Dalvik Other      148      148        0        0\n           TOTAL     7757     4012      976        0    22006    14498     7507',
      keys: _libCommandsPerformanceJs.MEMORY_KEYS,
      data: ['4012', '2332', '808', undefined, undefined, '7757', '2469', '873', undefined, undefined, '13920', '20480'],
      apiLevel: '19'
    }, {
      cmd: 'memoryinfo',
      description: 'the amount of memory used by the process (API level 19)',
      args: ['dumpsys', 'meminfo', '\'' + PACKAGE_NAME + '\'', '|', 'grep', '-E', "'Native|Dalvik|EGL|GL|TOTAL'"],
      dumpsysData: 'Native|Dalvik|EGL|GL|TOTAL\'\n         Native     1050     1236      968     7580     7428       31\n         Dalvik     2637     5592     2288     3960     3453      507\n          TOTAL     6796    11688     4288    11540    10881      538',
      keys: _libCommandsPerformanceJs.MEMORY_KEYS,
      data: ['4288', '968', '2288', undefined, undefined, '6796', '1050', '2637', undefined, undefined, '7428', '7580'],
      apiLevel: '18'
    }, {
      cmd: 'batteryinfo',
      description: 'the remaining battery power',
      args: ['dumpsys', 'battery', '|', 'grep', 'level'],
      dumpsysData: '  level: 47',
      keys: _libCommandsPerformanceJs.BATTERY_KEYS,
      data: ['47']
    }];
    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      var _loop = function () {
        var type = _step.value;

        describe(type.cmd, function () {
          afterEach(function () {
            mocks.adb.verify();
          });
          it('should get ' + type.description, function callee$4$0() {
            return _regeneratorRuntime.async(function callee$4$0$(context$5$0) {
              while (1) switch (context$5$0.prev = context$5$0.next) {
                case 0:
                  if (type.apiLevel) {
                    mocks.adb.expects('getApiLevel').returns(type.apiLevel);
                  }
                  mocks.adb.expects('shell').withExactArgs(type.args).returns(type.dumpsysData);
                  context$5$0.next = 4;
                  return _regeneratorRuntime.awrap(runTest(type.cmd, type.keys, type.data));

                case 4:
                case 'end':
                  return context$5$0.stop();
              }
            }, null, _this);
          });
          it('should retry if the data is not initially found', function callee$4$0() {
            return _regeneratorRuntime.async(function callee$4$0$(context$5$0) {
              while (1) switch (context$5$0.prev = context$5$0.next) {
                case 0:
                  if (type.apiLevel) {
                    mocks.adb.expects('getApiLevel').returns(type.apiLevel);
                  }
                  mocks.adb.expects('shell').twice().withExactArgs(type.args).onCall(0).returns().onCall(1).returns(type.dumpsysData);
                  context$5$0.next = 4;
                  return _regeneratorRuntime.awrap(runTest(type.cmd, type.keys, type.data));

                case 4:
                case 'end':
                  return context$5$0.stop();
              }
            }, null, _this);
          });
          it('should error out if too many failures', function callee$4$0() {
            return _regeneratorRuntime.async(function callee$4$0$(context$5$0) {
              while (1) switch (context$5$0.prev = context$5$0.next) {
                case 0:
                  mocks.adb.expects('shell').twice().withExactArgs(type.args).onCall(0).returns().onCall(1).returns();
                  context$5$0.next = 3;
                  return _regeneratorRuntime.awrap(runTest(type.cmd, type.keys, type.data).should.be.rejected);

                case 3:
                case 'end':
                  return context$5$0.stop();
              }
            }, null, _this);
          });
        });
      };

      for (var _iterator = _getIterator(types), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        _loop();
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    describe('networkinfo', function () {
      it('should get the network statistics', function () {
        var returnValue = [['bucketStart', 'activeTime', 'rxBytes', 'rxPackets', 'txBytes', 'txPackets', 'operations', 'bucketDuration'], [1478091600000, 1099075, 610947, 928, 114362, 769, 0, 3600000], [1478095200000, 1306300, 405997, 509, 46359, 370, 0, 3600000]];
        mocks.driver.expects('getPerformanceData').withExactArgs('io.appium.android.apis', 'networkinfo', 1000).returns(returnValue);
        var network = driver.getPerformanceData('io.appium.android.apis', 'networkinfo', 1000);
        network.length.should.eql(3);
        var compare = false;

        for (var j = 0; j < _libCommandsPerformanceJs.NETWORK_KEYS.length; ++j) {
          if (_lodash2['default'].isEqual(_libCommandsPerformanceJs.NETWORK_KEYS[j], network[0])) {
            compare = true;
          }
        }

        compare.should.equal(true);

        if (network.length > 1) {
          for (var i = 1; i < network.length; ++i) {
            network[0].length.should.equal(network[i].length);
          }
        }
        mocks.driver.verify();
      });
    });
  }));
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdW5pdC9jb21tYW5kcy9wZXJmb3JtYW5jZS1zcGVjcy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7OztvQkFBaUIsTUFBTTs7Ozs4QkFDSSxrQkFBa0I7Ozs7aUJBQ25CLFVBQVU7Ozs7d0NBRVQsc0NBQXNDOztzQkFDbkQsUUFBUTs7OztpQ0FDSSxxQkFBcUI7O3lCQUMvQixZQUFZOzs7O0FBRzVCLGtCQUFLLE1BQU0sRUFBRSxDQUFDO0FBQ2Qsa0JBQUssR0FBRyw2QkFBZ0IsQ0FBQzs7QUFFekIsSUFBTSxZQUFZLEdBQUcsd0JBQXdCLENBQUM7O0FBRTlDLElBQUksR0FBRyxHQUFHLDRCQUFTLENBQUM7QUFDcEIsSUFBSSxNQUFNLEdBQUcsbUJBQW1CLENBQUM7QUFDakMsTUFBTSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7O0FBRWpCLFFBQVEsQ0FBQyxrQkFBa0IsRUFBRSxZQUFZO0FBQ3ZDLE1BQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7O0FBRXBCLFVBQVEsQ0FBQyxvQkFBb0IsRUFBRSxrQ0FBVSxFQUFDLEdBQUcsRUFBSCxHQUFHLEVBQUUsTUFBTSxFQUFOLE1BQU0sRUFBQyxFQUFFLFVBQVUsS0FBSyxFQUFFOzs7QUFDdkUsTUFBRSxDQUFDLDJEQUEyRCxFQUFFLFlBQU07QUFDcEUsVUFBSSxLQUFLLEdBQUcsTUFBTSxDQUFDLHVCQUF1QixFQUFFLENBQUM7QUFDN0MsV0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsb0JBQUUsSUFBSSw0REFBa0MsQ0FBQyxDQUFDO0tBQzVELENBQUMsQ0FBQzs7QUFFSCxhQUFlLE9BQU8sQ0FBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLFlBQVk7VUFDbEQsSUFBSTs7Ozs7NkNBQVMsTUFBTSxDQUFDLGtCQUFrQixDQUFDLFlBQVksRUFBRSxJQUFJLENBQUM7OztBQUExRCxnQkFBSTs7O0FBR1IsaUJBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsTUFB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U0FDRjs7QUFFRCxlQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQzs7QUFFM0IsWUFBSSxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtBQUN0QixlQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRTtBQUN2QyxtQkFBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztXQUNuRDtTQUNGO0FBQ0QsYUFBSyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztPQUN2QixDQUFDLENBQUM7S0FDSixDQUFDLENBQUM7R0FDSixDQUFDLENBQUMsQ0FBQztDQUNMLENBQUMsQ0FBQyIsImZpbGUiOiJ0ZXN0L3VuaXQvY29tbWFuZHMvcGVyZm9ybWFuY2Utc3BlY3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2hhaSBmcm9tICdjaGFpJztcbmltcG9ydCBjaGFpQXNQcm9taXNlZCBmcm9tICdjaGFpLWFzLXByb21pc2VkJztcbmltcG9ydCBBbmRyb2lkRHJpdmVyIGZyb20gJy4uLy4uLy4uJztcbmltcG9ydCB7IFNVUFBPUlRFRF9QRVJGT1JNQU5DRV9EQVRBX1RZUEVTLCBORVRXT1JLX0tFWVMsIENQVV9LRVlTLCBCQVRURVJZX0tFWVMsXG4gICAgICAgICBNRU1PUllfS0VZU30gZnJvbSAnLi4vLi4vLi4vbGliL2NvbW1hbmRzL3BlcmZvcm1hbmNlLmpzJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyB3aXRoTW9ja3MgfSBmcm9tICdhcHBpdW0tdGVzdC1zdXBwb3J0JztcbmltcG9ydCBBREIgZnJvbSAnYXBwaXVtLWFkYic7XG5cblxuY2hhaS5zaG91bGQoKTtcbmNoYWkudXNlKGNoYWlBc1Byb21pc2VkKTtcblxuY29uc3QgUEFDS0FHRV9OQU1FID0gJ2lvLmFwcGl1bS5hbmRyb2lkLmFwaXMnO1xuXG5sZXQgYWRiID0gbmV3IEFEQigpO1xubGV0IGRyaXZlciA9IG5ldyBBbmRyb2lkRHJpdmVyKCk7XG5kcml2ZXIuYWRiID0gYWRiO1xuXG5kZXNjcmliZSgncGVyZm9ybWFuY2UgZGF0YScsIGZ1bmN0aW9uICgpIHtcbiAgdGhpcy50aW1lb3V0KDYwMDAwKTtcblxuICBkZXNjcmliZSgnZ2V0cGVyZm9ybWFuY2VkYXRhJywgd2l0aE1vY2tzKHthZGIsIGRyaXZlcn0sIGZ1bmN0aW9uIChtb2Nrcykge1xuICAgIGl0KCdzaG91bGQgZ2V0IHRoZSBsaXN0IG9mIGF2YWlsYWJsZSBnZXRQZXJmb3JtYW5jZSBkYXRhIHR5cGUnLCAoKSA9PiB7XG4gICAgICBsZXQgdHlwZXMgPSBkcml2ZXIuZ2V0UGVyZm9ybWFuY2VEYXRhVHlwZXMoKTtcbiAgICAgIHR5cGVzLnNob3VsZC5lcWwoXy5rZXlzKFNVUFBPUlRFRF9QRVJGT1JNQU5DRV9EQVRBX1RZUEVTKSk7XG4gICAgfSk7XG5cbiAgICBhc3luYyBmdW5jdGlvbiBydW5UZXN0ICh0eXBlLCBleHBlY3RlZEtleXMsIGV4cGVjdGVkRGF0YSkge1xuICAgICAgbGV0IGRhdGEgPSBhd2FpdCBkcml2ZXIuZ2V0UGVyZm9ybWFuY2VEYXRhKFBBQ0tBR0VfTkFNRSwgdHlwZSk7XG5cbiAgICAgIC8vIG1ha2Ugc3VyZSB3ZSBnb3Qgc29tZXRoaW5nXG4gICAgICBBcnJheS5pc0FycmF5KGRhdGEpLnNob3VsZC5iZS50cnVlO1xuICAgICAgZGF0YS5sZW5ndGguc2hvdWxkLmVxbCgyKTtcblxuICAgICAgZGF0YVswXS5zaG91bGQuZXFsKGV4cGVjdGVkS2V5cyk7XG4gICAgICBkYXRhWzFdLnNob3VsZC5lcWwoZXhwZWN0ZWREYXRhKTtcbiAgICB9XG5cbiAgICBsZXQgdHlwZXMgPSBbXG4gICAgICB7XG4gICAgICAgIGNtZDogJ2NwdWluZm8nLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ3RoZSBhbW91bnQgb2YgY3B1IGJ5IHVzZXIgYW5kIGtlcm5lbCBwcm9jZXNzJyxcbiAgICAgICAgYXJnczogWydkdW1wc3lzJywgJ2NwdWluZm8nLCAnfCcsICdncmVwJywgYCcke1BBQ0tBR0VfTkFNRX0nYF0sXG4gICAgICAgIGR1bXBzeXNEYXRhOiBgICswJSAyMjA5L2lvLmFwcGl1bS5hbmRyb2lkLmFwaXM6IDE0JSB1c2VyICsgMjMlIGtlcm5lbGAsXG4gICAgICAgIGtleXM6IENQVV9LRVlTLFxuICAgICAgICBkYXRhOiBbJzE0JywgJzIzJ10sXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBjbWQ6ICdtZW1vcnlpbmZvJyxcbiAgICAgICAgZGVzY3JpcHRpb246ICd0aGUgYW1vdW50IG9mIG1lbW9yeSB1c2VkIGJ5IHRoZSBwcm9jZXNzIChBUEkgbGV2ZWwgMTkpJyxcbiAgICAgICAgYXJnczogWydkdW1wc3lzJywgJ21lbWluZm8nLCBgJyR7UEFDS0FHRV9OQU1FfSdgLCAnfCcsICdncmVwJywgJy1FJywgXCInTmF0aXZlfERhbHZpa3xFR0x8R0x8VE9UQUwnXCJdLFxuICAgICAgICBkdW1wc3lzRGF0YTogYCAgTmF0aXZlIEhlYXAgICAgIDI0NjkgICAgIDIzMzIgICAgICAgIDAgICAgICAgIDAgICAgMjA0ODAgICAgMTM5MjAgICAgIDY1NTlcbiAgICAgRGFsdmlrIEhlYXAgICAgICA4NzMgICAgICA4MDggICAgICAgIDAgICAgICAgIDAgICAgIDE1MjYgICAgICA1NzggICAgICA5NDhcbiAgICBEYWx2aWsgT3RoZXIgICAgICAxNDggICAgICAxNDggICAgICAgIDAgICAgICAgIDBcbiAgICAgICAgICAgVE9UQUwgICAgIDc3NTcgICAgIDQwMTIgICAgICA5NzYgICAgICAgIDAgICAgMjIwMDYgICAgMTQ0OTggICAgIDc1MDdgLFxuICAgICAgICBrZXlzOiBNRU1PUllfS0VZUyxcbiAgICAgICAgZGF0YTogWyc0MDEyJywgJzIzMzInLCAnODA4JywgdW5kZWZpbmVkLCB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAnNzc1NycsICcyNDY5JywgJzg3MycsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgJzEzOTIwJywgJzIwNDgwJ10sXG4gICAgICAgIGFwaUxldmVsOiAnMTknLFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgY21kOiAnbWVtb3J5aW5mbycsXG4gICAgICAgIGRlc2NyaXB0aW9uOiAndGhlIGFtb3VudCBvZiBtZW1vcnkgdXNlZCBieSB0aGUgcHJvY2VzcyAoQVBJIGxldmVsIDE5KScsXG4gICAgICAgIGFyZ3M6IFsnZHVtcHN5cycsICdtZW1pbmZvJywgYCcke1BBQ0tBR0VfTkFNRX0nYCwgJ3wnLCAnZ3JlcCcsICctRScsIFwiJ05hdGl2ZXxEYWx2aWt8RUdMfEdMfFRPVEFMJ1wiXSxcbiAgICAgICAgZHVtcHN5c0RhdGE6IGBOYXRpdmV8RGFsdmlrfEVHTHxHTHxUT1RBTCdcbiAgICAgICAgIE5hdGl2ZSAgICAgMTA1MCAgICAgMTIzNiAgICAgIDk2OCAgICAgNzU4MCAgICAgNzQyOCAgICAgICAzMVxuICAgICAgICAgRGFsdmlrICAgICAyNjM3ICAgICA1NTkyICAgICAyMjg4ICAgICAzOTYwICAgICAzNDUzICAgICAgNTA3XG4gICAgICAgICAgVE9UQUwgICAgIDY3OTYgICAgMTE2ODggICAgIDQyODggICAgMTE1NDAgICAgMTA4ODEgICAgICA1MzhgLFxuICAgICAgICBrZXlzOiBNRU1PUllfS0VZUyxcbiAgICAgICAgZGF0YTogWyc0Mjg4JywgJzk2OCcsICcyMjg4JywgdW5kZWZpbmVkLCB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAnNjc5NicsICcxMDUwJywgJzI2MzcnLCB1bmRlZmluZWQsIHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICc3NDI4JywgJzc1ODAnXSxcbiAgICAgICAgYXBpTGV2ZWw6ICcxOCcsXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBjbWQ6ICdiYXR0ZXJ5aW5mbycsXG4gICAgICAgIGRlc2NyaXB0aW9uOiAndGhlIHJlbWFpbmluZyBiYXR0ZXJ5IHBvd2VyJyxcbiAgICAgICAgYXJnczogWydkdW1wc3lzJywgJ2JhdHRlcnknLCAnfCcsICdncmVwJywgJ2xldmVsJ10sXG4gICAgICAgIGR1bXBzeXNEYXRhOiAnICBsZXZlbDogNDcnLFxuICAgICAgICBrZXlzOiBCQVRURVJZX0tFWVMsXG4gICAgICAgIGRhdGE6IFsnNDcnXSxcbiAgICAgIH0sXG4gICAgXTtcbiAgICBmb3IgKGxldCB0eXBlIG9mIHR5cGVzKSB7XG4gICAgICBkZXNjcmliZSh0eXBlLmNtZCwgKCkgPT4ge1xuICAgICAgICBhZnRlckVhY2goKCkgPT4ge1xuICAgICAgICAgIG1vY2tzLmFkYi52ZXJpZnkoKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGl0KGBzaG91bGQgZ2V0ICR7dHlwZS5kZXNjcmlwdGlvbn1gLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgaWYgKHR5cGUuYXBpTGV2ZWwpIHtcbiAgICAgICAgICAgIG1vY2tzLmFkYlxuICAgICAgICAgICAgICAuZXhwZWN0cygnZ2V0QXBpTGV2ZWwnKVxuICAgICAgICAgICAgICAucmV0dXJucyh0eXBlLmFwaUxldmVsKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgbW9ja3MuYWRiXG4gICAgICAgICAgICAuZXhwZWN0cygnc2hlbGwnKVxuICAgICAgICAgICAgLndpdGhFeGFjdEFyZ3ModHlwZS5hcmdzKVxuICAgICAgICAgICAgLnJldHVybnModHlwZS5kdW1wc3lzRGF0YSk7XG4gICAgICAgICAgYXdhaXQgcnVuVGVzdCh0eXBlLmNtZCwgdHlwZS5rZXlzLCB0eXBlLmRhdGEpO1xuICAgICAgICB9KTtcbiAgICAgICAgaXQoJ3Nob3VsZCByZXRyeSBpZiB0aGUgZGF0YSBpcyBub3QgaW5pdGlhbGx5IGZvdW5kJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgIGlmICh0eXBlLmFwaUxldmVsKSB7XG4gICAgICAgICAgICBtb2Nrcy5hZGJcbiAgICAgICAgICAgICAgLmV4cGVjdHMoJ2dldEFwaUxldmVsJylcbiAgICAgICAgICAgICAgLnJldHVybnModHlwZS5hcGlMZXZlbCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIG1vY2tzLmFkYlxuICAgICAgICAgICAgLmV4cGVjdHMoJ3NoZWxsJylcbiAgICAgICAgICAgIC50d2ljZSgpXG4gICAgICAgICAgICAud2l0aEV4YWN0QXJncyh0eXBlLmFyZ3MpXG4gICAgICAgICAgICAub25DYWxsKDApXG4gICAgICAgICAgICAgIC5yZXR1cm5zKClcbiAgICAgICAgICAgIC5vbkNhbGwoMSlcbiAgICAgICAgICAgICAgLnJldHVybnModHlwZS5kdW1wc3lzRGF0YSk7XG4gICAgICAgICAgYXdhaXQgcnVuVGVzdCh0eXBlLmNtZCwgdHlwZS5rZXlzLCB0eXBlLmRhdGEpO1xuICAgICAgICB9KTtcbiAgICAgICAgaXQoJ3Nob3VsZCBlcnJvciBvdXQgaWYgdG9vIG1hbnkgZmFpbHVyZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgbW9ja3MuYWRiXG4gICAgICAgICAgICAuZXhwZWN0cygnc2hlbGwnKVxuICAgICAgICAgICAgLnR3aWNlKClcbiAgICAgICAgICAgIC53aXRoRXhhY3RBcmdzKHR5cGUuYXJncylcbiAgICAgICAgICAgIC5vbkNhbGwoMClcbiAgICAgICAgICAgICAgLnJldHVybnMoKVxuICAgICAgICAgICAgLm9uQ2FsbCgxKVxuICAgICAgICAgICAgICAucmV0dXJucygpO1xuICAgICAgICAgIGF3YWl0IHJ1blRlc3QodHlwZS5jbWQsIHR5cGUua2V5cywgdHlwZS5kYXRhKS5zaG91bGQuYmUucmVqZWN0ZWQ7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgZGVzY3JpYmUoJ25ldHdvcmtpbmZvJywgKCkgPT4ge1xuICAgICAgaXQoJ3Nob3VsZCBnZXQgdGhlIG5ldHdvcmsgc3RhdGlzdGljcycsICgpID0+IHtcbiAgICAgICAgbGV0IHJldHVyblZhbHVlID0gW1xuICAgICAgICAgIFsnYnVja2V0U3RhcnQnLCAnYWN0aXZlVGltZScsICdyeEJ5dGVzJywgJ3J4UGFja2V0cycsICd0eEJ5dGVzJywgJ3R4UGFja2V0cycsICdvcGVyYXRpb25zJywgJ2J1Y2tldER1cmF0aW9uJ10sXG4gICAgICAgICAgWzE0NzgwOTE2MDAwMDAsIDEwOTkwNzUsIDYxMDk0NywgOTI4LCAxMTQzNjIsIDc2OSwgMCwgMzYwMDAwMF0sXG4gICAgICAgICAgWzE0NzgwOTUyMDAwMDAsIDEzMDYzMDAsIDQwNTk5NywgNTA5LCA0NjM1OSwgMzcwLCAwLCAzNjAwMDAwXSxcbiAgICAgICAgXTtcbiAgICAgICAgbW9ja3MuZHJpdmVyLmV4cGVjdHMoJ2dldFBlcmZvcm1hbmNlRGF0YScpLndpdGhFeGFjdEFyZ3MoJ2lvLmFwcGl1bS5hbmRyb2lkLmFwaXMnLCAnbmV0d29ya2luZm8nLCAxMDAwKS5yZXR1cm5zKHJldHVyblZhbHVlKTtcbiAgICAgICAgbGV0IG5ldHdvcmsgPSBkcml2ZXIuZ2V0UGVyZm9ybWFuY2VEYXRhKCdpby5hcHBpdW0uYW5kcm9pZC5hcGlzJywgJ25ldHdvcmtpbmZvJywgMTAwMCk7XG4gICAgICAgIG5ldHdvcmsubGVuZ3RoLnNob3VsZC5lcWwoMyk7XG4gICAgICAgIGxldCBjb21wYXJlID0gZmFsc2U7XG5cbiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBORVRXT1JLX0tFWVMubGVuZ3RoIDsgKytqKSB7XG4gICAgICAgICAgaWYgKF8uaXNFcXVhbChORVRXT1JLX0tFWVNbal0sIG5ldHdvcmtbMF0pKSB7XG4gICAgICAgICAgICBjb21wYXJlID0gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb21wYXJlLnNob3VsZC5lcXVhbCh0cnVlKTtcblxuICAgICAgICBpZiAobmV0d29yay5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBuZXR3b3JrLmxlbmd0aDsgKytpKSB7XG4gICAgICAgICAgICBuZXR3b3JrWzBdLmxlbmd0aC5zaG91bGQuZXF1YWwobmV0d29ya1tpXS5sZW5ndGgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBtb2Nrcy5kcml2ZXIudmVyaWZ5KCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSkpO1xufSk7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uIn0=
