'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _defineProperty = require('babel-runtime/helpers/define-property')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _simulatorXcode8 = require('./simulator-xcode-8');

var _simulatorXcode82 = _interopRequireDefault(_simulatorXcode8);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumSupport = require('appium-support');

var _asyncLock = require('async-lock');

var _asyncLock2 = _interopRequireDefault(_asyncLock);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _nodeSimctl = require('node-simctl');

var _asyncbox = require('asyncbox');

var SIMULATOR_SHUTDOWN_TIMEOUT = 15 * 1000;
var startupLock = new _asyncLock2['default']();
var preferencesPlistGuard = new _asyncLock2['default']();

var SimulatorXcode9 = (function (_SimulatorXcode8) {
  _inherits(SimulatorXcode9, _SimulatorXcode8);

  function SimulatorXcode9(udid, xcodeVersion) {
    _classCallCheck(this, SimulatorXcode9);

    _get(Object.getPrototypeOf(SimulatorXcode9.prototype), 'constructor', this).call(this, udid, xcodeVersion);
  }

  /**
   * @typedef {Object} DevicePreferences
   * @property {number} SimulatorExternalDisplay - TBD. Example value: 2.114
   * @property {string} ChromeTint - TBD. Example value: ''
   * @property {number} SimulatorWindowLastScale - Scale value for the particular Simulator window.
   *                                               1.0 means 100% scale.
   * @property {string} SimulatorWindowOrientation - Simulator window orientation. Possible values are:
   *                                                 'Portrait', 'LandscapeLeft', 'PortraitUpsideDown' and 'LandscapeRight'.
   * @property {number} SimulatorWindowRotationAngle - Window rotation angle. This value is expected to be in sync
   *                                                   with _SimulatorWindowOrientation_. The corresponding values are:
   *                                                   0, 90, 180 and 270.
   * @property {string} SimulatorWindowCenter - The coordinates of Simulator's window center in pixels,
   *                                            for example '{-1294.5, 775.5}'.
   */

  /**
   * @typedef {Object} CommonPreferences
   * @property {boolean} ConnectHardwareKeyboard - Whether to connect hardware keyboard
   */

  /**
   * Executes given Simulator with options. The Simulator will not be restarted if
   * it is already running and the current UI state matches to `isHeadless` option.
   * @override
   *
   * @param {object} opts - One or more of available Simulator options:
   *   - {string} scaleFactor: can be one of ['1.0', '0.75', '0.5', '0.33', '0.25'].
   *   Defines the window scale value for the UI client window for the current Simulator.
   *   Equals to null by default, which keeps the current scale unchanged.
   *   - {boolean} connectHardwareKeyboard: whether to connect the hardware keyboard to the
   *   Simulator UI client. Equals to false by default.
   *   - {number} startupTimeout: number of milliseconds to wait until Simulator booting
   *   process is completed. The default timeout will be used if not set explicitly.
   *   - {boolean} isHeadless: whether to start the Simulator in headless mode (with UI
   *   client invisible). `false` by default.
   *   - {DevicePreferences} devicePreferences: preferences of the newly created Simulator
   *   device
   */

  _createClass(SimulatorXcode9, [{
    key: 'run',
    value: function run() {
      var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
      var commonPreferences, bootSimulator, waitForShutdown, shouldWaitForBoot, startTime;
      return _regeneratorRuntime.async(function run$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            opts = _Object$assign({
              devicePreferences: {},
              isHeadless: false,
              startupTimeout: this.startupTimeout
            }, opts);
            if (opts.scaleFactor) {
              opts.devicePreferences.SimulatorWindowLastScale = parseFloat(opts.scaleFactor);
            }
            commonPreferences = _lodash2['default'].isBoolean(opts.connectHardwareKeyboard) ? { ConnectHardwareKeyboard: opts.connectHardwareKeyboard } : {};

            if (!(!_lodash2['default'].isEmpty(opts.devicePreferences) || !_lodash2['default'].isEmpty(commonPreferences))) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.updatePreferences(opts.devicePreferences, commonPreferences));

          case 6:
            bootSimulator = function bootSimulator() {
              return _regeneratorRuntime.async(function bootSimulator$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.prev = 0;
                    context$3$0.next = 3;
                    return _regeneratorRuntime.awrap((0, _nodeSimctl.bootDevice)(this.udid));

                  case 3:
                    context$3$0.next = 8;
                    break;

                  case 5:
                    context$3$0.prev = 5;
                    context$3$0.t0 = context$3$0['catch'](0);

                    _logger2['default'].warn('\'xcrun simctl boot ' + this.udid + '\' command has returned non-zero code. The problem was: ' + context$3$0.t0.stderr);

                  case 8:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this, [[0, 5]]);
            };

            waitForShutdown = function waitForShutdown() {
              return _regeneratorRuntime.async(function waitForShutdown$(context$3$0) {
                var _this2 = this;

                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap((0, _asyncbox.waitForCondition)(function callee$3$0() {
                      var _ref, state;

                      return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                        while (1) switch (context$4$0.prev = context$4$0.next) {
                          case 0:
                            context$4$0.next = 2;
                            return _regeneratorRuntime.awrap(this.stat());

                          case 2:
                            _ref = context$4$0.sent;
                            state = _ref.state;
                            return context$4$0.abrupt('return', state === 'Shutdown');

                          case 5:
                          case 'end':
                            return context$4$0.stop();
                        }
                      }, null, _this2);
                    }, { waitMs: SIMULATOR_SHUTDOWN_TIMEOUT, intervalMs: 500 }));

                  case 2:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this);
            };

            shouldWaitForBoot = true;
            startTime = process.hrtime();
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(startupLock.acquire(this.uiClientBundleId, function callee$2$0() {
              var stat, serverState, isServerRunning, isUIClientRunning;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(this.stat());

                  case 2:
                    stat = context$3$0.sent;
                    serverState = stat.state;
                    isServerRunning = serverState === 'Booted';
                    context$3$0.next = 7;
                    return _regeneratorRuntime.awrap(this.isUIClientRunning());

                  case 7:
                    isUIClientRunning = context$3$0.sent;

                    if (!opts.isHeadless) {
                      context$3$0.next = 24;
                      break;
                    }

                    if (!(isServerRunning && !isUIClientRunning)) {
                      context$3$0.next = 13;
                      break;
                    }

                    _logger2['default'].info('Simulator with UDID ' + this.udid + ' already booted in headless mode.');
                    shouldWaitForBoot = false;
                    return context$3$0.abrupt('return');

                  case 13:
                    context$3$0.next = 15;
                    return _regeneratorRuntime.awrap(this.killUIClient());

                  case 15:
                    if (!context$3$0.sent) {
                      context$3$0.next = 19;
                      break;
                    }

                    // Stopping the UI client also kills all running servers. Sad but true
                    _logger2['default'].info('Detected the UI client was running and killed it. Verifying the Simulator is in Shutdown state...');
                    context$3$0.next = 19;
                    return _regeneratorRuntime.awrap(waitForShutdown());

                  case 19:
                    _logger2['default'].info('Booting Simulator with UDID ' + this.udid + ' in headless mode. All UI-related capabilities are going to be ignored.');
                    context$3$0.next = 22;
                    return _regeneratorRuntime.awrap(bootSimulator());

                  case 22:
                    context$3$0.next = 46;
                    break;

                  case 24:
                    if (!(isServerRunning && isUIClientRunning)) {
                      context$3$0.next = 28;
                      break;
                    }

                    _logger2['default'].info('Both Simulator with UDID ' + this.udid + ' and the UI client are currently running');
                    shouldWaitForBoot = false;
                    return context$3$0.abrupt('return');

                  case 28:
                    if (!(['Shutdown', 'Booted'].indexOf(serverState) === -1)) {
                      context$3$0.next = 40;
                      break;
                    }

                    _logger2['default'].info('Simulator ' + this.udid + ' is in \'' + serverState + '\' state. Trying to shutdown...');
                    context$3$0.prev = 30;
                    context$3$0.next = 33;
                    return _regeneratorRuntime.awrap(this.shutdown());

                  case 33:
                    context$3$0.next = 38;
                    break;

                  case 35:
                    context$3$0.prev = 35;
                    context$3$0.t0 = context$3$0['catch'](30);

                    _logger2['default'].warn('Error on Simulator shutdown: ' + context$3$0.t0.message);

                  case 38:
                    context$3$0.next = 40;
                    return _regeneratorRuntime.awrap(waitForShutdown());

                  case 40:
                    _logger2['default'].info('Booting Simulator with UDID ' + this.udid + '...');
                    context$3$0.next = 43;
                    return _regeneratorRuntime.awrap(bootSimulator());

                  case 43:
                    if (isUIClientRunning) {
                      context$3$0.next = 46;
                      break;
                    }

                    context$3$0.next = 46;
                    return _regeneratorRuntime.awrap(this.startUIClient(opts));

                  case 46:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this, [[30, 35]]);
            }));

          case 12:
            if (!shouldWaitForBoot) {
              context$2$0.next = 16;
              break;
            }

            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(this.waitForBoot(opts.startupTimeout));

          case 15:
            _logger2['default'].info('Simulator with UDID ' + this.udid + ' booted in ' + process.hrtime(startTime)[0] + ' seconds');

          case 16:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Update the common iOS Simulator preferences file with new values.
     * It is necessary to restart the corresponding Simulator before
     * these changes are applied.
     *
     * @param {DevicePreferences} devicePrefs [{}] - The mapping, which represents new device preference values
     *                                               for the given Simulator.
     * @param {CommonPreferences} commonPrefs [{}] - The mapping, which represents new common preference values
     *                                               for all Simulators.
     * @return {boolean} True if the preferences were successfully updated.
     */
  }, {
    key: 'updatePreferences',
    value: function updatePreferences() {
      var devicePrefs = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
      var commonPrefs = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
      var homeFolderPath, plistPath, newPrefs;
      return _regeneratorRuntime.async(function updatePreferences$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!_lodash2['default'].isEmpty(devicePrefs)) {
              _logger2['default'].debug('Setting preferences of ' + this.udid + ' Simulator to ' + JSON.stringify(devicePrefs));
            }
            if (!_lodash2['default'].isEmpty(commonPrefs)) {
              _logger2['default'].debug('Setting common Simulator preferences to ' + JSON.stringify(commonPrefs));
            }
            homeFolderPath = process.env.HOME;

            if (homeFolderPath) {
              context$2$0.next = 6;
              break;
            }

            _logger2['default'].warn('Cannot get the path to HOME folder from the process environment. ' + 'Ignoring Simulator preferences update.');
            return context$2$0.abrupt('return', false);

          case 6:
            plistPath = _path2['default'].resolve(homeFolderPath, 'Library', 'Preferences', 'com.apple.iphonesimulator.plist');
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(plistPath));

          case 9:
            if (context$2$0.sent) {
              context$2$0.next = 12;
              break;
            }

            _logger2['default'].warn('Simulator preferences file \'' + plistPath + '\' is not accessible. ' + 'Ignoring Simulator preferences update.');
            return context$2$0.abrupt('return', false);

          case 12:
            newPrefs = {};

            if (!_lodash2['default'].isEmpty(devicePrefs)) {
              newPrefs.DevicePreferences = _defineProperty({}, this.udid.toUpperCase(), devicePrefs);
            }
            newPrefs = _lodash2['default'].merge(newPrefs, commonPrefs);
            context$2$0.next = 17;
            return _regeneratorRuntime.awrap(preferencesPlistGuard.acquire(SimulatorXcode9.name, function callee$2$0() {
              var currentPlistContent;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(_appiumSupport.plist.parsePlistFile(plistPath));

                  case 2:
                    currentPlistContent = context$3$0.sent;
                    context$3$0.next = 5;
                    return _regeneratorRuntime.awrap(_appiumSupport.plist.updatePlistFile(plistPath, _lodash2['default'].merge(currentPlistContent, newPrefs), true));

                  case 5:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this3);
            }));

          case 17:
            _logger2['default'].debug('Updated shared Simulator preferences at \'' + plistPath + '\' with ' + JSON.stringify(newPrefs));
            return context$2$0.abrupt('return', true);

          case 19:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Shut down the current Simulator.
     * @override
     */
  }, {
    key: 'shutdown',
    value: function shutdown() {
      var _ref2, state;

      return _regeneratorRuntime.async(function shutdown$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.stat());

          case 2:
            _ref2 = context$2$0.sent;
            state = _ref2.state;

            if (!(state === 'Shutdown')) {
              context$2$0.next = 6;
              break;
            }

            return context$2$0.abrupt('return');

          case 6:
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap((0, _nodeSimctl.shutdown)(this.udid));

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Reset the current Simulator to the clean state.
     * @override
     */
  }, {
    key: 'clean',
    value: function clean() {
      return _regeneratorRuntime.async(function clean$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].info('Cleaning simulator ' + this.udid);
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _nodeSimctl.eraseDevice)(this.udid, 10000));

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return SimulatorXcode9;
})(_simulatorXcode82['default']);

exports['default'] = SimulatorXcode9;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3IteGNvZGUtOS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OytCQUE0QixxQkFBcUI7Ozs7c0JBQ25DLFFBQVE7Ozs7b0JBQ0wsTUFBTTs7Ozs2QkFDRyxnQkFBZ0I7O3lCQUNwQixZQUFZOzs7O3NCQUNsQixVQUFVOzs7OzBCQUMwQyxhQUFhOzt3QkFDaEQsVUFBVTs7QUFHM0MsSUFBTSwwQkFBMEIsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDO0FBQzdDLElBQU0sV0FBVyxHQUFHLDRCQUFlLENBQUM7QUFDcEMsSUFBTSxxQkFBcUIsR0FBRyw0QkFBZSxDQUFDOztJQUV4QyxlQUFlO1lBQWYsZUFBZTs7QUFDUCxXQURSLGVBQWUsQ0FDTixJQUFJLEVBQUUsWUFBWSxFQUFFOzBCQUQ3QixlQUFlOztBQUVqQiwrQkFGRSxlQUFlLDZDQUVYLElBQUksRUFBRSxZQUFZLEVBQUU7R0FDM0I7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O2VBSEcsZUFBZTs7V0EyQ1Q7VUFBQyxJQUFJLHlEQUFHLEVBQUU7VUFTWixpQkFBaUIsRUFNakIsYUFBYSxFQU9iLGVBQWUsRUFNakIsaUJBQWlCLEVBQ2YsU0FBUzs7Ozs7O0FBNUJmLGdCQUFJLEdBQUcsZUFBYztBQUNuQiwrQkFBaUIsRUFBRSxFQUFFO0FBQ3JCLHdCQUFVLEVBQUUsS0FBSztBQUNqQiw0QkFBYyxFQUFFLElBQUksQ0FBQyxjQUFjO2FBQ3BDLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDVCxnQkFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO0FBQ3BCLGtCQUFJLENBQUMsaUJBQWlCLENBQUMsd0JBQXdCLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQzthQUNoRjtBQUNLLDZCQUFpQixHQUFHLG9CQUFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsR0FDakUsRUFBQyx1QkFBdUIsRUFB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QUFFLFdBQVcsQ0FBQyxDQUFDOzs2Q0FDcEMscUJBQXFCLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxJQUFJLEVBQUU7a0JBQ2xELG1CQUFtQjs7Ozs7cURBQVMscUJBQU0sY0FBYyxDQUFDLFNBQVMsQ0FBQzs7O0FBQTNELHVDQUFtQjs7cURBQ25CLHFCQUFNLGVBQWUsQ0FBQyxTQUFTLEVBQUUsb0JBQUUsS0FBSyxDQUFDLG1CQUFtQixFQUFFLFFBQVEsQ0FBQyxFQUFFLElBQUksQ0FBQzs7Ozs7OzthQUNyRixDQUFDOzs7QUFDRixnQ0FBSSxLQUFLLGdEQUE2QyxTQUFTLGdCQUFVLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUcsQ0FBQztnREFDOUYsSUFBSTs7Ozs7OztLQUNaOzs7Ozs7OztXQU1jO2lCQUNOLEtBQUs7Ozs7Ozs2Q0FBVSxJQUFJLENBQUMsSUFBSSxFQUFFOzs7O0FBQTFCLGlCQUFLLFNBQUwsS0FBSzs7a0JBQ1IsS0FBSyxLQUFLLFVBQVUsQ0FBQTs7Ozs7Ozs7OzZDQUdsQiwwQkFBZSxJQUFJLENBQUMsSUFBSSxDQUFDOzs7Ozs7O0tBQ2hDOzs7Ozs7OztXQU1XOzs7O0FBQ1YsZ0NBQUksSUFBSSx5QkFBdUIsSUFBSSxDQUFDLElBQUksQ0FBRyxDQUFDOzs2Q0FDdEMsNkJBQVksSUFBSSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUM7Ozs7Ozs7S0FDcEM7OztTQXRMRyxlQUFlOzs7cUJBeUxOLGVBQWUiLCJmaWxlIjoibGliL3NpbXVsYXRvci14Y29kZS05LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFNpbXVsYXRvclhjb2RlOCBmcm9tICcuL3NpbXVsYXRvci14Y29kZS04JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZzLCBwbGlzdCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBBc3luY0xvY2sgZnJvbSAnYXN5bmMtbG9jayc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IHNodXRkb3duIGFzIHNpbWN0bFNodXRkb3duLCBib290RGV2aWNlLCBlcmFzZURldmljZSB9IGZyb20gJ25vZGUtc2ltY3RsJztcbmltcG9ydCB7IHdhaXRGb3JDb25kaXRpb24gfSBmcm9tICdhc3luY2JveCc7XG5cblxuY29uc3QgU0lNVUxBVE9SX1NIVVRET1dOX1RJTUVPVVQgPSAxNSAqIDEwMDA7XG5jb25zdCBzdGFydHVwTG9jayA9IG5ldyBBc3luY0xvY2soKTtcbmNvbnN0IHByZWZlcmVuY2VzUGxpc3RHdWFyZCA9IG5ldyBBc3luY0xvY2soKTtcblxuY2xhc3MgU2ltdWxhdG9yWGNvZGU5IGV4dGVuZHMgU2ltdWxhdG9yWGNvZGU4IHtcbiAgY29uc3RydWN0b3IgKHVkaWQsIHhjb2RlVmVyc2lvbikge1xuICAgIHN1cGVyKHVkaWQsIHhjb2RlVmVyc2lvbik7XG4gIH1cblxuICAvKipcbiAgICogQHR5cGVkZWYge09iamVjdH0gRGV2aWNlUHJlZmVyZW5jZXNcbiAgICogQHByb3BlcnR5IHtudW1iZXJ9IFNpbXVsYXRvckV4dGVybmFsRGlzcGxheSAtIFRCRC4gRXhhbXBsZSB2YWx1ZTogMi4xMTRcbiAgICogQHByb3BlcnR5IHtzdHJpbmd9IENocm9tZVRpbnQgLSBUQkQuIEV4YW1wbGUgdmFsdWU6ICcnXG4gICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBTaW11bGF0b3JXaW5kb3dMYXN0U2NhbGUgLSBTY2FsZSB2YWx1ZSBmb3IgdGhlIHBhcnRpY3VsYXIgU2ltdWxhdG9yIHdpbmRvdy5cbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEuMCBtZWFucyAxMDAlIHNjYWxlLlxuICAgKiBAcHJvcGVydHkge3N0cmluZ30gU2ltdWxhdG9yV2luZG93T3JpZW50YXRpb24gLSBTaW11bGF0b3Igd2luZG93IG9yaWVudGF0aW9uLiBQb3NzaWJsZSB2YWx1ZXMgYXJlOlxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnUG9ydHJhaXQnLCAnTGFuZHNjYXBlTGVmdCcsICdQb3J0cmFpdFVwc2lkZURvd24nIGFuZCAnTGFuZHNjYXBlUmlnaHQnLlxuICAgKiBAcHJvcGVydHkge251bWJlcn0gU2ltdWxhdG9yV2luZG93Um90YXRpb25BbmdsZSAtIFdpbmRvdyByb3RhdGlvbiBhbmdsZS4gVGhpcyB2YWx1ZSBpcyBleHBlY3RlZCB0byBiZSBpbiBzeW5jXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2l0aCBfU2ltdWxhdG9yV2luZG93T3JpZW50YXRpb25fLiBUaGUgY29ycmVzcG9uZGluZyB2YWx1ZXMgYXJlOlxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAsIDkwLCAxODAgYW5kIDI3MC5cbiAgICogQHByb3BlcnR5IHtzdHJpbmd9IFNpbXVsYXRvcldpbmRvd0NlbnRlciAtIFRoZSBjb29yZGluYXRlcyBvZiBTaW11bGF0b3IncyB3aW5kb3cgY2VudGVyIGluIHBpeGVscyxcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBleGFtcGxlICd7LTEyOTQuNSwgNzc1LjV9Jy5cbiAgICovXG5cbiAgLyoqXG4gICAqIEB0eXBlZGVmIHtPYmplY3R9IENvbW1vblByZWZlcmVuY2VzXG4gICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gQ29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQgLSBXaGV0aGVyIHRvIGNvbm5lY3QgaGFyZHdhcmUga2V5Ym9hcmRcbiAgICovXG5cbiAgLyoqXG4gICAqIEV4ZWN1dGVzIGdpdmVuIFNpbXVsYXRvciB3aXRoIG9wdGlvbnMuIFRoZSBTaW11bGF0b3Igd2lsbCBub3QgYmUgcmVzdGFydGVkIGlmXG4gICAqIGl0IGlzIGFscmVhZHkgcnVubmluZyBhbmQgdGhlIGN1cnJlbnQgVUkgc3RhdGUgbWF0Y2hlcyB0byBgaXNIZWFkbGVzc2Agb3B0aW9uLlxuICAgKiBAb3ZlcnJpZGVcbiAgICpcbiAgICogQHBhcmFtIHtvYmplY3R9IG9wdHMgLSBPbmUgb3IgbW9yZSBvZiBhdmFpbGFibGUgU2ltdWxhdG9yIG9wdGlvbnM6XG4gICAqICAgLSB7c3RyaW5nfSBzY2FsZUZhY3RvcjogY2FuIGJlIG9uZSBvZiBbJzEuMCcsICcwLjc1JywgJzAuNScsICcwLjMzJywgJzAuMjUnXS5cbiAgICogICBEZWZpbmVzIHRoZSB3aW5kb3cgc2NhbGUgdmFsdWUgZm9yIHRoZSBVSSBjbGllbnQgd2luZG93IGZvciB0aGUgY3VycmVudCBTaW11bGF0b3IuXG4gICAqICAgRXF1YWxzIHRvIG51bGwgYnkgZGVmYXVsdCwgd2hpY2gga2VlcHMgdGhlIGN1cnJlbnQgc2NhbGUgdW5jaGFuZ2VkLlxuICAgKiAgIC0ge2Jvb2xlYW59IGNvbm5lY3RIYXJkd2FyZUtleWJvYXJkOiB3aGV0aGVyIHRvIGNvbm5lY3QgdGhlIGhhcmR3YXJlIGtleWJvYXJkIHRvIHRoZVxuICAgKiAgIFNpbXVsYXRvciBVSSBjbGllbnQuIEVxdWFscyB0byBmYWxzZSBieSBkZWZhdWx0LlxuICAgKiAgIC0ge251bWJlcn0gc3RhcnR1cFRpbWVvdXQ6IG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gd2FpdCB1bnRpbCBTaW11bGF0b3IgYm9vdGluZ1xuICAgKiAgIHByb2Nlc3MgaXMgY29tcGxldGVkLiBUaGUgZGVmYXVsdCB0aW1lb3V0IHdpbGwgYmUgdXNlZCBpZiBub3Qgc2V0IGV4cGxpY2l0bHkuXG4gICAqICAgLSB7Ym9vbGVhbn0gaXNIZWFkbGVzczogd2hldGhlciB0byBzdGFydCB0aGUgU2ltdWxhdG9yIGluIGhlYWRsZXNzIG1vZGUgKHdpdGggVUlcbiAgICogICBjbGllbnQgaW52aXNpYmxlKS4gYGZhbHNlYCBieSBkZWZhdWx0LlxuICAgKiAgIC0ge0RldmljZVByZWZlcmVuY2VzfSBkZXZpY2VQcmVmZXJlbmNlczogcHJlZmVyZW5jZXMgb2YgdGhlIG5ld2x5IGNyZWF0ZWQgU2ltdWxhdG9yXG4gICAqICAgZGV2aWNlXG4gICAqL1xuICBhc3luYyBydW4gKG9wdHMgPSB7fSkge1xuICAgIG9wdHMgPSBPYmplY3QuYXNzaWduKHtcbiAgICAgIGRldmljZVByZWZlcmVuY2VzOiB7fSxcbiAgICAgIGlzSGVhZGxlc3M6IGZhbHNlLFxuICAgICAgc3RhcnR1cFRpbWVvdXQ6IHRoaXMuc3RhcnR1cFRpbWVvdXQsXG4gICAgfSwgb3B0cyk7XG4gICAgaWYgKG9wdHMuc2NhbGVGYWN0b3IpIHtcbiAgICAgIG9wdHMuZGV2aWNlUHJlZmVyZW5jZXMuU2ltdWxhdG9yV2luZG93TGFzdFNjYWxlID0gcGFyc2VGbG9hdChvcHRzLnNjYWxlRmFjdG9yKTtcbiAgICB9XG4gICAgY29uc3QgY29tbW9uUHJlZmVyZW5jZXMgPSBfLmlzQm9vbGVhbihvcHRzLmNvbm5lY3RIYXJkd2FyZUtleWJvYXJkKSA/XG4gICAgICB7Q29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQ6IG9wdHMuY29ubmVjdEhhcmR3YXJlS2V5Ym9hcmR9IDpcbiAgICAgIHt9O1xuICAgIGlmICghXy5pc0VtcHR5KG9wdHMuZGV2aWNlUHJlZmVyZW5jZXMpIHx8ICFfLmlzRW1wdHkoY29tbW9uUHJlZmVyZW5jZXMpKSB7XG4gICAgICBhd2FpdCB0aGlzLnVwZGF0ZVByZWZlcmVuY2VzKG9wdHMuZGV2aWNlUHJlZmVyZW5jZXMsIGNvbW1vblByZWZlcmVuY2VzKTtcbiAgICB9XG4gICAgY29uc3QgYm9vdFNpbXVsYXRvciA9IGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGJvb3REZXZpY2UodGhpcy51ZGlkKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBsb2cud2FybihgJ3hjcnVuIHNpbWN0bCBib290ICR7dGhpcy51ZGlkfScgY29tbWFuZCBoYXMgcmV0dXJuZWQgbm9uLXplcm8gY29kZS4gVGhlIHByb2JsZW0gd2FzOiAke2Vyci5zdGRlcnJ9YCk7XG4gICAgICB9XG4gICAgfTtcbiAgICBjb25zdCB3YWl0Rm9yU2h1dGRvd24gPSBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3Qge3N0YXRlfSA9IGF3YWl0IHRoaXMuc3RhdCgpO1xuICAgICAgICByZXR1cm4gc3RhdGUgPT09ICdTaHV0ZG93bic7XG4gICAgICB9LCB7d2FpdE1zOiBTSU1VTEFUT1JfU0hVVERPV05fVElNRU9VVCwgaW50ZXJ2YWxNczogNTAwfSk7XG4gICAgfTtcbiAgICBsZXQgc2hvdWxkV2FpdEZvckJvb3QgPSB0cnVlO1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IHByb2Nlc3MuaHJ0aW1lKCk7XG4gICAgYXdhaXQgc3RhcnR1cExvY2suYWNxdWlyZSh0aGlzLnVpQ2xpZW50QnVuZGxlSWQsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHN0YXQgPSBhd2FpdCB0aGlzLnN0YXQoKTtcbiAgICAgIGNvbnN0IHNlcnZlclN0YXRlID0gc3RhdC5zdGF0ZTtcbiAgICAgIGNvbnN0IGlzU2VydmVyUnVubmluZyA9IHNlcnZlclN0YXRlID09PSAnQm9vdGVkJztcbiAgICAgIGNvbnN0IGlzVUlDbGllbnRSdW5uaW5nID0gYXdhaXQgdGhpcy5pc1VJQ2xpZW50UnVubmluZygpO1xuICAgICAgaWYgKG9wdHMuaXNIZWFkbGVzcykge1xuICAgICAgICBpZiAoaXNTZXJ2ZXJSdW5uaW5nICYmICFpc1VJQ2xpZW50UnVubmluZykge1xuICAgICAgICAgIGxvZy5pbmZvKGBTaW11bGF0b3Igd2l0aCBVRElEICR7dGhpcy51ZGlkfSBhbHJlYWR5IGJvb3RlZCBpbiBoZWFkbGVzcyBtb2RlLmApO1xuICAgICAgICAgIHNob3VsZFdhaXRGb3JCb290ID0gZmFsc2U7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChhd2FpdCB0aGlzLmtpbGxVSUNsaWVudCgpKSB7XG4gICAgICAgICAgLy8gU3RvcHBpbmcgdGhlIFVJIGNsaWVudCBhbHNvIGtpbGxzIGFsbCBydW5uaW5nIHNlcnZlcnMuIFNhZCBidXQgdHJ1ZVxuICAgICAgICAgIGxvZy5pbmZvKGBEZXRlY3RlZCB0aGUgVUkgY2xpZW50IHdhcyBydW5uaW5nIGFuZCBraWxsZWQgaXQuIFZlcmlmeWluZyB0aGUgU2ltdWxhdG9yIGlzIGluIFNodXRkb3duIHN0YXRlLi4uYCk7XG4gICAgICAgICAgYXdhaXQgd2FpdEZvclNodXRkb3duKCk7XG4gICAgICAgIH1cbiAgICAgICAgbG9nLmluZm8oYEJvb3RpbmcgU2ltdWxhdG9yIHdpdGggVURJRCAke3RoaXMudWRpZH0gaW4gaGVhZGxlc3MgbW9kZS4gQWxsIFVJLXJlbGF0ZWQgY2FwYWJpbGl0aWVzIGFyZSBnb2luZyB0byBiZSBpZ25vcmVkLmApO1xuICAgICAgICBhd2FpdCBib290U2ltdWxhdG9yKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoaXNTZXJ2ZXJSdW5uaW5nICYmIGlzVUlDbGllbnRSdW5uaW5nKSB7XG4gICAgICAgICAgbG9nLmluZm8oYEJvdGggU2ltdWxhdG9yIHdpdGggVURJRCAke3RoaXMudWRpZH0gYW5kIHRoZSBVSSBjbGllbnQgYXJlIGN1cnJlbnRseSBydW5uaW5nYCk7XG4gICAgICAgICAgc2hvdWxkV2FpdEZvckJvb3QgPSBmYWxzZTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFsnU2h1dGRvd24nLCAnQm9vdGVkJ10uaW5kZXhPZihzZXJ2ZXJTdGF0ZSkgPT09IC0xKSB7XG4gICAgICAgICAgbG9nLmluZm8oYFNpbXVsYXRvciAke3RoaXMudWRpZH0gaXMgaW4gJyR7c2VydmVyU3RhdGV9JyBzdGF0ZS4gVHJ5aW5nIHRvIHNodXRkb3duLi4uYCk7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc2h1dGRvd24oKTtcbiAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGxvZy53YXJuKGBFcnJvciBvbiBTaW11bGF0b3Igc2h1dGRvd246ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGF3YWl0IHdhaXRGb3JTaHV0ZG93bigpO1xuICAgICAgICB9XG4gICAgICAgIGxvZy5pbmZvKGBCb290aW5nIFNpbXVsYXRvciB3aXRoIFVESUQgJHt0aGlzLnVkaWR9Li4uYCk7XG4gICAgICAgIGF3YWl0IGJvb3RTaW11bGF0b3IoKTtcbiAgICAgICAgaWYgKCFpc1VJQ2xpZW50UnVubmluZykge1xuICAgICAgICAgIGF3YWl0IHRoaXMuc3RhcnRVSUNsaWVudChvcHRzKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaWYgKHNob3VsZFdhaXRGb3JCb290KSB7XG4gICAgICBhd2FpdCB0aGlzLndhaXRGb3JCb290KG9wdHMuc3RhcnR1cFRpbWVvdXQpO1xuICAgICAgbG9nLmluZm8oYFNpbXVsYXRvciB3aXRoIFVESUQgJHt0aGlzLnVkaWR9IGJvb3RlZCBpbiAke3Byb2Nlc3MuaHJ0aW1lKHN0YXJ0VGltZSlbMF19IHNlY29uZHNgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIHRoZSBjb21tb24gaU9TIFNpbXVsYXRvciBwcmVmZXJlbmNlcyBmaWxlIHdpdGggbmV3IHZhbHVlcy5cbiAgICogSXQgaXMgbmVjZXNzYXJ5IHRvIHJlc3RhcnQgdGhlIGNvcnJlc3BvbmRpbmcgU2ltdWxhdG9yIGJlZm9yZVxuICAgKiB0aGVzZSBjaGFuZ2VzIGFyZSBhcHBsaWVkLlxuICAgKlxuICAgKiBAcGFyYW0ge0RldmljZVByZWZlcmVuY2VzfSBkZXZpY2VQcmVmcyBbe31dIC0gVGhlIG1hcHBpbmcsIHdoaWNoIHJlcHJlc2VudHMgbmV3IGRldmljZSBwcmVmZXJlbmNlIHZhbHVlc1xuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIHRoZSBnaXZlbiBTaW11bGF0b3IuXG4gICAqIEBwYXJhbSB7Q29tbW9uUHJlZmVyZW5jZXN9IGNvbW1vblByZWZzIFt7fV0gLSBUaGUgbWFwcGluZywgd2hpY2ggcmVwcmVzZW50cyBuZXcgY29tbW9uIHByZWZlcmVuY2UgdmFsdWVzXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgYWxsIFNpbXVsYXRvcnMuXG4gICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIHByZWZlcmVuY2VzIHdlcmUgc3VjY2Vzc2Z1bGx5IHVwZGF0ZWQuXG4gICAqL1xuICBhc3luYyB1cGRhdGVQcmVmZXJlbmNlcyAoZGV2aWNlUHJlZnMgPSB7fSwgY29tbW9uUHJlZnMgPSB7fSkge1xuICAgIGlmICghXy5pc0VtcHR5KGRldmljZVByZWZzKSkge1xuICAgICAgbG9nLmRlYnVnKGBTZXR0aW5nIHByZWZlcmVuY2VzIG9mICR7dGhpcy51ZGlkfSBTaW11bGF0b3IgdG8gJHtKU09OLnN0cmluZ2lmeShkZXZpY2VQcmVmcyl9YCk7XG4gICAgfVxuICAgIGlmICghXy5pc0VtcHR5KGNvbW1vblByZWZzKSkge1xuICAgICAgbG9nLmRlYnVnKGBTZXR0aW5nIGNvbW1vbiBTaW11bGF0b3IgcHJlZmVyZW5jZXMgdG8gJHtKU09OLnN0cmluZ2lmeShjb21tb25QcmVmcyl9YCk7XG4gICAgfVxuICAgIGNvbnN0IGhvbWVGb2xkZXJQYXRoID0gcHJvY2Vzcy5lbnYuSE9NRTtcbiAgICBpZiAoIWhvbWVGb2xkZXJQYXRoKSB7XG4gICAgICBsb2cud2FybihgQ2Fubm90IGdldCB0aGUgcGF0aCB0byBIT01FIGZvbGRlciBmcm9tIHRoZSBwcm9jZXNzIGVudmlyb25tZW50LiBgICtcbiAgICAgICAgYElnbm9yaW5nIFNpbXVsYXRvciBwcmVmZXJlbmNlcyB1cGRhdGUuYCk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGNvbnN0IHBsaXN0UGF0aCA9IHBhdGgucmVzb2x2ZShob21lRm9sZGVyUGF0aCwgJ0xpYnJhcnknLCAnUHJlZmVyZW5jZXMnLCAnY29tLmFwcGxlLmlwaG9uZXNpbXVsYXRvci5wbGlzdCcpO1xuICAgIGlmICghYXdhaXQgZnMuaGFzQWNjZXNzKHBsaXN0UGF0aCkpIHtcbiAgICAgIGxvZy53YXJuKGBTaW11bGF0b3IgcHJlZmVyZW5jZXMgZmlsZSAnJHtwbGlzdFBhdGh9JyBpcyBub3QgYWNjZXNzaWJsZS4gYCArXG4gICAgICAgIGBJZ25vcmluZyBTaW11bGF0b3IgcHJlZmVyZW5jZXMgdXBkYXRlLmApO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBsZXQgbmV3UHJlZnMgPSB7fTtcbiAgICBpZiAoIV8uaXNFbXB0eShkZXZpY2VQcmVmcykpIHtcbiAgICAgIG5ld1ByZWZzLkRldmljZVByZWZlcmVuY2VzID0ge1t0aGlzLnVkaWQudG9VcHBlckNhc2UoKV06IGRldmljZVByZWZzfTtcbiAgICB9XG4gICAgbmV3UHJlZnMgPSBfLm1lcmdlKG5ld1ByZWZzLCBjb21tb25QcmVmcyk7XG4gICAgYXdhaXQgcHJlZmVyZW5jZXNQbGlzdEd1YXJkLmFjcXVpcmUoU2ltdWxhdG9yWGNvZGU5Lm5hbWUsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGN1cnJlbnRQbGlzdENvbnRlbnQgPSBhd2FpdCBwbGlzdC5wYXJzZVBsaXN0RmlsZShwbGlzdFBhdGgpO1xuICAgICAgYXdhaXQgcGxpc3QudXBkYXRlUGxpc3RGaWxlKHBsaXN0UGF0aCwgXy5tZXJnZShjdXJyZW50UGxpc3RDb250ZW50LCBuZXdQcmVmcyksIHRydWUpO1xuICAgIH0pO1xuICAgIGxvZy5kZWJ1ZyhgVXBkYXRlZCBzaGFyZWQgU2ltdWxhdG9yIHByZWZlcmVuY2VzIGF0ICcke3BsaXN0UGF0aH0nIHdpdGggJHtKU09OLnN0cmluZ2lmeShuZXdQcmVmcyl9YCk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICogU2h1dCBkb3duIHRoZSBjdXJyZW50IFNpbXVsYXRvci5cbiAgICogQG92ZXJyaWRlXG4gICAqL1xuICBhc3luYyBzaHV0ZG93biAoKSB7XG4gICAgY29uc3Qge3N0YXRlfSA9IGF3YWl0IHRoaXMuc3RhdCgpO1xuICAgIGlmIChzdGF0ZSA9PT0gJ1NodXRkb3duJykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBhd2FpdCBzaW1jdGxTaHV0ZG93bih0aGlzLnVkaWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc2V0IHRoZSBjdXJyZW50IFNpbXVsYXRvciB0byB0aGUgY2xlYW4gc3RhdGUuXG4gICAqIEBvdmVycmlkZVxuICAgKi9cbiAgYXN5bmMgY2xlYW4gKCkge1xuICAgIGxvZy5pbmZvKGBDbGVhbmluZyBzaW11bGF0b3IgJHt0aGlzLnVkaWR9YCk7XG4gICAgYXdhaXQgZXJhc2VEZXZpY2UodGhpcy51ZGlkLCAxMDAwMCk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgU2ltdWxhdG9yWGNvZGU5O1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
