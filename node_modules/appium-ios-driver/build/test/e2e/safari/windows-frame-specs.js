'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _safariSetup = require('./safari-setup');

var _safariSetup2 = _interopRequireDefault(_safariSetup);

var _helpersEnv = require('../helpers/env');

var _helpersEnv2 = _interopRequireDefault(_helpersEnv);

var _helpersWebview = require("../helpers/webview");

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _helpersSession = require('../helpers/session');

describe('safari - windows and frames (' + _helpersEnv2['default'].DEVICE + ')', function () {
  this.timeout(_helpersSession.MOCHA_SAFARI_TIMEOUT);

  var driver = (0, _safariSetup2['default'])(this, {
    browserName: 'safari',
    nativeWebTap: true,
    safariAllowPopups: true
  }).driver;

  describe('within webview', function () {
    var _this = this;

    before(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.implicitWait(1000));

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    beforeEach(function () {
      return (0, _helpersWebview.loadWebView)("safari", driver);
    });

    it("should throw nosuchwindow if there's not one", function () {
      return driver.setWindow('noexistman').should.be.rejectedWith(/window could not be found/);
    });

    // unfortunately, iOS8 doesn't respond to the close() method on window
    // the way iOS7 does
    it("should be able to open and close windows @skip-ios8", function callee$2$0() {
      var el;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.findElement('id', 'blanklink'));

          case 2:
            el = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(driver.click(el));

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap((0, _helpersWebview.spinTitle)("I am another page title", driver));

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(2000));

          case 9:
            context$3$0.next = 11;
            return _regeneratorRuntime.awrap(driver.closeWindow());

          case 11:
            context$3$0.next = 13;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(3000));

          case 13:
            context$3$0.next = 15;
            return _regeneratorRuntime.awrap((0, _helpersWebview.spinTitle)("I am a page title", driver));

          case 15:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    it('should be able to go back and forward', function callee$2$0() {
      var link;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.findElement('link text', 'i am a link'));

          case 2:
            link = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(driver.click(link));

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(driver.findElement('id', 'only_on_page_2'));

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(driver.back());

          case 9:
            context$3$0.next = 11;
            return _regeneratorRuntime.awrap(driver.findElement('id', 'i_am_a_textbox'));

          case 11:
            context$3$0.next = 13;
            return _regeneratorRuntime.awrap(driver.forward());

          case 13:
            context$3$0.next = 15;
            return _regeneratorRuntime.awrap(driver.findElement('id', 'only_on_page_2'));

          case 15:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    // broken on real devices, see https://github.com/appium/appium/issues/5167
    it("should be able to open js popup windows with safariAllowPopups set to true @skip-real-device", function callee$2$0() {
      var link;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.findElement('link text', 'i am a new window link'));

          case 2:
            link = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(driver.click(link));

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap((0, _helpersWebview.spinTitle)("I am another page title", driver, 30));

          case 7:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  });
});

describe('safari - windows and frames (' + _helpersEnv2['default'].DEVICE + ') - without safariAllowPopups', function () {
  var _this2 = this;

  this.timeout(_helpersSession.MOCHA_SAFARI_TIMEOUT);

  var driver = (0, _safariSetup2['default'])(this, {
    browserName: 'safari',
    safariAllowPopups: false
  }).driver;

  before(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(driver.implicitWait(5000));

        case 2:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this2);
  });
  beforeEach(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _helpersWebview.loadWebView)("safari", driver));

        case 2:
          return context$2$0.abrupt('return', context$2$0.sent);

        case 3:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this2);
  });

  it("should not be able to open js popup windows", function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(driver.execute("window.open('/test/guinea-pig2.html', null)"));

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap((0, _helpersWebview.spinTitle)("I am another page title", driver, 5).should.eventually.be.rejected);

        case 4:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this2);
  });
});

// minimize waiting if something goes wrong

// minimize waiting if something goes wrong
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvZTJlL3NhZmFyaS93aW5kb3dzLWZyYW1lLXNwZWNzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OzsyQkFBa0IsZ0JBQWdCOzs7OzBCQUNsQixnQkFBZ0I7Ozs7OEJBQ08sb0JBQW9COzt3QkFDN0MsVUFBVTs7Ozs4QkFDYSxvQkFBb0I7O0FBR3pELFFBQVEsbUNBQWlDLHdCQUFJLE1BQU0sUUFBSyxZQUFZO0FBQ2xFLE1BQUksQ0FBQyxPQUFPLHNDQUFzQixDQUFDOztBQUVuQyxNQUFNLE1BQU0sR0FBRyw4QkFBTSxJQUFJLEVBQUU7QUFDekIsZUFBVyxFQUFFLFFBQVE7QUFDckIsZ0JBQVksRUFBRSxJQUFJO0FBQ2xCLHFCQUFpQixFQUFFLElBQUk7R0FDeEIsQ0FBQyxDQUFDLE1BQU0sQ0FBQzs7QUFFVixVQUFRLENBQUMsZ0JBQWdCLEVBQUUsWUFBWTs7O0FBQ3JDLFVBQU0sQ0FBQzs7Ozs7NkNBRUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUM7Ozs7Ozs7S0FDaEMsQ0FBQyxDQUFDO0FBQ0gsY0FBVSxDQUFDO2FBQU0saUNBQVksUUFBUSxFQUFFLE1BQU0sQ0FBQztLQUFBLENBQUMsQ0FBQzs7QUFFaEQsTUFBRSxDQUFDLDhDQUE4QyxFQUFFLFlBQU07QUFDdkQsYUFBTyxNQUFNLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLDJCQUEyQixDQUFDLENBQUM7S0FDM0YsQ0FBQyxDQUFDOzs7O0FBSUgsTUFBRSxDQUFDLHFEQUFxRCxFQUFFO1VBQ3BELEVBQUU7Ozs7OzZDQUFTLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLFdBQVcsQ0FBQzs7O0FBQWhELGNBQUU7OzZDQUNBLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDOzs7OzZDQUNoQiwrQkFBVSx5QkFBeUIsRUFBRSxNQUFNLENBQUM7Ozs7NkNBRTVDLHNCQUFFLEtBQUssQ0FBQyxJQUFJLENBQUM7Ozs7NkNBQ2IsTUFBTSxDQUFDLFdBQVcsRUFBRTs7Ozs2Q0FDcEIsc0JBQUUsS0FBSyxDQUFDLElBQUksQ0FBQzs7Ozs2Q0FDYiwrQkFBVSxtQkFBbUIsRUFBRSxNQUFNLENBQUM7Ozs7Ozs7S0FDN0MsQ0FBQyxDQUFDOztBQUVILE1BQUUsQ0FBQyx1Q0FBdUMsRUFBRTtVQUN0QyxJQUFJOzs7Ozs2Q0FBUyxNQUFNLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRSxhQUFhLENBQUM7OztBQUEzRCxnQkFBSTs7NkNBQ0YsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7Ozs7NkNBQ2xCLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLGdCQUFnQixDQUFDOzs7OzZDQUMxQyxNQUFNLENBQUMsSUFBSSxFQUFFOzs7OzZDQUNiLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLGdCQUFnQixDQUFDOzs7OzZDQUMxQyxNQUFNLENBQUMsT0FBTyxFQUFFOzs7OzZDQUNoQixNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxnQkFBZ0IsQ0FBQzs7Ozs7OztLQUNqRCxDQUFDLENBQUM7OztBQUdILE1BQUUsQ0FBQyw4RkFBOEYsRUFBRTtVQUM3RixJQUFJOzs7Ozs2Q0FBUyxNQUFNLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRSx3QkFBd0IsQ0FBQzs7O0FBQXRFLGdCQUFJOzs2Q0FDRixNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQzs7Ozs2Q0FDbEIsK0JBQVUseUJBQXlCLEVBQUUsTUFBTSxFQUFFLEVBQUUsQ0FBQzs7Ozs7OztLQUN2RCxDQUFDLENBQUM7R0FDSixDQUFDLENBQUM7Q0FDSixDQUFDLENBQUM7O0FBRUgsUUFBUSxtQ0FBaUMsd0JBQUksTUFBTSxvQ0FBaUMsWUFBWTs7O0FBQzlGLE1BQUksQ0FBQyxPQUFPLHNDQUFzQixDQUFDOztBQUVuQyxNQUFNLE1BQU0sR0FBRyw4QkFBTSxJQUFJLEVBQUU7QUFDekIsZUFBVyxFQUFFLFFBQVE7QUFDckIscUJBQWlCLEVBQUUsS0FBSztHQUN6QixDQUFDLENBQUMsTUFBTSxDQUFDOztBQUVWLFFBQU0sQ0FBQzs7Ozs7MkNBRUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUM7Ozs7Ozs7R0FDaEMsQ0FBQyxDQUFDO0FBQ0gsWUFBVSxDQUFDOzs7OzsyQ0FBa0IsaUNBQVksUUFBUSxFQUFFLE1BQU0sQ0FBQzs7Ozs7Ozs7OztHQUFBLENBQUMsQ0FBQzs7QUFFNUQsSUFBRSxDQUFDLDZDQUE2QyxFQUFFOzs7OzsyQ0FDMUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyw2Q0FBNkMsQ0FBQzs7OzsyQ0FDN0QsK0JBQVUseUJBQXlCLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLFFBQVE7Ozs7Ozs7R0FDcEYsQ0FBQyxDQUFDO0NBQ0osQ0FBQyxDQUFDIiwiZmlsZSI6InRlc3QvZTJlL3NhZmFyaS93aW5kb3dzLWZyYW1lLXNwZWNzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHNldHVwIGZyb20gJy4vc2FmYXJpLXNldHVwJztcbmltcG9ydCBlbnYgZnJvbSAnLi4vaGVscGVycy9lbnYnO1xuaW1wb3J0IHsgbG9hZFdlYlZpZXcsIHNwaW5UaXRsZSB9IGZyb20gXCIuLi9oZWxwZXJzL3dlYnZpZXdcIjtcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IE1PQ0hBX1NBRkFSSV9USU1FT1VUIH0gZnJvbSAnLi4vaGVscGVycy9zZXNzaW9uJztcblxuXG5kZXNjcmliZShgc2FmYXJpIC0gd2luZG93cyBhbmQgZnJhbWVzICgke2Vudi5ERVZJQ0V9KWAsIGZ1bmN0aW9uICgpIHtcbiAgdGhpcy50aW1lb3V0KE1PQ0hBX1NBRkFSSV9USU1FT1VUKTtcblxuICBjb25zdCBkcml2ZXIgPSBzZXR1cCh0aGlzLCB7XG4gICAgYnJvd3Nlck5hbWU6ICdzYWZhcmknLFxuICAgIG5hdGl2ZVdlYlRhcDogdHJ1ZSxcbiAgICBzYWZhcmlBbGxvd1BvcHVwczogdHJ1ZSxcbiAgfSkuZHJpdmVyO1xuXG4gIGRlc2NyaWJlKCd3aXRoaW4gd2VidmlldycsIGZ1bmN0aW9uICgpIHtcbiAgICBiZWZvcmUoYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gbWluaW1pemUgd2FpdGluZyBpZiBzb21ldGhpbmcgZ29lcyB3cm9uZ1xuICAgICAgYXdhaXQgZHJpdmVyLmltcGxpY2l0V2FpdCgxMDAwKTtcbiAgICB9KTtcbiAgICBiZWZvcmVFYWNoKCgpID0+IGxvYWRXZWJWaWV3KFwic2FmYXJpXCIsIGRyaXZlcikpO1xuXG4gICAgaXQoXCJzaG91bGQgdGhyb3cgbm9zdWNod2luZG93IGlmIHRoZXJlJ3Mgbm90IG9uZVwiLCAoKSA9PiB7XG4gICAgICByZXR1cm4gZHJpdmVyLnNldFdpbmRvdygnbm9leGlzdG1hbicpLnNob3VsZC5iZS5yZWplY3RlZFdpdGgoL3dpbmRvdyBjb3VsZCBub3QgYmUgZm91bmQvKTtcbiAgICB9KTtcblxuICAgIC8vIHVuZm9ydHVuYXRlbHksIGlPUzggZG9lc24ndCByZXNwb25kIHRvIHRoZSBjbG9zZSgpIG1ldGhvZCBvbiB3aW5kb3dcbiAgICAvLyB0aGUgd2F5IGlPUzcgZG9lc1xuICAgIGl0KFwic2hvdWxkIGJlIGFibGUgdG8gb3BlbiBhbmQgY2xvc2Ugd2luZG93cyBAc2tpcC1pb3M4XCIsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBlbCA9IGF3YWl0IGRyaXZlci5maW5kRWxlbWVudCgnaWQnLCAnYmxhbmtsaW5rJyk7XG4gICAgICBhd2FpdCBkcml2ZXIuY2xpY2soZWwpO1xuICAgICAgYXdhaXQgc3BpblRpdGxlKFwiSSBhbSBhbm90aGVyIHBhZ2UgdGl0bGVcIiwgZHJpdmVyKTtcblxuICAgICAgYXdhaXQgQi5kZWxheSgyMDAwKTtcbiAgICAgIGF3YWl0IGRyaXZlci5jbG9zZVdpbmRvdygpO1xuICAgICAgYXdhaXQgQi5kZWxheSgzMDAwKTtcbiAgICAgIGF3YWl0IHNwaW5UaXRsZShcIkkgYW0gYSBwYWdlIHRpdGxlXCIsIGRyaXZlcik7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGJlIGFibGUgdG8gZ28gYmFjayBhbmQgZm9yd2FyZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBsaW5rID0gYXdhaXQgZHJpdmVyLmZpbmRFbGVtZW50KCdsaW5rIHRleHQnLCAnaSBhbSBhIGxpbmsnKTtcbiAgICAgIGF3YWl0IGRyaXZlci5jbGljayhsaW5rKTtcbiAgICAgIGF3YWl0IGRyaXZlci5maW5kRWxlbWVudCgnaWQnLCAnb25seV9vbl9wYWdlXzInKTtcbiAgICAgIGF3YWl0IGRyaXZlci5iYWNrKCk7XG4gICAgICBhd2FpdCBkcml2ZXIuZmluZEVsZW1lbnQoJ2lkJywgJ2lfYW1fYV90ZXh0Ym94Jyk7XG4gICAgICBhd2FpdCBkcml2ZXIuZm9yd2FyZCgpO1xuICAgICAgYXdhaXQgZHJpdmVyLmZpbmRFbGVtZW50KCdpZCcsICdvbmx5X29uX3BhZ2VfMicpO1xuICAgIH0pO1xuXG4gICAgLy8gYnJva2VuIG9uIHJlYWwgZGV2aWNlcywgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy81MTY3XG4gICAgaXQoXCJzaG91bGQgYmUgYWJsZSB0byBvcGVuIGpzIHBvcHVwIHdpbmRvd3Mgd2l0aCBzYWZhcmlBbGxvd1BvcHVwcyBzZXQgdG8gdHJ1ZSBAc2tpcC1yZWFsLWRldmljZVwiLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgbGluayA9IGF3YWl0IGRyaXZlci5maW5kRWxlbWVudCgnbGluayB0ZXh0JywgJ2kgYW0gYSBuZXcgd2luZG93IGxpbmsnKTtcbiAgICAgIGF3YWl0IGRyaXZlci5jbGljayhsaW5rKTtcbiAgICAgIGF3YWl0IHNwaW5UaXRsZShcIkkgYW0gYW5vdGhlciBwYWdlIHRpdGxlXCIsIGRyaXZlciwgMzApO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuXG5kZXNjcmliZShgc2FmYXJpIC0gd2luZG93cyBhbmQgZnJhbWVzICgke2Vudi5ERVZJQ0V9KSAtIHdpdGhvdXQgc2FmYXJpQWxsb3dQb3B1cHNgLCBmdW5jdGlvbiAoKSB7XG4gIHRoaXMudGltZW91dChNT0NIQV9TQUZBUklfVElNRU9VVCk7XG5cbiAgY29uc3QgZHJpdmVyID0gc2V0dXAodGhpcywge1xuICAgIGJyb3dzZXJOYW1lOiAnc2FmYXJpJyxcbiAgICBzYWZhcmlBbGxvd1BvcHVwczogZmFsc2VcbiAgfSkuZHJpdmVyO1xuXG4gIGJlZm9yZShhc3luYyAoKSA9PiB7XG4gICAgLy8gbWluaW1pemUgd2FpdGluZyBpZiBzb21ldGhpbmcgZ29lcyB3cm9uZ1xuICAgIGF3YWl0IGRyaXZlci5pbXBsaWNpdFdhaXQoNTAwMCk7XG4gIH0pO1xuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IGF3YWl0IGxvYWRXZWJWaWV3KFwic2FmYXJpXCIsIGRyaXZlcikpO1xuXG4gIGl0KFwic2hvdWxkIG5vdCBiZSBhYmxlIHRvIG9wZW4ganMgcG9wdXAgd2luZG93c1wiLCBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgZHJpdmVyLmV4ZWN1dGUoXCJ3aW5kb3cub3BlbignL3Rlc3QvZ3VpbmVhLXBpZzIuaHRtbCcsIG51bGwpXCIpO1xuICAgIGF3YWl0IHNwaW5UaXRsZShcIkkgYW0gYW5vdGhlciBwYWdlIHRpdGxlXCIsIGRyaXZlciwgNSkuc2hvdWxkLmV2ZW50dWFsbHkuYmUucmVqZWN0ZWQ7XG4gIH0pO1xufSk7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uIn0=
