require('source-map-support').install();

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _this = this;

var _ = require('../..');

var _libDeviceLogIosLog = require('../../lib/device-log/ios-log');

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _appiumSupport = require('appium-support');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _libDeviceLogLogger = require('../../lib/device-log/logger');

var _libDeviceLogLogger2 = _interopRequireDefault(_libDeviceLogLogger);

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

var LOG_DIR = _path2['default'].resolve('test', 'assets', 'logs');

describe('system logs', function () {
  var tmpSystemLog = undefined;
  var sim = undefined;
  beforeEach(function callee$1$0() {
    var fixSystemLog;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          // get the simulator, and stub what will be called
          sim = {
            udid: 'fake-udid',
            getLogDir: function getLogDir() {},
            getPlatformVersion: function getPlatformVersion() {}
          };
          _sinon2['default'].stub(sim, 'getLogDir').returns(LOG_DIR);
          _sinon2['default'].stub(sim, 'getPlatformVersion').returns('8.4');

          // copy the file into a temporary location, so we can muck with it
          fixSystemLog = _path2['default'].resolve(LOG_DIR, 'system.log.fixture');

          tmpSystemLog = _path2['default'].resolve(LOG_DIR, 'system.log');
          context$2$0.next = 7;
          return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(fixSystemLog, tmpSystemLog));

        case 7:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  afterEach(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(tmpSystemLog));

        case 2:
          if (!context$2$0.sent) {
            context$2$0.next = 5;
            break;
          }

          context$2$0.next = 5;
          return _regeneratorRuntime.awrap(_appiumSupport.fs.unlink(tmpSystemLog));

        case 5:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('should begin log capture', function callee$1$0() {
    var log, spy, message;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          log = new _.IOSLog({ sim: sim, showLogs: true });
          spy = _sinon2['default'].spy(_libDeviceLogLogger2['default'], 'info');
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(log.startCapture());

        case 4:
          message = 'This is a test log line';
          context$2$0.next = 7;
          return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(tmpSystemLog, message + '\n', { flag: 'a' }));

        case 7:
          context$2$0.next = 9;
          return _regeneratorRuntime.awrap(_bluebird2['default'].delay(500));

        case 9:

          spy.calledWith('[IOS_SYSLOG_ROW] ' + message).should.be['true'];

          context$2$0.next = 12;
          return _regeneratorRuntime.awrap(log.stopCapture());

        case 12:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should rotate log buffer', function callee$1$0() {
    var maxBufferSize, sliceSizeLimit, logRecordsCount, log, recentLogs, i, previousRecentLogs, reminder, firstBufferMessage, lastBufferMessage;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          maxBufferSize = 10;
          sliceSizeLimit = maxBufferSize / 2;

          sliceSizeLimit.should.be.below(maxBufferSize);
          logRecordsCount = maxBufferSize * 2;

          logRecordsCount.should.be.above(maxBufferSize);

          log = new _.IOSLog({ sim: sim, showLogs: false });

          log.maxBufferSize = maxBufferSize;
          log.logIdxSinceLastRequest.should.be.below(0);
          context$2$0.next = 10;
          return _regeneratorRuntime.awrap(log.getLogs());

        case 10:
          recentLogs = context$2$0.sent;

          recentLogs.should.have.lengthOf(0);
          log.logIdxSinceLastRequest.should.be.below(0);

          i = 1;

        case 14:
          if (!(i <= logRecordsCount)) {
            context$2$0.next = 30;
            break;
          }

          log.logRow = i + '\n';
          log.onOutput();

          if (!(i >= sliceSizeLimit && i % sliceSizeLimit === 0)) {
            context$2$0.next = 26;
            break;
          }

          previousRecentLogs = recentLogs;
          context$2$0.next = 21;
          return _regeneratorRuntime.awrap(log.getLogs());

        case 21:
          recentLogs = context$2$0.sent;

          if (previousRecentLogs.length && recentLogs.length) {
            previousRecentLogs[0].message.should.not.be.equal(recentLogs[0].message);
          }
          recentLogs.should.have.lengthOf(sliceSizeLimit);
          reminder = log.logIdxSinceLastRequest % sliceSizeLimit;

          reminder.should.equal(0);

        case 26:
          log.logs.should.have.lengthOf(i < maxBufferSize ? i : maxBufferSize);

        case 27:
          ++i;
          context$2$0.next = 14;
          break;

        case 30:
          firstBufferMessage = parseInt(log.logs[0].message, 10);

          firstBufferMessage.should.be.equal(logRecordsCount - log.logs.length + 1);
          lastBufferMessage = parseInt(log.logs[log.logs.length - 1].message, 10);

          lastBufferMessage.should.be.equal(logRecordsCount);

        case 34:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  describe('real device logging', function () {
    function getLogger(realDeviceLogger) {
      var log = new _.IOSLog({ sim: sim, udid: '1234', realDeviceLogger: realDeviceLogger });
      log.finishStartingLogCapture = function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      };
      return log;
    }
    describe('idevicesyslog', function () {
      describe('system version', function () {
        var whichStub = undefined;
        afterEach(function () {
          whichStub.restore();
        });

        it('should use system idevicesyslog if no path specified', function callee$4$0() {
          var log;
          return _regeneratorRuntime.async(function callee$4$0$(context$5$0) {
            while (1) switch (context$5$0.prev = context$5$0.next) {
              case 0:
                whichStub = _sinon2['default'].stub(_appiumSupport.fs, 'which').returns('/path/to/idevicesyslog');
                log = getLogger('idevicesyslog');
                context$5$0.next = 4;
                return _regeneratorRuntime.awrap(log.startCapture());

              case 4:
                log.proc.cmd.should.eql('idevicesyslog');

              case 5:
              case 'end':
                return context$5$0.stop();
            }
          }, null, this);
        });
        it('should fail if no system idevicesyslog found', function callee$4$0() {
          var log;
          return _regeneratorRuntime.async(function callee$4$0$(context$5$0) {
            while (1) switch (context$5$0.prev = context$5$0.next) {
              case 0:
                whichStub = _sinon2['default'].stub(_appiumSupport.fs, 'which').throws(new Error('ENOENT'));
                log = getLogger('idevicesyslog');
                context$5$0.next = 4;
                return _regeneratorRuntime.awrap(log.startCapture().should.eventually.be.rejectedWith(/Unable to find system idevicesyslog/));

              case 4:
              case 'end':
                return context$5$0.stop();
            }
          }, null, this);
        });
      });
      describe('specific path', function () {
        var existstub = undefined;
        afterEach(function () {
          existstub.restore();
        });
        it('should use specified idevicesyslog if given', function callee$4$0() {
          var log;
          return _regeneratorRuntime.async(function callee$4$0$(context$5$0) {
            while (1) switch (context$5$0.prev = context$5$0.next) {
              case 0:
                existstub = _sinon2['default'].stub(_appiumSupport.fs, 'exists').returns(true);
                log = getLogger('/path/to/my/idevicesyslog');
                context$5$0.next = 4;
                return _regeneratorRuntime.awrap(log.startCapture());

              case 4:
                log.proc.cmd.should.eql('/path/to/my/idevicesyslog');

              case 5:
              case 'end':
                return context$5$0.stop();
            }
          }, null, this);
        });
        it('should fail if specified idevicesyslog is not found', function callee$4$0() {
          var log;
          return _regeneratorRuntime.async(function callee$4$0$(context$5$0) {
            while (1) switch (context$5$0.prev = context$5$0.next) {
              case 0:
                existstub = _sinon2['default'].stub(_appiumSupport.fs, 'exists').returns(false);
                log = getLogger('/path/to/my/idevicesyslog');
                context$5$0.next = 4;
                return _regeneratorRuntime.awrap(log.startCapture().should.eventually.be.rejectedWith(/Unable to find idevicesyslog from 'realDeviceLogger' capability/));

              case 4:
              case 'end':
                return context$5$0.stop();
            }
          }, null, this);
        });
      });
    });
    describe('deviceconsole', function () {
      var dcPath = '/path/to/deviceconsole/install/directory';
      var statStub = undefined;
      afterEach(function () {
        statStub.restore();
      });

      function initStatStub() {
        var directory = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];
        var throws = arguments.length <= 1 || arguments[1] === undefined ? false : arguments[1];

        statStub = _sinon2['default'].stub(_appiumSupport.fs, 'stat');
        if (throws) {
          statStub.throws(new Error('ENOENT'));
        } else {
          statStub.returns({
            isDirectory: function isDirectory() {
              return directory;
            }
          });
        }
      }

      it('should correctly parse the install directory from executable path', function callee$3$0() {
        var log;
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              initStatStub(false);
              log = getLogger(dcPath + '/deviceconsole');
              context$4$0.next = 4;
              return _regeneratorRuntime.awrap(log.startCapture());

            case 4:
              log.proc.cmd.should.eql(dcPath + '/deviceconsole');
              log.proc.opts.env.DYLD_LIBRARY_PATH.indexOf(dcPath).should.eql(0);

            case 6:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
      it('should correctly use the install directory when given directly', function callee$3$0() {
        var log;
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              initStatStub();
              log = getLogger(dcPath);
              context$4$0.next = 4;
              return _regeneratorRuntime.awrap(log.startCapture());

            case 4:
              log.proc.cmd.should.eql(dcPath + '/deviceconsole');
              log.proc.opts.env.DYLD_LIBRARY_PATH.indexOf(dcPath).should.eql(0);

            case 6:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
      it('should use default deviceconsole if path not passed in', function callee$3$0() {
        var log;
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              initStatStub();
              log = getLogger('deviceconsole');
              context$4$0.next = 4;
              return _regeneratorRuntime.awrap(log.startCapture());

            case 4:
              log.proc.cmd.should.eql(_libDeviceLogIosLog.DEVICE_CONSOLE_PATH + '/deviceconsole');
              log.proc.opts.env.DYLD_LIBRARY_PATH.indexOf(_libDeviceLogIosLog.DEVICE_CONSOLE_PATH).should.eql(0);

            case 6:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
      it('should fail if an executable other than deviceconsole is passed in', function callee$3$0() {
        var log;
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              initStatStub(false);
              log = getLogger(dcPath + '/someotherlogger');
              context$4$0.next = 4;
              return _regeneratorRuntime.awrap(log.startCapture().should.eventually.be.rejectedWith(/Unable to parse 'deviceconsole' installation directory/));

            case 4:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
      it('should fail if path passed in is not stat-able', function callee$3$0() {
        var log;
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              initStatStub(false, true);
              log = getLogger('/path/to/something/that/does/not/exist');
              context$4$0.next = 4;
              return _regeneratorRuntime.awrap(log.startCapture().should.eventually.be.rejectedWith(/Unknown 'realDeviceLogger'/));

            case 4:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
    });

    describe('anything else', function () {
      it('should fail if something other than idevicesyslog or deviceconsole are specified', function callee$3$0() {
        var log;
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              log = getLogger('mysupadupalogga');
              context$4$0.next = 3;
              return _regeneratorRuntime.awrap(log.startCapture().should.eventually.be.rejectedWith(/Unable to capture device log. Unknown 'realDeviceLogger'/));

            case 3:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
    });
  });
});

// on some slow system (e.g., Travis) need a moment
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdW5pdC9pb3MtbG9nLXNwZWNzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Z0JBRXVCLE9BQU87O2tDQUNNLDhCQUE4Qjs7cUJBQ2hELE9BQU87Ozs7NkJBQ04sZ0JBQWdCOztvQkFDbEIsTUFBTTs7OztrQ0FDSiw2QkFBNkI7Ozs7b0JBQy9CLE1BQU07Ozs7OEJBQ0ksa0JBQWtCOzs7O3dCQUMvQixVQUFVOzs7O0FBR3hCLGtCQUFLLE1BQU0sRUFBRSxDQUFDO0FBQ2Qsa0JBQUssR0FBRyw2QkFBZ0IsQ0FBQzs7QUFFekIsSUFBTSxPQUFPLEdBQUcsa0JBQUssT0FBTyxDQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUM7O0FBRXZELFFBQVEsQ0FBQyxhQUFhLEVBQUUsWUFBTTtBQUM1QixNQUFJLFlBQVksWUFBQSxDQUFDO0FBQ2pCLE1BQUksR0FBRyxZQUFBLENBQUM7QUFDUixZQUFVLENBQUM7UUFXTCxZQUFZOzs7OztBQVRoQixhQUFHLEdBQUc7QUFDSixnQkFBSSxFQUFFLFdBQVc7QUFDakIscUJBQVMsRUFBRSxxQkFBTSxFQUFFO0FBQ25CLDhCQUFrQixFQUFFLDhCQUFNLEVBQUU7V0FDN0IsQ0FBQztBQUNGLDZCQUFNLElBQUksQ0FBQyxHQUFHLEVBQUUsV0FBVyxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzlDLDZCQUFNLElBQUksQ0FBQyxHQUFHLEVBQUUsb0JBQW9CLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7OztBQUdqRCxzQkFBWSxHQUFHLGtCQUFLLE9BQU8sQ0FBQyxPQUFPLEVBQUUsb0JBQW9CLENBQUM7O0FBQzlELHNCQUFZLEdBQUcsa0JBQUssT0FBTyxDQUFDLE9BQU8sRUFBRSxZQUFZLENBQUMsQ0FBQzs7MkNBQzdDLGtCQUFHLFFBQVEsQ0FBQyxZQUFZLEVBQUUsWUFBWSxDQUFDOzs7Ozs7O0dBQzlDLENBQUMsQ0FBQztBQUNILFdB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IjpbIi8vIHRyYW5zcGlsZTptb2NoYVxuXG5pbXBvcnQgeyBJT1NMb2cgfSBmcm9tICcuLi8uLic7XG5pbXBvcnQgeyBERVZJQ0VfQ09OU09MRV9QQVRIIH0gZnJvbSAnLi4vLi4vbGliL2RldmljZS1sb2cvaW9zLWxvZyc7XG5pbXBvcnQgc2lub24gZnJvbSAnc2lub24nO1xuaW1wb3J0IHsgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi4vLi4vbGliL2RldmljZS1sb2cvbG9nZ2VyJztcbmltcG9ydCBjaGFpIGZyb20gJ2NoYWknO1xuaW1wb3J0IGNoYWlBc1Byb21pc2VkIGZyb20gJ2NoYWktYXMtcHJvbWlzZWQnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuXG5cbmNoYWkuc2hvdWxkKCk7XG5jaGFpLnVzZShjaGFpQXNQcm9taXNlZCk7XG5cbmNvbnN0IExPR19ESVIgPSBwYXRoLnJlc29sdmUoJ3Rlc3QnLCAnYXNzZXRzJywgJ2xvZ3MnKTtcblxuZGVzY3JpYmUoJ3N5c3RlbSBsb2dzJywgKCkgPT4ge1xuICBsZXQgdG1wU3lzdGVtTG9nO1xuICBsZXQgc2ltO1xuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICAvLyBnZXQgdGhlIHNpbXVsYXRvciwgYW5kIHN0dWIgd2hhdCB3aWxsIGJlIGNhbGxlZFxuICAgIHNpbSA9IHtcbiAgICAgIHVkaWQ6ICdmYWtlLXVkaWQnLFxuICAgICAgZ2V0TG9nRGlyOiAoKSA9PiB7fSxcbiAgICAgIGdldFBsYXRmb3JtVmVyc2lvbjogKCkgPT4ge31cbiAgICB9O1xuICAgIHNpbm9uLnN0dWIoc2ltLCAnZ2V0TG9nRGlyJykucmV0dXJucyhMT0dfRElSKTtcbiAgICBzaW5vbi5zdHViKHNpbSwgJ2dldFBsYXRmb3JtVmVyc2lvbicpLnJldHVybnMoJzguNCcpO1xuXG4gICAgLy8gY29weSB0aGUgZmlsZSBpbnRvIGEgdGVtcG9yYXJ5IGxvY2F0aW9uLCBzbyB3ZSBjYW4gbXVjayB3aXRoIGl0XG4gICAgbGV0IGZpeFN5c3RlbUxvZyA9IHBhdGgucmVzb2x2ZShMT0dfRElSLCAnc3lzdGVtLmxvZy5maXh0dXJlJyk7XG4gICAgdG1wU3lzdGVtTG9nID0gcGF0aC5yZXNvbHZlKExPR19ESVIsICdzeXN0ZW0ubG9nJyk7XG4gICAgYXdhaXQgZnMuY29weUZpbGUoZml4U3lzdGVtTG9nLCB0bXBTeXN0ZW1Mb2cpO1xuICB9KTtcbiAgYWZ0ZXJFYWNoKGFzeW5jICgpID0+IHtcbiAgICBpZiAoYXdhaXQgZnMuZXhpc3RzKHRtcFN5c3RlbUxvZykpIHtcbiAgICAgIGF3YWl0IGZzLnVubGluayh0bXBTeXN0ZW1Mb2cpO1xuICAgIH1cbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBiZWdpbiBsb2cgY2FwdHVyZScsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgbG9nID0gbmV3IElPU0xvZyh7c2ltLCBzaG93TG9nczogdHJ1ZX0pO1xuICAgIGxldCBzcHkgPSBzaW5vbi5zcHkobG9nZ2VyLCAnaW5mbycpO1xuXG4gICAgYXdhaXQgbG9nLnN0YXJ0Q2FwdHVyZSgpO1xuXG4gICAgbGV0IG1lc3NhZ2UgPSAnVGhpcyBpcyBhIHRlc3QgbG9nIGxpbmUnO1xuICAgIGF3YWl0IGZzLndyaXRlRmlsZSh0bXBTeXN0ZW1Mb2csIGAke21lc3NhZ2V9XFxuYCwge2ZsYWc6ICdhJ30pO1xuXG4gICAgLy8gb24gc29tZSBzbG93IHN5c3RlbSAoZS5nLiwgVHJhdmlzKSBuZWVkIGEgbW9tZW50XG4gICAgYXdhaXQgQi5kZWxheSg1MDApO1xuXG4gICAgc3B5LmNhbGxlZFdpdGgoYFtJT1NfU1lTTE9HX1JPV10gJHttZXNzYWdlfWApLnNob3VsZC5iZS50cnVlO1xuXG4gICAgYXdhaXQgbG9nLnN0b3BDYXB0dXJlKCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgcm90YXRlIGxvZyBidWZmZXInLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgY29uc3QgbWF4QnVmZmVyU2l6ZSA9IDEwO1xuICAgIGNvbnN0IHNsaWNlU2l6ZUxpbWl0ID0gbWF4QnVmZmVyU2l6ZSAvIDI7XG4gICAgc2xpY2VTaXplTGltaXQuc2hvdWxkLmJlLmJlbG93KG1heEJ1ZmZlclNpemUpO1xuICAgIGNvbnN0IGxvZ1JlY29yZHNDb3VudCA9IG1heEJ1ZmZlclNpemUgKiAyO1xuICAgIGxvZ1JlY29yZHNDb3VudC5zaG91bGQuYmUuYWJvdmUobWF4QnVmZmVyU2l6ZSk7XG5cbiAgICBsZXQgbG9nID0gbmV3IElPU0xvZyh7c2ltLCBzaG93TG9nczogZmFsc2V9KTtcbiAgICBsb2cubWF4QnVmZmVyU2l6ZSA9IG1heEJ1ZmZlclNpemU7XG4gICAgbG9nLmxvZ0lkeFNpbmNlTGFzdFJlcXVlc3Quc2hvdWxkLmJlLmJlbG93KDApO1xuICAgIGxldCByZWNlbnRMb2dzID0gYXdhaXQgbG9nLmdldExvZ3MoKTtcbiAgICByZWNlbnRMb2dzLnNob3VsZC5oYXZlLmxlbmd0aE9mKDApO1xuICAgIGxvZy5sb2dJZHhTaW5jZUxhc3RSZXF1ZXN0LnNob3VsZC5iZS5iZWxvdygwKTtcblxuICAgIGZvciAobGV0IGkgPSAxOyBpIDw9IGxvZ1JlY29yZHNDb3VudDsgKytpKSB7XG4gICAgICBsb2cubG9nUm93ID0gYCR7aX1cXG5gO1xuICAgICAgbG9nLm9uT3V0cHV0KCk7XG4gICAgICBpZiAoaSA+PSBzbGljZVNpemVMaW1pdCAmJiBpICUgc2xpY2VTaXplTGltaXQgPT09IDApIHtcbiAgICAgICAgbGV0IHByZXZpb3VzUmVjZW50TG9ncyA9IHJlY2VudExvZ3M7XG4gICAgICAgIHJlY2VudExvZ3MgPSBhd2FpdCBsb2cuZ2V0TG9ncygpO1xuICAgICAgICBpZiAocHJldmlvdXNSZWNlbnRMb2dzLmxlbmd0aCAmJiByZWNlbnRMb2dzLmxlbmd0aCkge1xuICAgICAgICAgIHByZXZpb3VzUmVjZW50TG9nc1swXS5tZXNzYWdlLnNob3VsZC5ub3QuYmUuZXF1YWwocmVjZW50TG9nc1swXS5tZXNzYWdlKTtcbiAgICAgICAgfVxuICAgICAgICByZWNlbnRMb2dzLnNob3VsZC5oYXZlLmxlbmd0aE9mKHNsaWNlU2l6ZUxpbWl0KTtcbiAgICAgICAgbGV0IHJlbWluZGVyID0gbG9nLmxvZ0lkeFNpbmNlTGFzdFJlcXVlc3QgJSBzbGljZVNpemVMaW1pdDtcbiAgICAgICAgcmVtaW5kZXIuc2hvdWxkLmVxdWFsKDApO1xuICAgICAgfVxuICAgICAgbG9nLmxvZ3Muc2hvdWxkLmhhdmUubGVuZ3RoT2YoaSA8IG1heEJ1ZmZlclNpemUgPyBpIDogbWF4QnVmZmVyU2l6ZSk7XG4gICAgfVxuXG4gICAgY29uc3QgZmlyc3RCdWZmZXJNZXNzYWdlID0gcGFyc2VJbnQobG9nLmxvZ3NbMF0ubWVzc2FnZSwgMTApO1xuICAgIGZpcnN0QnVmZmVyTWVzc2FnZS5zaG91bGQuYmUuZXF1YWwobG9nUmVjb3Jkc0NvdW50IC0gbG9nLmxvZ3MubGVuZ3RoICsgMSk7XG4gICAgY29uc3QgbGFzdEJ1ZmZlck1lc3NhZ2UgPSBwYXJzZUludChsb2cubG9nc1tsb2cubG9ncy5sZW5ndGggLSAxXS5tZXNzYWdlLCAxMCk7XG4gICAgbGFzdEJ1ZmZlck1lc3NhZ2Uuc2hvdWxkLmJlLmVxdWFsKGxvZ1JlY29yZHNDb3VudCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdyZWFsIGRldmljZSBsb2dnaW5nJywgZnVuY3Rpb24gKCkge1xuICAgIGZ1bmN0aW9uIGdldExvZ2dlciAocmVhbERldmljZUxvZ2dlcikge1xuICAgICAgbGV0IGxvZyA9IG5ldyBJT1NMb2coe3NpbSwgdWRpZDogJzEyMzQnLCByZWFsRGV2aWNlTG9nZ2VyfSk7XG4gICAgICBsb2cuZmluaXNoU3RhcnRpbmdMb2dDYXB0dXJlID0gYXN5bmMgZnVuY3Rpb24gKCkge307XG4gICAgICByZXR1cm4gbG9nO1xuICAgIH1cbiAgICBkZXNjcmliZSgnaWRldmljZXN5c2xvZycsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGRlc2NyaWJlKCdzeXN0ZW0gdmVyc2lvbicsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgbGV0IHdoaWNoU3R1YjtcbiAgICAgICAgYWZ0ZXJFYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICB3aGljaFN0dWIucmVzdG9yZSgpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIHVzZSBzeXN0ZW0gaWRldmljZXN5c2xvZyBpZiBubyBwYXRoIHNwZWNpZmllZCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICB3aGljaFN0dWIgPSBzaW5vbi5zdHViKGZzLCAnd2hpY2gnKS5yZXR1cm5zKCcvcGF0aC90by9pZGV2aWNlc3lzbG9nJyk7XG4gICAgICAgICAgbGV0IGxvZyA9IGdldExvZ2dlcignaWRldmljZXN5c2xvZycpO1xuICAgICAgICAgIGF3YWl0IGxvZy5zdGFydENhcHR1cmUoKTtcbiAgICAgICAgICBsb2cucHJvYy5jbWQuc2hvdWxkLmVxbCgnaWRldmljZXN5c2xvZycpO1xuICAgICAgICB9KTtcbiAgICAgICAgaXQoJ3Nob3VsZCBmYWlsIGlmIG5vIHN5c3RlbSBpZGV2aWNlc3lzbG9nIGZvdW5kJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIHdoaWNoU3R1YiA9IHNpbm9uLnN0dWIoZnMsICd3aGljaCcpLnRocm93cyhuZXcgRXJyb3IoJ0VOT0VOVCcpKTtcbiAgICAgICAgICBsZXQgbG9nID0gZ2V0TG9nZ2VyKCdpZGV2aWNlc3lzbG9nJyk7XG4gICAgICAgICAgYXdhaXQgbG9nLnN0YXJ0Q2FwdHVyZSgpLnNob3VsZC5ldmVudHVhbGx5LmJlLnJlamVjdGVkV2l0aCgvVW5hYmxlIHRvIGZpbmQgc3lzdGVtIGlkZXZpY2VzeXNsb2cvKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICAgIGRlc2NyaWJlKCdzcGVjaWZpYyBwYXRoJywgZnVuY3Rpb24gKCkge1xuICAgICAgICBsZXQgZXhpc3RzdHViO1xuICAgICAgICBhZnRlckVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGV4aXN0c3R1Yi5yZXN0b3JlKCk7XG4gICAgICAgIH0pO1xuICAgICAgICBpdCgnc2hvdWxkIHVzZSBzcGVjaWZpZWQgaWRldmljZXN5c2xvZyBpZiBnaXZlbicsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBleGlzdHN0dWIgPSBzaW5vbi5zdHViKGZzLCAnZXhpc3RzJykucmV0dXJucyh0cnVlKTtcbiAgICAgICAgICBsZXQgbG9nID0gZ2V0TG9nZ2VyKCcvcGF0aC90by9teS9pZGV2aWNlc3lzbG9nJyk7XG4gICAgICAgICAgYXdhaXQgbG9nLnN0YXJ0Q2FwdHVyZSgpO1xuICAgICAgICAgIGxvZy5wcm9jLmNtZC5zaG91bGQuZXFsKCcvcGF0aC90by9teS9pZGV2aWNlc3lzbG9nJyk7XG4gICAgICAgIH0pO1xuICAgICAgICBpdCgnc2hvdWxkIGZhaWwgaWYgc3BlY2lmaWVkIGlkZXZpY2VzeXNsb2cgaXMgbm90IGZvdW5kJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGV4aXN0c3R1YiA9IHNpbm9uLnN0dWIoZnMsICdleGlzdHMnKS5yZXR1cm5zKGZhbHNlKTtcbiAgICAgICAgICBsZXQgbG9nID0gZ2V0TG9nZ2VyKCcvcGF0aC90by9teS9pZGV2aWNlc3lzbG9nJyk7XG4gICAgICAgICAgYXdhaXQgbG9nLnN0YXJ0Q2FwdHVyZSgpLnNob3VsZC5ldmVudHVhbGx5LmJlLnJlamVjdGVkV2l0aCgvVW5hYmxlIHRvIGZpbmQgaWRldmljZXN5c2xvZyBmcm9tICdyZWFsRGV2aWNlTG9nZ2VyJyBjYXBhYmlsaXR5Lyk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gICAgZGVzY3JpYmUoJ2RldmljZWNvbnNvbGUnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgZGNQYXRoID0gJy9wYXRoL3RvL2RldmljZWNvbnNvbGUvaW5zdGFsbC9kaXJlY3RvcnknO1xuICAgICAgbGV0IHN0YXRTdHViO1xuICAgICAgYWZ0ZXJFYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgc3RhdFN0dWIucmVzdG9yZSgpO1xuICAgICAgfSk7XG5cbiAgICAgIGZ1bmN0aW9uIGluaXRTdGF0U3R1YiAoZGlyZWN0b3J5ID0gdHJ1ZSwgdGhyb3dzID0gZmFsc2UpIHtcbiAgICAgICAgc3RhdFN0dWIgPSBzaW5vbi5zdHViKGZzLCAnc3RhdCcpO1xuICAgICAgICBpZiAodGhyb3dzKSB7XG4gICAgICAgICAgc3RhdFN0dWIudGhyb3dzKG5ldyBFcnJvcignRU5PRU5UJykpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHN0YXRTdHViLnJldHVybnMoe1xuICAgICAgICAgICAgaXNEaXJlY3RvcnkgKCkge1xuICAgICAgICAgICAgICByZXR1cm4gZGlyZWN0b3J5O1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGl0KCdzaG91bGQgY29ycmVjdGx5IHBhcnNlIHRoZSBpbnN0YWxsIGRpcmVjdG9yeSBmcm9tIGV4ZWN1dGFibGUgcGF0aCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaW5pdFN0YXRTdHViKGZhbHNlKTtcbiAgICAgICAgbGV0IGxvZyA9IGdldExvZ2dlcihgJHtkY1BhdGh9L2RldmljZWNvbnNvbGVgKTtcbiAgICAgICAgYXdhaXQgbG9nLnN0YXJ0Q2FwdHVyZSgpO1xuICAgICAgICBsb2cucHJvYy5jbWQuc2hvdWxkLmVxbChgJHtkY1BhdGh9L2RldmljZWNvbnNvbGVgKTtcbiAgICAgICAgbG9nLnByb2Mub3B0cy5lbnYuRFlMRF9MSUJSQVJZX1BBVEguaW5kZXhPZihkY1BhdGgpLnNob3VsZC5lcWwoMCk7XG4gICAgICB9KTtcbiAgICAgIGl0KCdzaG91bGQgY29ycmVjdGx5IHVzZSB0aGUgaW5zdGFsbCBkaXJlY3Rvcnkgd2hlbiBnaXZlbiBkaXJlY3RseScsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaW5pdFN0YXRTdHViKCk7XG4gICAgICAgIGxldCBsb2cgPSBnZXRMb2dnZXIoZGNQYXRoKTtcbiAgICAgICAgYXdhaXQgbG9nLnN0YXJ0Q2FwdHVyZSgpO1xuICAgICAgICBsb2cucHJvYy5jbWQuc2hvdWxkLmVxbChgJHtkY1BhdGh9L2RldmljZWNvbnNvbGVgKTtcbiAgICAgICAgbG9nLnByb2Mub3B0cy5lbnYuRFlMRF9MSUJSQVJZX1BBVEguaW5kZXhPZihkY1BhdGgpLnNob3VsZC5lcWwoMCk7XG4gICAgICB9KTtcbiAgICAgIGl0KCdzaG91bGQgdXNlIGRlZmF1bHQgZGV2aWNlY29uc29sZSBpZiBwYXRoIG5vdCBwYXNzZWQgaW4nLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGluaXRTdGF0U3R1YigpO1xuICAgICAgICBsZXQgbG9nID0gZ2V0TG9nZ2VyKGBkZXZpY2Vjb25zb2xlYCk7XG4gICAgICAgIGF3YWl0IGxvZy5zdGFydENhcHR1cmUoKTtcbiAgICAgICAgbG9nLnByb2MuY21kLnNob3VsZC5lcWwoYCR7REVWSUNFX0NPTlNPTEVfUEFUSH0vZGV2aWNlY29uc29sZWApO1xuICAgICAgICBsb2cucHJvYy5vcHRzLmVudi5EWUxEX0xJQlJBUllfUEFUSC5pbmRleE9mKERFVklDRV9DT05TT0xFX1BBVEgpLnNob3VsZC5lcWwoMCk7XG4gICAgICB9KTtcbiAgICAgIGl0KCdzaG91bGQgZmFpbCBpZiBhbiBleGVjdXRhYmxlIG90aGVyIHRoYW4gZGV2aWNlY29uc29sZSBpcyBwYXNzZWQgaW4nLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGluaXRTdGF0U3R1YihmYWxzZSk7XG4gICAgICAgIGxldCBsb2cgPSBnZXRMb2dnZXIoYCR7ZGNQYXRofS9zb21lb3RoZXJsb2dnZXJgKTtcbiAgICAgICAgYXdhaXQgbG9nLnN0YXJ0Q2FwdHVyZSgpLnNob3VsZC5ldmVudHVhbGx5LmJlLnJlamVjdGVkV2l0aCgvVW5hYmxlIHRvIHBhcnNlICdkZXZpY2Vjb25zb2xlJyBpbnN0YWxsYXRpb24gZGlyZWN0b3J5Lyk7XG4gICAgICB9KTtcbiAgICAgIGl0KCdzaG91bGQgZmFpbCBpZiBwYXRoIHBhc3NlZCBpbiBpcyBub3Qgc3RhdC1hYmxlJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICBpbml0U3RhdFN0dWIoZmFsc2UsIHRydWUpO1xuICAgICAgICBsZXQgbG9nID0gZ2V0TG9nZ2VyKGAvcGF0aC90by9zb21ldGhpbmcvdGhhdC9kb2VzL25vdC9leGlzdGApO1xuICAgICAgICBhd2FpdCBsb2cuc3RhcnRDYXB0dXJlKCkuc2hvdWxkLmV2ZW50dWFsbHkuYmUucmVqZWN0ZWRXaXRoKC9Vbmtub3duICdyZWFsRGV2aWNlTG9nZ2VyJy8pO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnYW55dGhpbmcgZWxzZScsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGl0KCdzaG91bGQgZmFpbCBpZiBzb21ldGhpbmcgb3RoZXIgdGhhbiBpZGV2aWNlc3lzbG9nIG9yIGRldmljZWNvbnNvbGUgYXJlIHNwZWNpZmllZCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgbGV0IGxvZyA9IGdldExvZ2dlcignbXlzdXBhZHVwYWxvZ2dhJyk7XG4gICAgICAgIGF3YWl0IGxvZy5zdGFydENhcHR1cmUoKS5zaG91bGQuZXZlbnR1YWxseS5iZS5yZWplY3RlZFdpdGgoL1VuYWJsZSB0byBjYXB0dXJlIGRldmljZSBsb2cuIFVua25vd24gJ3JlYWxEZXZpY2VMb2dnZXInLyk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
