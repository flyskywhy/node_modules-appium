'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _js2xmlparser2 = require("js2xmlparser2");

var _js2xmlparser22 = _interopRequireDefault(_js2xmlparser2);

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumSupport = require('appium-support');

var _teen_process = require('teen_process');

var _utils = require('../utils');

var _utils2 = _interopRequireDefault(_utils);

var _nodeSimctl = require('node-simctl');

var commands = {},
    helpers = {},
    extensions = {};

commands.active = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 6;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.executeAtom('active_element', []));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand("au.getActiveElement()"));

      case 8:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getDeviceTime = function callee$0$0() {
  var idevicedate, _ref, stdout, date;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].info('Attempting to capture iOS device date and time');

        if (!this.isRealDevice()) {
          context$1$0.next = 28;
          break;
        }

        context$1$0.prev = 2;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.which('idevicedate'));

      case 5:
        idevicedate = context$1$0.sent;

        _logger2['default'].info('Found idevicedate: \'' + idevicedate + '\'');
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(idevicedate, ['-u', this.opts.udid]));

      case 9:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;

        stdout = stdout.trim();
        context$1$0.prev = 12;
        date = new Date(stdout);
        return context$1$0.abrupt('return', date.toString());

      case 17:
        context$1$0.prev = 17;
        context$1$0.t0 = context$1$0['catch'](12);

        // sometimes `idevicedate` returns an un-parsable format
        // in which case, we just want to return the output and
        // let the client deal with it
        _logger2['default'].debug('Unable to parse date \'' + stdout + '\'. Returning as is');
        return context$1$0.abrupt('return', stdout);

      case 21:
        context$1$0.next = 26;
        break;

      case 23:
        context$1$0.prev = 23;
        context$1$0.t1 = context$1$0['catch'](2);

        _logger2['default'].errorAndThrow('Could not capture device date and time using libimobiledevice idevicedate. ' + 'Libimobiledevice is probably not installed');

      case 26:
        context$1$0.next = 30;
        break;

      case 28:
        _logger2['default'].warn('On simulator. Assuming device time is the same as host time');
        return context$1$0.abrupt('return', new Date().toString());

      case 30:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[2, 23], [12, 17]]);
};

commands.hideKeyboard = function callee$0$0(strategy) {
  for (var _len = arguments.length, possibleKeys = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
    possibleKeys[_key - 1] = arguments[_key];
  }

  var cmd, key;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        possibleKeys.pop(); // last parameter is the session id
        cmd = undefined;
        key = _lodash2['default'].find(possibleKeys, function (k) {
          return k;
        });

        if (key) {
          strategy = strategy || 'pressKey';
          cmd = 'au.hideKeyboard(\'' + strategy + '\', \'' + key + '\')';
        } else {
          strategy = strategy || 'default';
          cmd = 'au.hideKeyboard(\'' + strategy + '\')';
        }
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(cmd));

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getPageSource = function callee$0$0() {
  var cmd;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 7;
          break;
        }

        cmd = 'document.getElementsByTagName("html")[0].outerHTML';
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.remote.execute(cmd));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 7:
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.getNativePageSource());

      case 9:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.getNativePageSource = function callee$0$0() {
  var jsonSource, xmlSource;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.getSourceForElementForXML());

      case 2:
        jsonSource = context$1$0.sent;

        if (typeof jsonSource === "string") {
          jsonSource = JSON.parse(jsonSource);
        }
        xmlSource = (0, _js2xmlparser22['default'])("AppiumAUT", jsonSource, {
          wrapArray: { enabled: false, elementName: "element" },
          declaration: { include: true },
          prettyPrinting: { indentString: "    " }
        });
        return context$1$0.abrupt('return', xmlSource);

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.background = function callee$0$0(secs) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.background(' + secs + ')'));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.lock = function callee$0$0(secs) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!secs) {
          _logger2['default'].debug('No seconds parameter. Using 0 seconds');
          secs = 0;
        }
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.lock(' + secs + ')'));

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.closeApp = function callee$0$0() {
  var appName;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        appName = this.opts.app || this.opts.bundleId;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.stop());

      case 4:
        _logger2['default'].info('Successfully closed the \'' + appName + '\' app.');
        context$1$0.next = 11;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].warn('Something went wrong while closing the \'' + appName + '\' app.');
        throw context$1$0.t0;

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7]]);
};

commands.launchApp = function callee$0$0() {
  var appName;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        appName = this.opts.app || this.opts.bundleId;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.start());

      case 4:
        _logger2['default'].info('Successfully launched the \'' + appName + '\' app.');
        context$1$0.next = 11;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].warn('Something went wrong while launching the \'' + appName + '\' app.');
        throw context$1$0.t0;

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7]]);
};

commands.removeApp = function callee$0$0(bundleId) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isRealDevice()) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.realDevice.remove(bundleId));

      case 3:
        context$1$0.next = 7;
        break;

      case 5:
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.sim.removeApp(bundleId));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.keys = function callee$0$0(keys) {
  var el, command;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 10;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.active());

      case 3:
        el = context$1$0.sent;

        if (!_lodash2['default'].isUndefined(el.ELEMENT)) {
          context$1$0.next = 6;
          break;
        }

        throw new _appiumBaseDriver.errors.NoSuchElementError();

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.setValue(keys, el.ELEMENT));

      case 8:
        context$1$0.next = 16;
        break;

      case 10:
        if (_lodash2['default'].isArray(keys)) {
          keys = keys.join('');
        }
        if (!_lodash2['default'].isString(keys)) {
          keys = keys.toString();
        }
        keys = _appiumSupport.util.escapeSpecialChars(keys, "'");
        command = 'au.sendKeysToActiveElement(\'' + keys + '\')';
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setGeoLocation = function callee$0$0(location) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('target.setLocation(' + JSON.stringify(location) + ')'));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

//}
commands.getWindowSize = function callee$0$0() {
  var windowHandle = arguments.length <= 0 || arguments[0] === undefined ? "current" : arguments[0];
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(windowHandle !== "current")) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotYetImplementedError("Currently only getting current window size is supported.");

      case 2:
        if (!this.isWebContext()) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.executeAtom('get_window_size', []));

      case 5:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 8:
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand("au.getWindowSize()"));

      case 10:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getStrings = function callee$0$0(language) {
  var stringFile = arguments.length <= 1 || arguments[1] === undefined ? null : arguments[1];
  var strings;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Gettings strings for language \'' + language + '\' and string file \'' + stringFile + '\'');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_utils2['default'].parseLocalizableStrings(_lodash2['default'].defaults({ language: language, stringFile: stringFile }, this.opts)));

      case 3:
        strings = context$1$0.sent;

        if (strings && strings.length >= 1) {
          strings = strings[0];
        }
        return context$1$0.abrupt('return', strings);

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setUrl = function callee$0$0(url) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Attempting to set url \'' + url + '\'');

        if (this.isWebContext()) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap((0, _nodeSimctl.openUrl)(this.opts.udid || this.sim.udid, url));

      case 4:
        return context$1$0.abrupt('return');

      case 5:
        this.setCurrentUrl(url);
        // make sure to clear out any leftover web frames
        this.curWebFrames = [];
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.remote.navToUrl(url));

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;

// TODO: check the hasOptions bit, the method signature should be location, option

//let hasOptions = altitude !== null || horizontalAccuracy !== null || verticalAccuracy !== null || course !== null || speed !== null;
//if (hasOptions) {
//let options = {};
//if (altitude !== null) {
//options.altitude = altitude;
//}
//if (horizontalAccuracy !== null) {
//options.horizontalAccuracy = horizontalAccuracy;
//}
//if (verticalAccuracy !== null) {
//options.verticalAccuracy = verticalAccuracy;
//}
//if (course !== null) {
//options.course = course;
//}
//if (speed !== null) {
//options.speed = speed;
//}
//await this.uiAutoClient.sendCommand(
//`target.setLocationWithOptions(${JSON.stringify(coordinates)}, ${JSON.stringify(options)})`);
//} else {
// use xcrun to open deeplink
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztnQ0FBdUIsb0JBQW9COztzQkFDN0IsUUFBUTs7Ozs2QkFDSCxlQUFlOzs7O3NCQUNsQixXQUFXOzs7OzZCQUNGLGdCQUFnQjs7NEJBQ3BCLGNBQWM7O3FCQUNqQixVQUFVOzs7OzBCQUNKLGFBQWE7O0FBRXJDLElBQUksUUFBUSxHQUFHLEVBQUU7SUFBRSxPQUFPLEdBQUcsRUFBRTtJQUFFLFVBQVUsR0FBRyxFQUFFLENBQUM7O0FBRWpELFFBQVEsQ0FBQyxNQUFNLEdBQUc7Ozs7YUFDWixJQUFJLENBQUMsWUFBWSxFQUFFOzs7Ozs7eUNBQ1IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLENBQUM7Ozs7Ozs7eUNBRXRDLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLHVCQUF1QixDQUFDOzs7Ozs7Ozs7O0NBRXRFLENBQUM7O0FBRUYsUUFBUSxDQUFDLGFBQWEsR0FBRztNQUlmLFdBQVcsUUFFVixNQUFNLEVBR0wsSUFBSTs7Ozs7QUFSZCw0QkFBSSxJQUFJLENBQUMsZ0RBQWdELENBQUMsQ0FBQzs7YUFDdkQsSUFBSSxDQUFDLFlBQVksRUFBRTs7Ozs7Ozt5Q0FFSyxrQkFBRyxLQUFLLENBQUMsYUFBYSxDQUFDOzs7QUFBM0MsbUJBQVc7O0FBQ2YsNEJBQUksSUFBSSwyQkFBd0IsV0FBVyxRQUFJLENBQUM7O3lDQUMzQix3QkFBSyxXQUFXLEVBQUUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzs7OztBQUF6RCxjQUFNLFFBQU4sTUFBTTs7QUFDWCxjQUFNLEdBQUcsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDOztBQUVqQixZQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDOzRDQUNwQixJQUFJLENBQUMsUUFBUSxFQUFFOzs7Ozs7Ozs7QUFLdEIsNEJBQUksS0FB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T0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3RCOzRDQUNNLE9BQU87Ozs7Ozs7Q0FDZixDQUFDOztBQUVGLFFBQVEsQ0FBQyxNQUFNLEdBQUcsb0JBQWdCLEdBQUc7Ozs7QUFDbkMsNEJBQUksS0FBSyw4QkFBMkIsR0FBRyxRQUFJLENBQUM7O1lBQ3ZDLElBQUksQ0FBQyxZQUFZLEVBQUU7Ozs7Ozt5Q0FFaEIseUJBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDOzs7Ozs7QUFHckQsWUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQzs7QUFFeEIsWUFBSSxDQUFDLFlBQVksR0FBRyxFQUFFLENBQUM7O3lDQUNqQixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUM7Ozs7Ozs7Q0FDaEMsQ0FBQzs7QUFHRixlQUFjLFVBQVUsRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDcEMsUUFBUSxHQUFSLFFBQVE7UUFBRSxPQUFPLEdBQVAsT0FBTztxQkFDWCxVQUFVIiwiZmlsZSI6ImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQganMyeG1sIGZyb20gXCJqczJ4bWxwYXJzZXIyXCI7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBmcywgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHV0aWxzIGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IG9wZW5VcmwgfSBmcm9tICdub2RlLXNpbWN0bCc7XG5cbmxldCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuY29tbWFuZHMuYWN0aXZlID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdhY3RpdmVfZWxlbWVudCcsIFtdKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoXCJhdS5nZXRBY3RpdmVFbGVtZW50KClcIik7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmdldERldmljZVRpbWUgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxvZy5pbmZvKCdBdHRlbXB0aW5nIHRvIGNhcHR1cmUgaU9TIGRldmljZSBkYXRlIGFuZCB0aW1lJyk7XG4gIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBpZGV2aWNlZGF0ZSA9IGF3YWl0IGZzLndoaWNoKCdpZGV2aWNlZGF0ZScpO1xuICAgICAgbG9nLmluZm8oYEZvdW5kIGlkZXZpY2VkYXRlOiAnJHtpZGV2aWNlZGF0ZX0nYCk7XG4gICAgICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKGlkZXZpY2VkYXRlLCBbJy11JywgdGhpcy5vcHRzLnVkaWRdKTtcbiAgICAgIHN0ZG91dCA9IHN0ZG91dC50cmltKCk7XG4gICAgICB0cnkge1xuICAgICAgICBsZXQgZGF0ZSA9IG5ldyBEYXRlKHN0ZG91dCk7XG4gICAgICAgIHJldHVybiBkYXRlLnRvU3RyaW5nKCk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgLy8gc29tZXRpbWVzIGBpZGV2aWNlZGF0ZWAgcmV0dXJucyBhbiB1bi1wYXJzYWJsZSBmb3JtYXRcbiAgICAgICAgLy8gaW4gd2hpY2ggY2FzZSwgd2UganVzdCB3YW50IHRvIHJldHVybiB0aGUgb3V0cHV0IGFuZFxuICAgICAgICAvLyBsZXQgdGhlIGNsaWVudCBkZWFsIHdpdGggaXRcbiAgICAgICAgbG9nLmRlYnVnKGBVbmFibGUgdG8gcGFyc2UgZGF0ZSAnJHtzdGRvdXR9Jy4gUmV0dXJuaW5nIGFzIGlzYCk7XG4gICAgICAgIHJldHVybiBzdGRvdXQ7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdygnQ291bGQgbm90IGNhcHR1cmUgZGV2aWNlIGRhdGUgYW5kIHRpbWUgdXNpbmcgbGliaW1vYmlsZWRldmljZSBpZGV2aWNlZGF0ZS4gJyArXG4gICAgICAgICAgICAgICAgICAgICAnTGliaW1vYmlsZWRldmljZSBpcyBwcm9iYWJseSBub3QgaW5zdGFsbGVkJyk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGxvZy53YXJuKCdPbiBzaW11bGF0b3IuIEFzc3VtaW5nIGRldmljZSB0aW1lIGlzIHRoZSBzYW1lIGFzIGhvc3QgdGltZScpO1xuICAgIHJldHVybiBuZXcgRGF0ZSgpLnRvU3RyaW5nKCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmhpZGVLZXlib2FyZCA9IGFzeW5jIGZ1bmN0aW9uIChzdHJhdGVneSwgLi4ucG9zc2libGVLZXlzKSB7XG4gIHBvc3NpYmxlS2V5cy5wb3AoKTsgLy8gbGFzdCBwYXJhbWV0ZXIgaXMgdGhlIHNlc3Npb24gaWRcbiAgbGV0IGNtZDtcbiAgbGV0IGtleSA9IF8uZmluZChwb3NzaWJsZUtleXMsIChrKSA9PiB7cmV0dXJuIGs7fSk7XG4gIGlmIChrZXkpIHtcbiAgICBzdHJhdGVneSA9IHN0cmF0ZWd5IHx8ICdwcmVzc0tleSc7XG4gICAgY21kID0gYGF1LmhpZGVLZXlib2FyZCgnJHtzdHJhdGVneX0nLCAnJHtrZXl9JylgO1xuICB9IGVsc2Uge1xuICAgIHN0cmF0ZWd5ID0gc3RyYXRlZ3kgfHwgJ2RlZmF1bHQnO1xuICAgIGNtZCA9IGBhdS5oaWRlS2V5Ym9hcmQoJyR7c3RyYXRlZ3l9JylgO1xuICB9XG4gIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGNtZCk7XG59O1xuXG5jb21tYW5kcy5nZXRQYWdlU291cmNlID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGxldCBjbWQgPSAnZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJodG1sXCIpWzBdLm91dGVySFRNTCc7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucmVtb3RlLmV4ZWN1dGUoY21kKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXROYXRpdmVQYWdlU291cmNlKCk7XG4gIH1cbn07XG5cbmhlbHBlcnMuZ2V0TmF0aXZlUGFnZVNvdXJjZSA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbGV0IGpzb25Tb3VyY2UgPSBhd2FpdCB0aGlzLmdldFNvdXJjZUZvckVsZW1lbnRGb3JYTUwoKTtcbiAgaWYgKHR5cGVvZiBqc29uU291cmNlID09PSBcInN0cmluZ1wiKSB7XG4gICAganNvblNvdXJjZSA9IEpTT04ucGFyc2UoanNvblNvdXJjZSk7XG4gIH1cbiAgbGV0IHhtbFNvdXJjZSA9IGpzMnhtbChcIkFwcGl1bUFVVFwiLCBqc29uU291cmNlLCB7XG4gICAgd3JhcEFycmF5OiB7ZW5hYmxlZDogZmFsc2UsIGVsZW1lbnROYW1lOiBcImVsZW1lbnRcIn0sXG4gICAgZGVjbGFyYXRpb246IHtpbmNsdWRlOiB0cnVlfSxcbiAgICBwcmV0dHlQcmludGluZzoge2luZGVudFN0cmluZzogXCIgICAgXCJ9XG4gIH0pO1xuICByZXR1cm4geG1sU291cmNlO1xufTtcblxuY29tbWFuZHMuYmFja2dyb3VuZCA9IGFzeW5jIGZ1bmN0aW9uIChzZWNzKSB7XG4gIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGBhdS5iYWNrZ3JvdW5kKCR7c2Vjc30pYCk7XG59O1xuXG5jb21tYW5kcy5sb2NrID0gYXN5bmMgZnVuY3Rpb24gKHNlY3MpIHtcbiAgaWYgKCFzZWNzKSB7XG4gICAgbG9nLmRlYnVnKCdObyBzZWNvbmRzIHBhcmFtZXRlci4gVXNpbmcgMCBzZWNvbmRzJyk7XG4gICAgc2VjcyA9IDA7XG4gIH1cbiAgYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoYGF1LmxvY2soJHtzZWNzfSlgKTtcbn07XG5cbmNvbW1hbmRzLmNsb3NlQXBwID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsZXQgYXBwTmFtZSA9IHRoaXMub3B0cy5hcHAgfHwgdGhpcy5vcHRzLmJ1bmRsZUlkO1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuc3RvcCgpO1xuICAgIGxvZy5pbmZvKGBTdWNjZXNzZnVsbHkgY2xvc2VkIHRoZSAnJHthcHBOYW1lfScgYXBwLmApO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgU29tZXRoaW5nIHdlbnQgd3Jvbmcgd2hpbGUgY2xvc2luZyB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmxhdW5jaEFwcCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbGV0IGFwcE5hbWUgPSB0aGlzLm9wdHMuYXBwIHx8IHRoaXMub3B0cy5idW5kbGVJZDtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLnN0YXJ0KCk7XG4gICAgbG9nLmluZm8oYFN1Y2Nlc3NmdWxseSBsYXVuY2hlZCB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYFNvbWV0aGluZyB3ZW50IHdyb25nIHdoaWxlIGxhdW5jaGluZyB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnJlbW92ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIChidW5kbGVJZCkge1xuICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIGF3YWl0IHRoaXMucmVhbERldmljZS5yZW1vdmUoYnVuZGxlSWQpO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IHRoaXMuc2ltLnJlbW92ZUFwcChidW5kbGVJZCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmtleXMgPSBhc3luYyBmdW5jdGlvbiAoa2V5cykge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGxldCBlbCA9IGF3YWl0IHRoaXMuYWN0aXZlKCk7XG4gICAgaWYgKF8uaXNVbmRlZmluZWQoZWwuRUxFTUVOVCkpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKCk7XG4gICAgfVxuICAgIGF3YWl0IHRoaXMuc2V0VmFsdWUoa2V5cywgZWwuRUxFTUVOVCk7XG4gIH0gZWxzZSB7XG4gICAgaWYgKF8uaXNBcnJheShrZXlzKSkge1xuICAgICAga2V5cyA9IGtleXMuam9pbignJyk7XG4gICAgfVxuICAgIGlmICghXy5pc1N0cmluZyhrZXlzKSkge1xuICAgICAga2V5cyA9IGtleXMudG9TdHJpbmcoKTtcbiAgICB9XG4gICAga2V5cyA9IHV0aWwuZXNjYXBlU3BlY2lhbENoYXJzKGtleXMsIFwiJ1wiKTtcbiAgICBsZXQgY29tbWFuZCA9IGBhdS5zZW5kS2V5c1RvQWN0aXZlRWxlbWVudCgnJHtrZXlzfScpYDtcbiAgICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChjb21tYW5kKTtcbiAgfVxufTtcblxuY29tbWFuZHMuc2V0R2VvTG9jYXRpb24gPSBhc3luYyBmdW5jdGlvbiAobG9jYXRpb24pIHtcbiAgLy8gVE9ETzogY2hlY2sgdGhlIGhhc09wdGlvbnMgYml0LCB0aGUgbWV0aG9kIHNpZ25hdHVyZSBzaG91bGQgYmUgbG9jYXRpb24sIG9wdGlvblxuXG4gIC8vbGV0IGhhc09wdGlvbnMgPSBhbHRpdHVkZSAhPT0gbnVsbCB8fCBob3Jpem9udGFsQWNjdXJhY3kgIT09IG51bGwgfHwgdmVydGljYWxBY2N1cmFjeSAhPT0gbnVsbCB8fCBjb3Vyc2UgIT09IG51bGwgfHwgc3BlZWQgIT09IG51bGw7XG4gIC8vaWYgKGhhc09wdGlvbnMpIHtcbiAgICAvL2xldCBvcHRpb25zID0ge307XG4gICAgLy9pZiAoYWx0aXR1ZGUgIT09IG51bGwpIHtcbiAgICAgIC8vb3B0aW9ucy5hbHRpdHVkZSA9IGFsdGl0dWRlO1xuICAgIC8vfVxuICAgIC8vaWYgKGhvcml6b250YWxBY2N1cmFjeSAhPT0gbnVsbCkge1xuICAgICAgLy9vcHRpb25zLmhvcml6b250YWxBY2N1cmFjeSA9IGhvcml6b250YWxBY2N1cmFjeTtcbiAgICAvL31cbiAgICAvL2lmICh2ZXJ0aWNhbEFjY3VyYWN5ICE9PSBudWxsKSB7XG4gICAgICAvL29wdGlvbnMudmVydGljYWxBY2N1cmFjeSA9IHZlcnRpY2FsQWNjdXJhY3k7XG4gICAgLy99XG4gICAgLy9pZiAoY291cnNlICE9PSBudWxsKSB7XG4gICAgICAvL29wdGlvbnMuY291cnNlID0gY291cnNlO1xuICAgIC8vfVxuICAgIC8vaWYgKHNwZWVkICE9PSBudWxsKSB7XG4gICAgICAvL29wdGlvbnMuc3BlZWQgPSBzcGVlZDtcbiAgICAvL31cbiAgICAvL2F3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKFxuICAgICAgLy9gdGFyZ2V0LnNldExvY2F0aW9uV2l0aE9wdGlvbnMoJHtKU09OLnN0cmluZ2lmeShjb29yZGluYXRlcyl9LCAke0pTT04uc3RyaW5naWZ5KG9wdGlvbnMpfSlgKTtcbiAgLy99IGVsc2Uge1xuICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChgdGFyZ2V0LnNldExvY2F0aW9uKCR7SlNPTi5zdHJpbmdpZnkobG9jYXRpb24pfSlgKTtcbiAgLy99XG59O1xuXG5jb21tYW5kcy5nZXRXaW5kb3dTaXplID0gYXN5bmMgZnVuY3Rpb24gKHdpbmRvd0hhbmRsZT1cImN1cnJlbnRcIikge1xuICBpZiAod2luZG93SGFuZGxlICE9PSBcImN1cnJlbnRcIikge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcihcIkN1cnJlbnRseSBvbmx5IGdldHRpbmcgY3VycmVudCB3aW5kb3cgc2l6ZSBpcyBzdXBwb3J0ZWQuXCIpO1xuICB9XG5cbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3dpbmRvd19zaXplJywgW10pO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChcImF1LmdldFdpbmRvd1NpemUoKVwiKTtcbiAgfVxufTtcblxuY29tbWFuZHMuZ2V0U3RyaW5ncyA9IGFzeW5jIGZ1bmN0aW9uIChsYW5ndWFnZSwgc3RyaW5nRmlsZSA9IG51bGwpIHtcbiAgbG9nLmRlYnVnKGBHZXR0aW5ncyBzdHJpbmdzIGZvciBsYW5ndWFnZSAnJHtsYW5ndWFnZX0nIGFuZCBzdHJpbmcgZmlsZSAnJHtzdHJpbmdGaWxlfSdgKTtcbiAgbGV0IHN0cmluZ3MgPSBhd2FpdCB1dGlscy5wYXJzZUxvY2FsaXphYmxlU3RyaW5ncyhfLmRlZmF1bHRzKHtsYW5ndWFnZSwgc3RyaW5nRmlsZX0sIHRoaXMub3B0cykpO1xuICBpZiAoc3RyaW5ncyAmJiBzdHJpbmdzLmxlbmd0aCA+PSAxKSB7XG4gICAgc3RyaW5ncyA9IHN0cmluZ3NbMF07XG4gIH1cbiAgcmV0dXJuIHN0cmluZ3M7XG59O1xuXG5jb21tYW5kcy5zZXRVcmwgPSBhc3luYyBmdW5jdGlvbiAodXJsKSB7XG4gIGxvZy5kZWJ1ZyhgQXR0ZW1wdGluZyB0byBzZXQgdXJsICcke3VybH0nYCk7XG4gIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIC8vIHVzZSB4Y3J1biB0byBvcGVuIGRlZXBsaW5rXG4gICAgYXdhaXQgb3BlblVybCh0aGlzLm9wdHMudWRpZCB8fCB0aGlzLnNpbS51ZGlkLCB1cmwpO1xuICAgIHJldHVybjtcbiAgfVxuICB0aGlzLnNldEN1cnJlbnRVcmwodXJsKTtcbiAgLy8gbWFrZSBzdXJlIHRvIGNsZWFyIG91dCBhbnkgbGVmdG92ZXIgd2ViIGZyYW1lc1xuICB0aGlzLmN1cldlYkZyYW1lcyA9IFtdO1xuICBhd2FpdCB0aGlzLnJlbW90ZS5uYXZUb1VybCh1cmwpO1xufTtcblxuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
