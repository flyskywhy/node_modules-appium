/* global it:true, describe:true*/
require('source-map-support').install();

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$keys = require('babel-runtime/core-js/object/keys')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _libSimctlJs = require('../lib/simctl.js');

var _appiumXcode = require('appium-xcode');

var _appiumXcode2 = _interopRequireDefault(_appiumXcode);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _appiumSupport = require('appium-support');

var _asyncbox = require('asyncbox');

var should = _chai2['default'].should();

describe('simctl', function () {
  var _this = this;

  var DEVICE_NAME = 'iPhone 6';
  var MOCHA_TIMEOUT = 200000;
  this.timeout(MOCHA_TIMEOUT);

  var randName = undefined;
  var randDeviceUdid = null;
  var validSdks = [];

  before(function callee$1$0() {
    var devices, i, randNum, nameFound, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, list;

    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)());

        case 2:
          devices = context$2$0.sent;

          validSdks = _lodash2['default'].keys(devices).sort(function (a, b) {
            return a - b;
          });

          if (validSdks.length) {
            context$2$0.next = 6;
            break;
          }

          throw new Error('No valid SDKs');

        case 6:
          console.log('Found valid SDKs: ' + validSdks.join(', ')); // eslint-disable-line no-console

          // need to find a random name that does not already exist
          // give it 5 tries
          i = 0;

        case 8:
          if (!(i < 5)) {
            context$2$0.next = 44;
            break;
          }

          randNum = parseInt(Math.random() * 100, 10);

          randName = 'device' + randNum;

          nameFound = false;
          _iteratorNormalCompletion = true;
          _didIteratorError = false;
          _iteratorError = undefined;
          context$2$0.prev = 15;
          _iterator = _getIterator(_lodash2['default'].values(devices));

        case 17:
          if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
            context$2$0.next = 25;
            break;
          }

          list = _step.value;

          if (!_lodash2['default'].includes(_lodash2['default'].map(list, 'name'), randName)) {
            context$2$0.next = 22;
            break;
          }

          // need to find another random name
          nameFound = true;
          return context$2$0.abrupt('break', 25);

        case 22:
          _iteratorNormalCompletion = true;
          context$2$0.next = 17;
          break;

        case 25:
          context$2$0.next = 31;
          break;

        case 27:
          context$2$0.prev = 27;
          context$2$0.t0 = context$2$0['catch'](15);
          _didIteratorError = true;
          _iteratorError = context$2$0.t0;

        case 31:
          context$2$0.prev = 31;
          context$2$0.prev = 32;

          if (!_iteratorNormalCompletion && _iterator['return']) {
            _iterator['return']();
          }

        case 34:
          context$2$0.prev = 34;

          if (!_didIteratorError) {
            context$2$0.next = 37;
            break;
          }

          throw _iteratorError;

        case 37:
          return context$2$0.finish(34);

        case 38:
          return context$2$0.finish(31);

        case 39:
          if (nameFound) {
            context$2$0.next = 41;
            break;
          }

          return context$2$0.abrupt('break', 44);

        case 41:
          i++;
          context$2$0.next = 8;
          break;

        case 44:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this, [[15, 27, 31, 39], [32,, 34, 38]]);
  });

  // eslint-disable-line curly
  it('should create a device', function callee$1$0() {
    var udid;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.createDevice)(randName, DEVICE_NAME, _lodash2['default'].last(validSdks)));

        case 2:
          udid = context$2$0.sent;

          (typeof udid).should.equal('string');
          udid.length.should.equal(36);

        case 5:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should get devices', function callee$1$0() {
    var sdkDevices;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)(_lodash2['default'].last(validSdks)));

        case 2:
          sdkDevices = context$2$0.sent;

          _lodash2['default'].map(sdkDevices, 'name').should.include(randName);
          randDeviceUdid = sdkDevices.filter(function (d) {
            return d.name === randName;
          })[0].udid;

        case 5:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should erase devices', function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.eraseDevice)(randDeviceUdid, 16000));

        case 2:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should delete devices', function callee$1$0() {
    var sdkDevices;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.deleteDevice)(randDeviceUdid));

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)(_lodash2['default'].last(validSdks)));

        case 4:
          sdkDevices = context$2$0.sent;

          _lodash2['default'].map(sdkDevices, 'name').should.not.include(randName);

        case 6:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should return a nice error for invalid usage', function callee$1$0() {
    var err;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          err = null;
          context$2$0.prev = 1;
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.createDevice)('foo', 'bar', 'baz'));

        case 4:
          context$2$0.next = 9;
          break;

        case 6:
          context$2$0.prev = 6;
          context$2$0.t0 = context$2$0['catch'](1);

          err = context$2$0.t0;

        case 9:
          should.exist(err);
          err.message.should.include('Invalid device type: bar');

        case 11:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this, [[1, 6]]);
  });

  it('should create a device and be able to see it in devices list right away', function callee$1$0() {
    var sdk, numSimsBefore, udid, numSimsAfter;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          sdk = _lodash2['default'].last(validSdks);
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)());

        case 3:
          context$2$0.t0 = sdk;
          numSimsBefore = context$2$0.sent[context$2$0.t0].length;
          context$2$0.next = 7;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.createDevice)('node-simctl test', DEVICE_NAME, sdk));

        case 7:
          udid = context$2$0.sent;
          context$2$0.next = 10;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)());

        case 10:
          context$2$0.t1 = sdk;
          numSimsAfter = context$2$0.sent[context$2$0.t1].length;

          numSimsAfter.should.equal(numSimsBefore + 1);
          (0, _libSimctlJs.deleteDevice)(udid);

        case 14:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should create a device with compatible properties', function callee$1$0() {
    var sdk, devices, firstDevice, expectedList;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          sdk = _lodash2['default'].last(validSdks);
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)());

        case 3:
          context$2$0.t0 = sdk;
          devices = context$2$0.sent[context$2$0.t0];
          firstDevice = devices[0];
          expectedList = ['name', 'sdk', 'state', 'udid'];

          _Object$keys(firstDevice).sort().should.eql(expectedList);

        case 8:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  describe('on running Simulator', function () {
    if (process.env.TRAVIS) {
      this.retries(3);
    }

    var udid = undefined;
    var major = undefined,
        minor = undefined;

    before(function callee$2$0() {
      var _ref, sdk;

      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(_appiumXcode2['default'].getVersion(true));

          case 2:
            _ref = context$3$0.sent;
            major = _ref.major;
            minor = _ref.minor;

            if (!(major < 8 || major === 8 && minor < 1)) {
              context$3$0.next = 7;
              break;
            }

            return context$3$0.abrupt('return', this.skip());

          case 7:
            sdk = _lodash2['default'].last(validSdks);
            context$3$0.next = 10;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.createDevice)('runningSimTest', DEVICE_NAME, sdk));

          case 10:
            udid = context$3$0.sent;
            context$3$0.next = 13;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.bootDevice)(udid));

          case 13:
            context$3$0.next = 15;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.launch)(udid, 'com.apple.springboard', MOCHA_TIMEOUT));

          case 15:
            context$3$0.next = 17;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(5000));

          case 17:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });
    after(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            if (!udid) {
              context$3$0.next = 10;
              break;
            }

            context$3$0.prev = 1;
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.shutdown)(udid));

          case 4:
            context$3$0.next = 8;
            break;

          case 6:
            context$3$0.prev = 6;
            context$3$0.t0 = context$3$0['catch'](1);

          case 8:
            context$3$0.next = 10;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.deleteDevice)(udid));

          case 10:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this, [[1, 6]]);
    });

    describe('pasteboard', function () {
      var pbRetries = 0;
      before(function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              if (!(major < 8 || major === 8 && minor < 1)) {
                context$4$0.next = 2;
                break;
              }

              return context$4$0.abrupt('return', this.skip());

            case 2:
              if (major === 9) {
                // TODO: recheck when full Xcode 9 comes out to see if pasteboard works better
                pbRetries = 200;
                this.timeout(200 * 1000 * 2);
              }

            case 3:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
      it('should set and get the content of the pasteboard', function callee$3$0() {
        var pbContent, encoding;
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          var _this2 = this;

          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              pbContent = 'blablabla';
              encoding = 'ascii';
              context$4$0.next = 4;
              return _regeneratorRuntime.awrap((0, _libSimctlJs.setPasteboard)(udid, pbContent, encoding));

            case 4:
              context$4$0.next = 6;
              return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(pbRetries, 1000, function callee$4$0() {
                return _regeneratorRuntime.async(function callee$4$0$(context$5$0) {
                  while (1) switch (context$5$0.prev = context$5$0.next) {
                    case 0:
                      context$5$0.next = 2;
                      return _regeneratorRuntime.awrap((0, _libSimctlJs.getPasteboard)(udid, encoding));

                    case 2:
                      context$5$0.t0 = pbContent;
                      context$5$0.sent.should.eql(context$5$0.t0);

                    case 4:
                    case 'end':
                      return context$5$0.stop();
                  }
                }, null, _this2);
              }));

            case 6:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
    });

    describe('add media', function () {
      var BASE64_PNG = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';
      var picturePath = undefined;
      before(function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              if (!(major < 8 || major === 8 && minor < 1)) {
                context$4$0.next = 2;
                break;
              }

              return context$4$0.abrupt('return', this.skip());

            case 2:
              context$4$0.next = 4;
              return _regeneratorRuntime.awrap(_appiumSupport.tempDir.path({ prefix: 'pixel', suffix: '.png' }));

            case 4:
              picturePath = context$4$0.sent;
              context$4$0.next = 7;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(picturePath, new Buffer(BASE64_PNG, 'base64').toString('binary'), 'binary'));

            case 7:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
      after(function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              context$4$0.next = 2;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(picturePath));

            case 2:
              if (!context$4$0.sent) {
                context$4$0.next = 5;
                break;
              }

              context$4$0.next = 5;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.unlink(picturePath));

            case 5:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
      it('should add media files', function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              context$4$0.next = 2;
              return _regeneratorRuntime.awrap((0, _libSimctlJs.addMedia)(udid, picturePath));

            case 2:
              context$4$0.sent.code.should.eql(0);

            case 3:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
    });

    it('should extract applications information', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.appInfo)(udid, 'com.apple.springboard'));

          case 2:
            context$3$0.sent.should.include('ApplicationType');

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });
  });
});

// Wait for boot to complete

// pause a moment or everything is messed up
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3Qvc2ltY3RsLWUyZS1zcGVjcy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O29CQUdpQixNQUFNOzs7O3NCQUNULFFBQVE7Ozs7MkJBRTBDLGtCQUFrQjs7MkJBQ2hFLGNBQWM7Ozs7d0JBQ2xCLFVBQVU7Ozs7NkJBQ0ksZ0JBQWdCOzt3QkFDZCxVQUFVOztBQUd4QyxJQUFNLE1BQU0sR0FBRyxrQkFBSyxNQUFNLEVBQUUsQ0FBQzs7QUFFN0IsUUFBUSxDQUFDLFFBQVEsRUFBRSxZQUFZOzs7QUFDN0IsTUFBTSxXQUFXLEdBQUcsVUFBVSxDQUFDO0FBQy9CLE1BQU0sYUFBYSxHQUFHLE1BQU0sQ0FBQztBQUM3QixNQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDOztBQUU1QixNQUFJLFFBQVEsWUFBQSxDQUFDO0FBQ2IsTUFBSSxjQUFjLEdBQUcsSUFBSSxDQUFDO0FBQzFCLE1BQUksU0FBUyxHQUFHLEVBQUUsQ0FBQzs7QUFFbkIsUUFBTSxDQUFDO1FBQ0QsT0FBTyxFQVNGLENBQUMsRUFDSixPQUFPLEVBR1AsU0FBUyxrRkFDSixJQUFJOzs7Ozs7MkNBZEssOEJBQVk7OztBQUE1QixpQkFBTzs7QUFDWCxtQkFBUyxHQUFHLG9CQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxDQUFDLEVBQUUsQ0FBQzttQkFBSyxDQUFDLEdBQUcsQ0FBQztXQUFBLENBQUMsQ0FBQzs7Y0FDN0MsU0FBUyxDQUFDLE1BQU07Ozs7O2dCQUNiLElBQUksS0FBSyxDQUFDLGVBQWUsQ0FBQzs7O0FBRWxDLGlCQUFPLENBQUMsR0FBRyx3QkFBc0IsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBRyxDQUFDOzs7O0FBSWhELFdBQUMsR0FBRyxDQUFDOzs7Z0JBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQTs7Ozs7QUFDZixpQkFBTyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdB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Y2VzQ29udGVudCI6WyIvKiBnbG9iYWwgaXQ6dHJ1ZSwgZGVzY3JpYmU6dHJ1ZSovXG4vLyB0cmFuc3BpbGU6bW9jaGFcblxuaW1wb3J0IGNoYWkgZnJvbSAnY2hhaSc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgY3JlYXRlRGV2aWNlLCBkZWxldGVEZXZpY2UsIGVyYXNlRGV2aWNlLCBnZXREZXZpY2VzLCBzZXRQYXN0ZWJvYXJkLCBnZXRQYXN0ZWJvYXJkLFxuICAgICAgICAgYm9vdERldmljZSwgbGF1bmNoLCBzaHV0ZG93biwgYWRkTWVkaWEsIGFwcEluZm8gfSBmcm9tICcuLi9saWIvc2ltY3RsLmpzJztcbmltcG9ydCB4Y29kZSBmcm9tICdhcHBpdW0teGNvZGUnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgZnMsIHRlbXBEaXIgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuXG5cbmNvbnN0IHNob3VsZCA9IGNoYWkuc2hvdWxkKCk7XG5cbmRlc2NyaWJlKCdzaW1jdGwnLCBmdW5jdGlvbiAoKSB7XG4gIGNvbnN0IERFVklDRV9OQU1FID0gJ2lQaG9uZSA2JztcbiAgY29uc3QgTU9DSEFfVElNRU9VVCA9IDIwMDAwMDtcbiAgdGhpcy50aW1lb3V0KE1PQ0hBX1RJTUVPVVQpO1xuXG4gIGxldCByYW5kTmFtZTtcbiAgbGV0IHJhbmREZXZpY2VVZGlkID0gbnVsbDtcbiAgbGV0IHZhbGlkU2RrcyA9IFtdO1xuXG4gIGJlZm9yZShhc3luYyAoKSA9PiB7XG4gICAgbGV0IGRldmljZXMgPSBhd2FpdCBnZXREZXZpY2VzKCk7XG4gICAgdmFsaWRTZGtzID0gXy5rZXlzKGRldmljZXMpLnNvcnQoKGEsIGIpID0+IGEgLSBiKTtcbiAgICBpZiAoIXZhbGlkU2Rrcy5sZW5ndGgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTm8gdmFsaWQgU0RLcycpO1xuICAgIH1cbiAgICBjb25zb2xlLmxvZyhgRm91bmQgdmFsaWQgU0RLczogJHt2YWxpZFNka3Muam9pbignLCAnKX1gKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1jb25zb2xlXG5cbiAgICAvLyBuZWVkIHRvIGZpbmQgYSByYW5kb20gbmFtZSB0aGF0IGRvZXMgbm90IGFscmVhZHkgZXhpc3RcbiAgICAvLyBnaXZlIGl0IDUgdHJpZXNcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDU7IGkrKykge1xuICAgICAgbGV0IHJhbmROdW0gPSBwYXJzZUludChNYXRoLnJhbmRvbSgpICogMTAwLCAxMCk7XG4gICAgICByYW5kTmFtZSA9IGBkZXZpY2Uke3JhbmROdW19YDtcblxuICAgICAgbGV0IG5hbWVGb3VuZCA9IGZhbHNlO1xuICAgICAgZm9yIChsZXQgbGlzdCBvZiBfLnZhbHVlcyhkZXZpY2VzKSkge1xuICAgICAgICBpZiAoXy5pbmNsdWRlcyhfLm1hcChsaXN0LCAnbmFtZScpLCByYW5kTmFtZSkpIHtcbiAgICAgICAgICAvLyBuZWVkIHRvIGZpbmQgYW5vdGhlciByYW5kb20gbmFtZVxuICAgICAgICAgIG5hbWVGb3VuZCA9IHRydWU7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICghbmFtZUZvdW5kKSBicmVhazsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuICAgIH1cbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBjcmVhdGUgYSBkZXZpY2UnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IHVkaWQgPSBhd2FpdCBjcmVhdGVEZXZpY2UocmFuZE5hbWUsIERFVklDRV9OQU1FLCBfLmxhc3QodmFsaWRTZGtzKSk7XG4gICAgKHR5cGVvZiB1ZGlkKS5zaG91bGQuZXF1YWwoJ3N0cmluZycpO1xuICAgIHVkaWQubGVuZ3RoLnNob3VsZC5lcXVhbCgzNik7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgZ2V0IGRldmljZXMnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IHNka0RldmljZXMgPSBhd2FpdCBnZXREZXZpY2VzKF8ubGFzdCh2YWxpZFNka3MpKTtcbiAgICBfLm1hcChzZGtEZXZpY2VzLCAnbmFtZScpLnNob3VsZC5pbmNsdWRlKHJhbmROYW1lKTtcbiAgICByYW5kRGV2aWNlVWRpZCA9IHNka0RldmljZXMuZmlsdGVyKChkKSA9PiBkLm5hbWUgPT09IHJhbmROYW1lKVswXS51ZGlkO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGVyYXNlIGRldmljZXMnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgYXdhaXQgZXJhc2VEZXZpY2UocmFuZERldmljZVVkaWQsIDE2MDAwKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBkZWxldGUgZGV2aWNlcycsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBhd2FpdCBkZWxldGVEZXZpY2UocmFuZERldmljZVVkaWQpO1xuICAgIGxldCBzZGtEZXZpY2VzID0gYXdhaXQgZ2V0RGV2aWNlcyhfLmxhc3QodmFsaWRTZGtzKSk7XG4gICAgXy5tYXAoc2RrRGV2aWNlcywgJ25hbWUnKS5zaG91bGQubm90LmluY2x1ZGUocmFuZE5hbWUpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHJldHVybiBhIG5pY2UgZXJyb3IgZm9yIGludmFsaWQgdXNhZ2UnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IGVyciA9IG51bGw7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGNyZWF0ZURldmljZSgnZm9vJywgJ2JhcicsICdiYXonKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBlcnIgPSBlO1xuICAgIH1cbiAgICBzaG91bGQuZXhpc3QoZXJyKTtcbiAgICBlcnIubWVzc2FnZS5zaG91bGQuaW5jbHVkZSgnSW52YWxpZCBkZXZpY2UgdHlwZTogYmFyJyk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgY3JlYXRlIGEgZGV2aWNlIGFuZCBiZSBhYmxlIHRvIHNlZSBpdCBpbiBkZXZpY2VzIGxpc3QgcmlnaHQgYXdheScsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgc2RrID0gXy5sYXN0KHZhbGlkU2Rrcyk7XG4gICAgbGV0IG51bVNpbXNCZWZvcmUgPSAoYXdhaXQgZ2V0RGV2aWNlcygpKVtzZGtdLmxlbmd0aDtcbiAgICBsZXQgdWRpZCA9IGF3YWl0IGNyZWF0ZURldmljZSgnbm9kZS1zaW1jdGwgdGVzdCcsIERFVklDRV9OQU1FLCBzZGspO1xuICAgIGxldCBudW1TaW1zQWZ0ZXIgPSAoYXdhaXQgZ2V0RGV2aWNlcygpKVtzZGtdLmxlbmd0aDtcbiAgICBudW1TaW1zQWZ0ZXIuc2hvdWxkLmVxdWFsKG51bVNpbXNCZWZvcmUgKyAxKTtcbiAgICBkZWxldGVEZXZpY2UodWRpZCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgY3JlYXRlIGEgZGV2aWNlIHdpdGggY29tcGF0aWJsZSBwcm9wZXJ0aWVzJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGxldCBzZGsgPSBfLmxhc3QodmFsaWRTZGtzKTtcbiAgICBsZXQgZGV2aWNlcyA9IChhd2FpdCBnZXREZXZpY2VzKCkpW3Nka107XG4gICAgbGV0IGZpcnN0RGV2aWNlID0gZGV2aWNlc1swXTtcbiAgICBsZXQgZXhwZWN0ZWRMaXN0ID0gWyduYW1lJywgJ3NkaycsICdzdGF0ZScsICd1ZGlkJ107XG4gICAgT2JqZWN0LmtleXMoZmlyc3REZXZpY2UpLnNvcnQoKS5zaG91bGQuZXFsKGV4cGVjdGVkTGlzdCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdvbiBydW5uaW5nIFNpbXVsYXRvcicsIGZ1bmN0aW9uICgpIHtcbiAgICBpZiAocHJvY2Vzcy5lbnYuVFJBVklTKSB7XG4gICAgICB0aGlzLnJldHJpZXMoMyk7XG4gICAgfVxuXG4gICAgbGV0IHVkaWQ7XG4gICAgbGV0IG1ham9yLCBtaW5vcjtcblxuICAgIGJlZm9yZShhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAoe21ham9yLCBtaW5vcn0gPSBhd2FpdCB4Y29kZS5nZXRWZXJzaW9uKHRydWUpKTtcbiAgICAgIGlmIChtYWpvciA8IDggfHwgKG1ham9yID09PSA4ICYmIG1pbm9yIDwgMSkpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2tpcCgpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzZGsgPSBfLmxhc3QodmFsaWRTZGtzKTtcbiAgICAgIHVkaWQgPSBhd2FpdCBjcmVhdGVEZXZpY2UoJ3J1bm5pbmdTaW1UZXN0JywgREVWSUNFX05BTUUsIHNkayk7XG5cbiAgICAgIGF3YWl0IGJvb3REZXZpY2UodWRpZCk7XG4gICAgICAvLyBXYWl0IGZvciBib290IHRvIGNvbXBsZXRlXG4gICAgICBhd2FpdCBsYXVuY2godWRpZCwgJ2NvbS5hcHBsZS5zcHJpbmdib2FyZCcsIE1PQ0hBX1RJTUVPVVQpO1xuXG4gICAgICAvLyBwYXVzZSBhIG1vbWVudCBvciBldmVyeXRoaW5nIGlzIG1lc3NlZCB1cFxuICAgICAgYXdhaXQgQi5kZWxheSg1MDAwKTtcbiAgICB9KTtcbiAgICBhZnRlcihhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBpZiAodWRpZCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IHNodXRkb3duKHVkaWQpO1xuICAgICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgICAgIGF3YWl0IGRlbGV0ZURldmljZSh1ZGlkKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdwYXN0ZWJvYXJkJywgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IHBiUmV0cmllcyA9IDA7XG4gICAgICBiZWZvcmUoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAobWFqb3IgPCA4IHx8IChtYWpvciA9PT0gOCAmJiBtaW5vciA8IDEpKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuc2tpcCgpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChtYWpvciA9PT0gOSkge1xuICAgICAgICAgIC8vIFRPRE86IHJlY2hlY2sgd2hlbiBmdWxsIFhjb2RlIDkgY29tZXMgb3V0IHRvIHNlZSBpZiBwYXN0ZWJvYXJkIHdvcmtzIGJldHRlclxuICAgICAgICAgIHBiUmV0cmllcyA9IDIwMDtcbiAgICAgICAgICB0aGlzLnRpbWVvdXQoMjAwICogMTAwMCAqIDIpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGl0KCdzaG91bGQgc2V0IGFuZCBnZXQgdGhlIGNvbnRlbnQgb2YgdGhlIHBhc3RlYm9hcmQnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGNvbnN0IHBiQ29udGVudCA9ICdibGFibGFibGEnO1xuICAgICAgICBjb25zdCBlbmNvZGluZyA9ICdhc2NpaSc7XG5cbiAgICAgICAgYXdhaXQgc2V0UGFzdGVib2FyZCh1ZGlkLCBwYkNvbnRlbnQsIGVuY29kaW5nKTtcbiAgICAgICAgYXdhaXQgcmV0cnlJbnRlcnZhbChwYlJldHJpZXMsIDEwMDAsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAoYXdhaXQgZ2V0UGFzdGVib2FyZCh1ZGlkLCBlbmNvZGluZykpLnNob3VsZC5lcWwocGJDb250ZW50KTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdhZGQgbWVkaWEnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBjb25zdCBCQVNFNjRfUE5HID0gJ2lWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFBRUFBQUFCQ0FZQUFBQWZGY1NKQUFBQURVbEVRVlI0Mm1OaytNOVFEd0FEaGdHQVdqUjlhd0FBQUFCSlJVNUVya0pnZ2c9PSc7XG4gICAgICBsZXQgcGljdHVyZVBhdGg7XG4gICAgICBiZWZvcmUoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAobWFqb3IgPCA4IHx8IChtYWpvciA9PT0gOCAmJiBtaW5vciA8IDEpKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuc2tpcCgpO1xuICAgICAgICB9XG4gICAgICAgIHBpY3R1cmVQYXRoID0gYXdhaXQgdGVtcERpci5wYXRoKHtwcmVmaXg6ICdwaXhlbCcsIHN1ZmZpeDogJy5wbmcnfSk7XG4gICAgICAgIGF3YWl0IGZzLndyaXRlRmlsZShwaWN0dXJlUGF0aCwgbmV3IEJ1ZmZlcihCQVNFNjRfUE5HLCAnYmFzZTY0JykudG9TdHJpbmcoJ2JpbmFyeScpLCAnYmluYXJ5Jyk7XG4gICAgICB9KTtcbiAgICAgIGFmdGVyKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKGF3YWl0IGZzLmV4aXN0cyhwaWN0dXJlUGF0aCkpIHtcbiAgICAgICAgICBhd2FpdCBmcy51bmxpbmsocGljdHVyZVBhdGgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGl0KCdzaG91bGQgYWRkIG1lZGlhIGZpbGVzJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAoYXdhaXQgYWRkTWVkaWEodWRpZCwgcGljdHVyZVBhdGgpKS5jb2RlLnNob3VsZC5lcWwoMCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZXh0cmFjdCBhcHBsaWNhdGlvbnMgaW5mb3JtYXRpb24nLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAoYXdhaXQgYXBwSW5mbyh1ZGlkLCAnY29tLmFwcGxlLnNwcmluZ2JvYXJkJykpLnNob3VsZC5pbmNsdWRlKCdBcHBsaWNhdGlvblR5cGUnKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
