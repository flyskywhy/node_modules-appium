'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _remoteDebugger = require('./remote-debugger');

var _remoteMessages = require('./remote-messages');

var _remoteMessages2 = _interopRequireDefault(_remoteMessages);

var _ws = require('ws');

var _ws2 = _interopRequireDefault(_ws);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _helpers = require('./helpers');

var DATA_LOG_LENGTH = { length: 200 };

var WebKitRpcClient = (function (_events$EventEmitter) {
  _inherits(WebKitRpcClient, _events$EventEmitter);

  function WebKitRpcClient(host) {
    var port = arguments.length <= 1 || arguments[1] === undefined ? _remoteDebugger.REMOTE_DEBUGGER_PORT : arguments[1];
    var responseTimeout = arguments.length <= 2 || arguments[2] === undefined ? _remoteDebugger.RPC_RESPONSE_TIMEOUT_MS : arguments[2];

    _classCallCheck(this, WebKitRpcClient);

    _get(Object.getPrototypeOf(WebKitRpcClient.prototype), 'constructor', this).call(this);

    this.host = host;
    this.port = port;

    this.responseTimeout = responseTimeout;

    this.curMsgId = 0;

    this.dataHandlers = {};
    this.dataMethods = {};
    this.errorHandlers = {};

    this.setHandlers();
  }

  _createClass(WebKitRpcClient, [{
    key: 'connect',
    value: function connect(pageId) {
      return _regeneratorRuntime.async(function connect$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', new _bluebird2['default'](function (resolve, reject) {
              // we will only resolve this call when the socket is open
              // WebKit url
              var url = 'ws://' + _this.host + ':' + _this.port + '/devtools/page/' + pageId;
              _this.pageIdKey = pageId;

              // create and set up socket with appropriate event handlers
              _this.socket = new _ws2['default'](url);
              _this.socket.on('open', function () {
                _logger2['default'].debug('WebKit debugger web socket connected to url: ' + url);
                _this.connected = true;
                resolve();
              });
              _this.socket.on('close', function () {
                _logger2['default'].debug('WebKit remote debugger socket disconnected');
                _this.connected = false;
              });
              _this.socket.on('error', function (exception) {
                if (_this.connected) {
                  _logger2['default'].debug('WebKit debugger web socket error: ' + exception.message);
                  _this.connected = false;
                }

                reject(exception);
              });
              _this.socket.on('message', _this.receive.bind(_this));
            }));

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'disconnect',
    value: function disconnect() {
      _logger2['default'].debug('Disconnecting from WebKit remote debugger');
      if (this.isConnected()) {
        this.socket.close(1001);
      }
      this.connected = false;
    }
  }, {
    key: 'isConnected',
    value: function isConnected() {
      return this.socket !== null && this.connected;
    }
  }, {
    key: 'send',
    value: function send(command) {
      var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
      var data, id;
      return _regeneratorRuntime.async(function send$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            data = (0, _remoteMessages2['default'])(command, _lodash2['default'].defaults({ connId: this.connId, senderId: this.senderId }, opts));

            _logger2['default'].debug('Sending WebKit data: ' + _lodash2['default'].truncate(JSON.stringify(data), DATA_LOG_LENGTH)); // jshint ignore:line
            _logger2['default'].debug('Webkit response timeout: ' + this.responseTimeout);

            this.curMsgId++;
            data.id = this.curMsgId;

            id = this.curMsgId.toString();
            return context$2$0.abrupt('return', new _bluebird2['default'](function (resolve, reject) {
              // only resolve the send command when WebKit returns a response
              // store the handler and the data sent
              _this2.dataHandlers[id] = resolve;
              _this2.dataMethods[id] = data.method;
              _this2.errorHandlers[id] = reject;

              // send the data
              data = JSON.stringify(data);
              _this2.socket.send(data, function (error) {
                if (!_lodash2['default'].isUndefined(error) && !_lodash2['default'].isNull(error)) {
                  _logger2['default'].debug('WebKit socket error occurred: ' + error);
                  reject(new Error(error));
                }
              });
            })['finally'](function (res) {
              // no need to hold onto anything
              delete _this2.dataHandlers[id];
              delete _this2.dataMethods[id];
              delete _this2.errorHandlers[id];

              // and pass along the result
              return res;
            }).timeout(this.responseTimeout));

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'receive',
    value: function receive(data) {
      _logger2['default'].debug('Receiving WebKit data: \'' + _lodash2['default'].truncate(data, DATA_LOG_LENGTH) + '\'');

      data = JSON.parse(data);
      if (!data) {
        _logger2['default'].warn('No parseable data found');
        return;
      }

      // we can get an error, or we can get a response that is an error
      if (data.wasThrown || data.result && data.result.wasThrown) {
        var message = undefined;
        if (data.wasThrown) {
          message = data.result.value || data.result.description;
        } else {
          message = data.result.result.value || data.result.result.description;
        }
        var error = new Error(message);
        if (data.id && this.errorHandlers[data.id]) {
          this.errorHandlers[data.id](error);
          return;
        } else {
          // this should never happen, but log at least
          _logger2['default'].errorAndThrow(error);
        }
      }

      // when sending we set a data method and associated callback.
      // get that, or the generic (automatically sent, not associated
      // with a particular request) method
      var handlerFor = undefined;
      if (data.id && this.dataMethods[data.id]) {
        _logger2['default'].debug('Found handler for message \'' + data.id + '\'');
        handlerFor = this.dataMethods[data.id];
      } else {
        _logger2['default'].debug('Did not find handler for message');
        handlerFor = data.method;
      }

      if (!handlerFor) {
        _logger2['default'].debug('Received an invalid method: \'' + data.method + '\'');
        return;
      }
      if (_lodash2['default'].has(this.handlers, handlerFor)) {
        this.handlers[handlerFor](data);
      } else {
        _logger2['default'].debug('WebKit debugger got a message for \'' + handlerFor + '\' ' + 'and have no handler, doing nothing.');
      }
    }
  }, {
    key: 'setHandlers',
    value: function setHandlers() {
      var _this3 = this;

      this.handlers = {
        'Runtime.evaluate': function RuntimeEvaluate(data) {
          var msgId = data.id;
          if (data.error) {
            _this3.errorHandlers[msgId](data.error);
          }

          _this3.dataHandlers[msgId](data.result);
        },
        'Page.navigate': function PageNavigate(data) {
          _logger2['default'].debug('Received page navigated message: ' + (0, _helpers.simpleStringify)(data));
          var msgId = data.id;
          if (data.error) {
            _this3.errorHandlers[msgId](data.error);
          }

          _this3.dataHandlers[msgId](data.result);
        },
        'Profiler.resetProfiles': function ProfilerResetProfiles() {
          _logger2['default'].debug('Device is telling us to reset profiles. Should probably ' + 'do some kind of callback here');
        },
        'Timeline.eventRecorded': function TimelineEventRecorded(data) {
          _this3.timelineEventHandler(data.result);
        }
      };
    }
  }, {
    key: 'setTimelineEventHandler',
    value: function setTimelineEventHandler(timelineEventHandler) {
      this.timelineEventHandler = timelineEventHandler;
      this.messageHandler.setTimelineEventHandler(timelineEventHandler);
    }
  }]);

  return WebKitRpcClient;
})(_events2['default'].EventEmitter);

exports['default'] = WebKitRpcClient;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZWJraXQtcnBjLWNsaWVudC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7c0JBQWdCLFVBQVU7Ozs7OEJBQ29DLG1CQUFtQjs7OEJBQ3BELG1CQUFtQjs7OztrQkFDMUIsSUFBSTs7Ozt3QkFDTixVQUFVOzs7O3NCQUNoQixRQUFROzs7O3NCQUNILFFBQVE7Ozs7dUJBQ0ssV0FBVzs7QUFHM0MsSUFBTSxlQUFlLEdBQUcsRUFBQyxNQUFNLEVBQUUsR0FBRyxFQUFDLENBQUM7O0lBRWpCLGVBQWU7WUFBZixlQUFlOztBQUN0QixXQURPLGVBQWUsQ0FDckIsSUFBSSxFQUEwRTtRQUF4RSxJQUFJO1FBQXlCLGVBQWU7OzBCQUQ1QyxlQUFlOztBQUVoQywrQkFGaUIsZUFBZSw2Q0FFeEI7O0FBRVIsUUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7QUFDakIsUUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7O0FBRWpCLFFBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDOztBQUV2QyxRQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQzs7QUFFbEIsUUFBSSxDQUFDLFlBQVksR0FBRyxFQUFFLENBQUM7QUFDdkIsUUFBSSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7QUFDdEIsUUFBSSxDQUFDLGFBQWEsR0FBRyxFQUFFLENBQUM7O0FBRXhCLFFBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztHQUNwQjs7ZUFoQmtCLGVBQWU7O1dBa0JwQixpQkFBQyxNQUFNOzs7Ozs7Z0RBQ1osMEJBQVksVUFBQyxPQUFPLEVBQUUsTUFBTSxFQUFLOzs7QUFHdEMsa0JBQUksR0FBRyxhQUFXLE1BQUssSUFBSSxTQUFJLE1BQUssSUFBSSx1QkFBa0IsTUFBTSxBQUFFLENBQUM7QUFDbkUsb0JBQUssU0FBUyxHQUFHLE1BQU0sQ0FBQzs7O0FBR3hCLG9CQUFLLE1BQU0sR0FBRyxvQkFBYyxHQUFHLENBQUMsQ0FBQztBQUNqQyxv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QUU7QUFDZCxtQkFBSyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1dBQ3ZDOztBQUVELGlCQUFLLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDdkM7QUFDRCx1QkFBZSxFQUFFLHNCQUFDLElBQUksRUFBSztBQUN6Qiw4QkFBSSxLQUFLLHVDQUFxQyw4QkFBZ0IsSUFBSSxDQUFDLENBQUcsQ0FBQztBQUN2RSxjQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDO0FBQ3BCLGNBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtBQUNkLG1CQUFLLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7V0FDdkM7O0FBRUQsaUJBQUssWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUN2QztBQUNELGdDQUF3QixFQUFFLGlDQUFNO0FBQzlCLDhCQUFJLEtBQUssQ0FBQywwREFBMEQsR0FDMUQsK0JBQStCLENBQUMsQ0FBQztTQUM1QztBQUNELGdDQUF3QixFQUFFLCtCQUFDLElBQUksRUFBSztBQUNsQyxpQkFBSyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDeEM7T0FDRixDQUFDO0tBQ0g7OztXQUd1QixpQ0FBQyxvQkFBb0IsRUFBRTtBQUM3QyxVQUFJLENBQUMsb0JBQW9CLEdBQUcsb0JBQW9CLENBQUM7QUFDakQsVUFBSSxDQUFDLGNBQWMsQ0FBQyx1QkFBdUIsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0tBQ25FOzs7U0F0TGtCLGVBQWU7R0FBUyxvQkFBTyxZQUFZOztxQkFBM0MsZUFBZSIsImZpbGUiOiJsaWIvd2Via2l0LXJwYy1jbGllbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IFJFTU9URV9ERUJVR0dFUl9QT1JULCBSUENfUkVTUE9OU0VfVElNRU9VVF9NUyB9IGZyb20gJy4vcmVtb3RlLWRlYnVnZ2VyJztcbmltcG9ydCBnZXRSZW1vdGVDb21tYW5kIGZyb20gJy4vcmVtb3RlLW1lc3NhZ2VzJztcbmltcG9ydCBXZWJTb2NrZXQgZnJvbSAnd3MnO1xuaW1wb3J0IFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBldmVudHMgZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IHNpbXBsZVN0cmluZ2lmeSB9IGZyb20gJy4vaGVscGVycyc7XG5cblxuY29uc3QgREFUQV9MT0dfTEVOR1RIID0ge2xlbmd0aDogMjAwfTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgV2ViS2l0UnBjQ2xpZW50IGV4dGVuZHMgZXZlbnRzLkV2ZW50RW1pdHRlciB7XG4gIGNvbnN0cnVjdG9yIChob3N0LCBwb3J0ID0gUkVNT1RFX0RFQlVHR0VSX1BPUlQsIHJlc3BvbnNlVGltZW91dCA9IFJQQ19SRVNQT05TRV9USU1FT1VUX01TKSB7XG4gICAgc3VwZXIoKTtcblxuICAgIHRoaXMuaG9zdCA9IGhvc3Q7XG4gICAgdGhpcy5wb3J0ID0gcG9ydDtcblxuICAgIHRoaXMucmVzcG9uc2VUaW1lb3V0ID0gcmVzcG9uc2VUaW1lb3V0O1xuXG4gICAgdGhpcy5jdXJNc2dJZCA9IDA7XG5cbiAgICB0aGlzLmRhdGFIYW5kbGVycyA9IHt9O1xuICAgIHRoaXMuZGF0YU1ldGhvZHMgPSB7fTtcbiAgICB0aGlzLmVycm9ySGFuZGxlcnMgPSB7fTtcblxuICAgIHRoaXMuc2V0SGFuZGxlcnMoKTtcbiAgfVxuXG4gIGFzeW5jIGNvbm5lY3QgKHBhZ2VJZCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAvLyB3ZSB3aWxsIG9ubHkgcmVzb2x2ZSB0aGlzIGNhbGwgd2hlbiB0aGUgc29ja2V0IGlzIG9wZW5cbiAgICAgIC8vIFdlYktpdCB1cmxcbiAgICAgIGxldCB1cmwgPSBgd3M6Ly8ke3RoaXMuaG9zdH06JHt0aGlzLnBvcnR9L2RldnRvb2xzL3BhZ2UvJHtwYWdlSWR9YDtcbiAgICAgIHRoaXMucGFnZUlkS2V5ID0gcGFnZUlkO1xuXG4gICAgICAvLyBjcmVhdGUgYW5kIHNldCB1cCBzb2NrZXQgd2l0aCBhcHByb3ByaWF0ZSBldmVudCBoYW5kbGVyc1xuICAgICAgdGhpcy5zb2NrZXQgPSBuZXcgV2ViU29ja2V0KHVybCk7XG4gICAgICB0aGlzLnNvY2tldC5vbignb3BlbicsICgpID0+IHtcbiAgICAgICAgbG9nLmRlYnVnKGBXZWJLaXQgZGVidWdnZXIgd2ViIHNvY2tldCBjb25uZWN0ZWQgdG8gdXJsOiAke3VybH1gKTtcbiAgICAgICAgdGhpcy5jb25uZWN0ZWQgPSB0cnVlO1xuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdjbG9zZScsICgpID0+IHtcbiAgICAgICAgbG9nLmRlYnVnKCdXZWJLaXQgcmVtb3RlIGRlYnVnZ2VyIHNvY2tldCBkaXNjb25uZWN0ZWQnKTtcbiAgICAgICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5zb2NrZXQub24oJ2Vycm9yJywgKGV4Y2VwdGlvbikgPT4ge1xuICAgICAgICBpZiAodGhpcy5jb25uZWN0ZWQpIHtcbiAgICAgICAgICBsb2cuZGVidWcoYFdlYktpdCBkZWJ1Z2dlciB3ZWIgc29ja2V0IGVycm9yOiAke2V4Y2VwdGlvbi5tZXNzYWdlfWApO1xuICAgICAgICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICByZWplY3QoZXhjZXB0aW9uKTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5zb2NrZXQub24oJ21lc3NhZ2UnLCB0aGlzLnJlY2VpdmUuYmluZCh0aGlzKSk7XG4gICAgfSk7XG4gIH1cblxuICBkaXNjb25uZWN0ICgpIHtcbiAgICBsb2cuZGVidWcoJ0Rpc2Nvbm5lY3RpbmcgZnJvbSBXZWJLaXQgcmVtb3RlIGRlYnVnZ2VyJyk7XG4gICAgaWYgKHRoaXMuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgdGhpcy5zb2NrZXQuY2xvc2UoMTAwMSk7XG4gICAgfVxuICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2U7XG4gIH1cblxuICBpc0Nvbm5lY3RlZCAoKSB7XG4gICAgcmV0dXJuICh0aGlzLnNvY2tldCAhPT0gbnVsbCAmJiB0aGlzLmNvbm5lY3RlZCk7XG4gIH1cblxuXG4gIGFzeW5jIHNlbmQgKGNvbW1hbmQsIG9wdHMgPSB7fSkge1xuICAgIGxldCBkYXRhID0gZ2V0UmVtb3RlQ29tbWFuZChjb21tYW5kLCBfLmRlZmF1bHRzKHtjb25uSWQ6IHRoaXMuY29ubklkLCBzZW5kZXJJZDogdGhpcy5zZW5kZXJJZH0sIG9wdHMpKTtcblxuICAgIGxvZy5kZWJ1ZyhgU2VuZGluZyBXZWJLaXQgZGF0YTogJHtfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KGRhdGEpLCBEQVRBX0xPR19MRU5HVEgpfWApOyAvLyBqc2hpbnQgaWdub3JlOmxpbmVcbiAgICBsb2cuZGVidWcoYFdlYmtpdCByZXNwb25zZSB0aW1lb3V0OiAke3RoaXMucmVzcG9uc2VUaW1lb3V0fWApO1xuXG4gICAgdGhpcy5jdXJNc2dJZCsrO1xuICAgIGRhdGEuaWQgPSB0aGlzLmN1ck1zZ0lkO1xuXG4gICAgbGV0IGlkID0gdGhpcy5jdXJNc2dJZC50b1N0cmluZygpO1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAvLyBvbmx5IHJlc29sdmUgdGhlIHNlbmQgY29tbWFuZCB3aGVuIFdlYktpdCByZXR1cm5zIGEgcmVzcG9uc2VcbiAgICAgIC8vIHN0b3JlIHRoZSBoYW5kbGVyIGFuZCB0aGUgZGF0YSBzZW50XG4gICAgICB0aGlzLmRhdGFIYW5kbGVyc1tpZF0gPSByZXNvbHZlO1xuICAgICAgdGhpcy5kYXRhTWV0aG9kc1tpZF0gPSBkYXRhLm1ldGhvZDtcbiAgICAgIHRoaXMuZXJyb3JIYW5kbGVyc1tpZF0gPSByZWplY3Q7XG5cbiAgICAgIC8vIHNlbmQgdGhlIGRhdGFcbiAgICAgIGRhdGEgPSBKU09OLnN0cmluZ2lmeShkYXRhKTtcbiAgICAgIHRoaXMuc29ja2V0LnNlbmQoZGF0YSwgZnVuY3Rpb24gKGVycm9yKSB7XG4gICAgICAgIGlmICghXy5pc1VuZGVmaW5lZChlcnJvcikgJiYgIV8uaXNOdWxsKGVycm9yKSkge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgV2ViS2l0IHNvY2tldCBlcnJvciBvY2N1cnJlZDogJHtlcnJvcn1gKTtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKGVycm9yKSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pLmZpbmFsbHkoKHJlcykgPT4ge1xuICAgICAgLy8gbm8gbmVlZCB0byBob2xkIG9udG8gYW55dGhpbmdcbiAgICAgIGRlbGV0ZSB0aGlzLmRhdGFIYW5kbGVyc1tpZF07XG4gICAgICBkZWxldGUgdGhpcy5kYXRhTWV0aG9kc1tpZF07XG4gICAgICBkZWxldGUgdGhpcy5lcnJvckhhbmRsZXJzW2lkXTtcblxuICAgICAgLy8gYW5kIHBhc3MgYWxvbmcgdGhlIHJlc3VsdFxuICAgICAgcmV0dXJuIHJlcztcbiAgICB9KS50aW1lb3V0KHRoaXMucmVzcG9uc2VUaW1lb3V0KTtcbiAgfVxuXG5cbiAgcmVjZWl2ZSAoZGF0YSkge1xuICAgIGxvZy5kZWJ1ZyhgUmVjZWl2aW5nIFdlYktpdCBkYXRhOiAnJHtfLnRydW5jYXRlKGRhdGEsIERBVEFfTE9HX0xFTkdUSCl9J2ApO1xuXG4gICAgZGF0YSA9IEpTT04ucGFyc2UoZGF0YSk7XG4gICAgaWYgKCFkYXRhKSB7XG4gICAgICBsb2cud2FybihgTm8gcGFyc2VhYmxlIGRhdGEgZm91bmRgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyB3ZSBjYW4gZ2V0IGFuIGVycm9yLCBvciB3ZSBjYW4gZ2V0IGEgcmVzcG9uc2UgdGhhdCBpcyBhbiBlcnJvclxuICAgIGlmIChkYXRhLndhc1Rocm93biB8fCAoZGF0YS5yZXN1bHQgJiYgZGF0YS5yZXN1bHQud2FzVGhyb3duKSkge1xuICAgICAgbGV0IG1lc3NhZ2U7XG4gICAgICBpZiAoZGF0YS53YXNUaHJvd24pIHtcbiAgICAgICAgbWVzc2FnZSA9IGRhdGEucmVzdWx0LnZhbHVlIHx8IGRhdGEucmVzdWx0LmRlc2NyaXB0aW9uO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbWVzc2FnZSA9IGRhdGEucmVzdWx0LnJlc3VsdC52YWx1ZSB8fCBkYXRhLnJlc3VsdC5yZXN1bHQuZGVzY3JpcHRpb247XG4gICAgICB9XG4gICAgICBsZXQgZXJyb3IgPSBuZXcgRXJyb3IobWVzc2FnZSk7XG4gICAgICBpZiAoZGF0YS5pZCAmJiB0aGlzLmVycm9ySGFuZGxlcnNbZGF0YS5pZF0pIHtcbiAgICAgICAgdGhpcy5lcnJvckhhbmRsZXJzW2RhdGEuaWRdKGVycm9yKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gdGhpcyBzaG91bGQgbmV2ZXIgaGFwcGVuLCBidXQgbG9nIGF0IGxlYXN0XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGVycm9yKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyB3aGVuIHNlbmRpbmcgd2Ugc2V0IGEgZGF0YSBtZXRob2QgYW5kIGFzc29jaWF0ZWQgY2FsbGJhY2suXG4gICAgLy8gZ2V0IHRoYXQsIG9yIHRoZSBnZW5lcmljIChhdXRvbWF0aWNhbGx5IHNlbnQsIG5vdCBhc3NvY2lhdGVkXG4gICAgLy8gd2l0aCBhIHBhcnRpY3VsYXIgcmVxdWVzdCkgbWV0aG9kXG4gICAgbGV0IGhhbmRsZXJGb3I7XG4gICAgaWYgKGRhdGEuaWQgJiYgdGhpcy5kYXRhTWV0aG9kc1tkYXRhLmlkXSkge1xuICAgICAgbG9nLmRlYnVnKGBGb3VuZCBoYW5kbGVyIGZvciBtZXNzYWdlICcke2RhdGEuaWR9J2ApO1xuICAgICAgaGFuZGxlckZvciA9IHRoaXMuZGF0YU1ldGhvZHNbZGF0YS5pZF07XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZyhgRGlkIG5vdCBmaW5kIGhhbmRsZXIgZm9yIG1lc3NhZ2VgKTtcbiAgICAgIGhhbmRsZXJGb3IgPSBkYXRhLm1ldGhvZDtcbiAgICB9XG5cbiAgICBpZiAoIWhhbmRsZXJGb3IpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgYW4gaW52YWxpZCBtZXRob2Q6ICcke2RhdGEubWV0aG9kfSdgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKF8uaGFzKHRoaXMuaGFuZGxlcnMsIGhhbmRsZXJGb3IpKSB7XG4gICAgICB0aGlzLmhhbmRsZXJzW2hhbmRsZXJGb3JdKGRhdGEpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuZGVidWcoYFdlYktpdCBkZWJ1Z2dlciBnb3QgYSBtZXNzYWdlIGZvciAnJHtoYW5kbGVyRm9yfScgYCArXG4gICAgICAgICAgICAgICAgYGFuZCBoYXZlIG5vIGhhbmRsZXIsIGRvaW5nIG5vdGhpbmcuYCk7XG4gICAgfVxuICB9XG5cbiAgc2V0SGFuZGxlcnMgKCkge1xuICAgIHRoaXMuaGFuZGxlcnMgPSB7XG4gICAgICAnUnVudGltZS5ldmFsdWF0ZSc6IChkYXRhKSA9PiB7XG4gICAgICAgIGxldCBtc2dJZCA9IGRhdGEuaWQ7XG4gICAgICAgIGlmIChkYXRhLmVycm9yKSB7XG4gICAgICAgICAgdGhpcy5lcnJvckhhbmRsZXJzW21zZ0lkXShkYXRhLmVycm9yKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZGF0YUhhbmRsZXJzW21zZ0lkXShkYXRhLnJlc3VsdCk7XG4gICAgICB9LFxuICAgICAgJ1BhZ2UubmF2aWdhdGUnOiAoZGF0YSkgPT4ge1xuICAgICAgICBsb2cuZGVidWcoYFJlY2VpdmVkIHBhZ2UgbmF2aWdhdGVkIG1lc3NhZ2U6ICR7c2ltcGxlU3RyaW5naWZ5KGRhdGEpfWApO1xuICAgICAgICBsZXQgbXNnSWQgPSBkYXRhLmlkO1xuICAgICAgICBpZiAoZGF0YS5lcnJvcikge1xuICAgICAgICAgIHRoaXMuZXJyb3JIYW5kbGVyc1ttc2dJZF0oZGF0YS5lcnJvcik7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmRhdGFIYW5kbGVyc1ttc2dJZF0oZGF0YS5yZXN1bHQpO1xuICAgICAgfSxcbiAgICAgICdQcm9maWxlci5yZXNldFByb2ZpbGVzJzogKCkgPT4ge1xuICAgICAgICBsb2cuZGVidWcoJ0RldmljZSBpcyB0ZWxsaW5nIHVzIHRvIHJlc2V0IHByb2ZpbGVzLiBTaG91bGQgcHJvYmFibHkgJyArXG4gICAgICAgICAgICAgICAgICAnZG8gc29tZSBraW5kIG9mIGNhbGxiYWNrIGhlcmUnKTtcbiAgICAgIH0sXG4gICAgICAnVGltZWxpbmUuZXZlbnRSZWNvcmRlZCc6IChkYXRhKSA9PiB7XG4gICAgICAgIHRoaXMudGltZWxpbmVFdmVudEhhbmRsZXIoZGF0YS5yZXN1bHQpO1xuICAgICAgfVxuICAgIH07XG4gIH1cblxuXG4gIHNldFRpbWVsaW5lRXZlbnRIYW5kbGVyICh0aW1lbGluZUV2ZW50SGFuZGxlcikge1xuICAgIHRoaXMudGltZWxpbmVFdmVudEhhbmRsZXIgPSB0aW1lbGluZUV2ZW50SGFuZGxlcjtcbiAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNldFRpbWVsaW5lRXZlbnRIYW5kbGVyKHRpbWVsaW5lRXZlbnRIYW5kbGVyKTtcbiAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
